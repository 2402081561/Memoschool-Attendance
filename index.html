<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Genius Mind Academy Attendance</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    
    <!-- jsPDF for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    
    <!-- Chart.js for Dashboard -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --primary: #e67e22;
            --primary-dark: #d35400;
            --secondary: #3498db;
            --success: #27ae60;
            --warning: #f39c12;
            --danger: #e74c3c;
            --info: #17a2b8;
            --light: #f8f9fa;
            --dark: #2c3e50;
            --gray: #6c757d;
            --border: #e9ecef;
            --shadow: rgba(0, 0, 0, 0.1);
            --card-shadow: 0 8px 25px rgba(0,0,0,0.08);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            transition: background-color 0.3s, border-color 0.3s;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 25px 50px rgba(0,0,0,0.15);
            overflow: hidden;
            backdrop-filter: blur(10px);
        }
        
        .header {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }
        
        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" opacity="0.1"><circle cx="50" cy="50" r="2" fill="white"/></svg>') repeat;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            color: white;
            font-weight: 700;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        
        .header p {
            font-size: 1.2em;
            opacity: 0.9;
            font-weight: 300;
        }
        
        .school-logo {
            position: absolute;
            top: 20px;
            left: 30px;
            width: 80px;
            height: 80px;
            background: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.5em;
            box-shadow: 0 8px 25px rgba(0,0,0,0.2);
            overflow: hidden;
            z-index: 2;
            transition: transform 0.3s ease;
        }
        
        .school-logo:hover {
            transform: scale(1.05);
        }
        
        .school-logo img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .nav {
            background: var(--primary-dark);
            padding: 15px;
            display: flex;
            justify-content: center;
            gap: 8px;
            flex-wrap: wrap;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .nav button {
            background: rgba(255,255,255,0.15);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 50px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .nav button:hover {
            background: rgba(255,255,255,0.25);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        .nav button.active {
            background: rgba(255,255,255,0.3);
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.2);
        }
        
        .nav button:active {
            transform: translateY(0);
        }
        
        .content {
            padding: 30px;
            min-height: 500px;
            background: #f8f9fa;
        }
        
        .section {
            display: none;
            animation: fadeIn 0.5s ease;
        }
        
        .section.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .form-group {
            margin-bottom: 25px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--dark);
            font-size: 0.95em;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .form-input {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid var(--border);
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: white;
            font-family: inherit;
        }
        
        .form-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(230, 126, 34, 0.1);
        }
        
        .form-input:hover {
            border-color: #ced4da;
        }
        
        .btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 14px 28px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .btn:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.15);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }
        
        .btn-secondary {
            background: var(--secondary);
        }
        
        .btn-secondary:hover {
            background: #2980b9;
        }
        
        .btn-warning {
            background: var(--warning);
        }
        
        .btn-warning:hover {
            background: #e67e22;
        }
        
        .btn-info {
            background: var(--info);
        }
        
        .btn-info:hover {
            background: #138496;
        }
        
        .btn-success {
            background: var(--success);
        }
        
        .btn-success:hover {
            background: #219a52;
        }
        
        .btn-danger {
            background: var(--danger);
        }
        
        .btn-danger:hover {
            background: #c0392b;
        }
        
        /* Dashboard Enhancements */
        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid var(--border);
        }
        
        .dashboard-header h2 {
            color: var(--dark);
            font-size: 1.8em;
        }
        
        .quick-stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .quick-stat-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: var(--card-shadow);
            border-left: 5px solid var(--primary);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .quick-stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(0,0,0,0.12);
        }
        
        .quick-stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary), var(--primary-dark));
        }
        
        .stat-icon {
            font-size: 2.5em;
            margin-bottom: 15px;
            color: var(--primary);
            opacity: 0.9;
        }
        
        .stat-value {
            font-size: 2.2em;
            font-weight: 700;
            color: var(--dark);
            margin: 10px 0;
            line-height: 1;
        }
        
        .stat-label {
            color: var(--gray);
            font-size: 0.9em;
            font-weight: 500;
        }
        
        .stat-trend {
            display: flex;
            align-items: center;
            gap: 5px;
            margin-top: 10px;
            font-size: 0.85em;
            font-weight: 500;
        }
        
        .trend-up {
            color: var(--success);
        }
        
        .trend-down {
            color: var(--danger);
        }
        
        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-top: 30px;
        }
        
        @media (max-width: 992px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
        }
        
        .dashboard-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: var(--card-shadow);
            transition: all 0.3s ease;
        }
        
        .dashboard-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 25px rgba(0,0,0,0.12);
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border);
        }
        
        .card-header h3 {
            color: var(--dark);
            font-size: 1.3em;
            font-weight: 600;
        }
        
        .card-actions {
            display: flex;
            gap: 10px;
        }
        
        .attendance-chart-container {
            height: 300px;
            margin-top: 15px;
            position: relative;
        }
        
        .recent-activity {
            max-height: 300px;
            overflow-y: auto;
        }
        
        .activity-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            background: #f8f9fa;
            transition: background 0.2s;
        }
        
        .activity-item:hover {
            background: #e9ecef;
        }
        
        .activity-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2em;
        }
        
        .activity-details {
            flex: 1;
        }
        
        .activity-title {
            font-weight: 600;
            color: var(--dark);
            margin-bottom: 3px;
        }
        
        .activity-time {
            font-size: 0.85em;
            color: var(--gray);
        }
        
        .time-slot-distribution {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .time-slot-bar {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .time-slot-label {
            width: 150px;
            font-weight: 500;
            color: var(--dark);
        }
        
        .time-slot-progress {
            flex: 1;
            height: 24px;
            background: #e9ecef;
            border-radius: 12px;
            overflow: hidden;
            position: relative;
        }
        
        .time-slot-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--primary-dark));
            border-radius: 12px;
            transition: width 1s ease;
        }
        
        .time-slot-count {
            width: 50px;
            text-align: right;
            font-weight: 600;
            color: var(--dark);
        }
        
        /* Enhanced Tables */
        .table-container {
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: var(--card-shadow);
            margin-top: 20px;
        }
        
        .table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .table thead {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
        }
        
        .table th {
            padding: 18px 16px;
            text-align: left;
            color: white;
            font-weight: 600;
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border: none;
        }
        
        .table tbody tr {
            border-bottom: 1px solid var(--border);
            transition: background 0.2s;
        }
        
        .table tbody tr:hover {
            background: rgba(230, 126, 34, 0.05);
        }
        
        .table tbody tr:last-child {
            border-bottom: none;
        }
        
        .table td {
            padding: 16px;
            color: var(--dark);
        }
        
        /* Enhanced Student Cards */
        .student-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 20px;
            margin-top: 25px;
        }
        
        .student-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: var(--card-shadow);
            border-left: 4px solid var(--primary);
            transition: all 0.3s ease;
            position: relative;
            cursor: pointer;
            border: 1px solid var(--border);
        }
        
        .student-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 25px rgba(0,0,0,0.15);
            border-color: var(--primary);
        }
        
        .student-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }
        
        .student-name {
            font-size: 1.2em;
            font-weight: 700;
            color: var(--dark);
            margin: 0;
        }
        
        .student-badge {
            background: var(--primary);
            color: white;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: bold;
        }
        
        .student-meta {
            color: var(--gray);
            font-size: 0.9em;
            margin: 5px 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .student-progress {
            margin: 15px 0;
        }
        
        .progress-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 0.9em;
            font-weight: 500;
        }
        
        .progress-bar {
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--success), #2ecc71);
            transition: width 0.5s ease;
            border-radius: 4px;
        }
        
        .progress-fill.warning {
            background: linear-gradient(90deg, var(--warning), #f1c40f);
        }
        
        .progress-fill.danger {
            background: linear-gradient(90deg, var(--danger), #e74c3c);
        }
        
        .student-actions {
            display: flex;
            gap: 8px;
            margin-top: 15px;
        }
        
        .student-action-btn {
            flex: 1;
            padding: 8px 12px;
            font-size: 12px;
            border-radius: 8px;
        }
        
        /* Enhanced Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 1000;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            backdrop-filter: blur(5px);
        }
        
        .modal-content {
            background-color: white;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 25px 50px rgba(0,0,0,0.15);
            max-width: 800px;
            width: 90%;
            max-height: 85vh;
            overflow-y: auto;
            animation: modalSlideIn 0.3s ease;
        }
        
        @keyframes modalSlideIn {
            from { opacity: 0; transform: translateY(-30px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--border);
        }
        
        .modal-title {
            font-size: 1.5em;
            font-weight: 700;
            color: var(--dark);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .modal-close {
            background: transparent;
            border: none;
            font-size: 1.5em;
            cursor: pointer;
            color: var(--gray);
            transition: color 0.2s;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .modal-close:hover {
            color: var(--danger);
            background: rgba(231, 76, 60, 0.1);
        }
        
        /* Enhanced Calendar */
        .calendar-container {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: var(--card-shadow);
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 8px;
            margin-bottom: 20px;
        }
        
        .calendar-day-header {
            text-align: center;
            font-weight: 600;
            color: var(--gray);
            padding: 12px;
            font-size: 0.9em;
        }
        
        .calendar-day {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 2px solid transparent;
            font-weight: 500;
            font-size: 0.9em;
        }
        
        .calendar-day:hover {
            background-color: rgba(230, 126, 34, 0.1);
            transform: scale(1.05);
        }
        
        .calendar-day.selected {
            background-color: var(--primary);
            color: white;
            font-weight: bold;
            box-shadow: 0 4px 8px rgba(230, 126, 34, 0.3);
        }
        
        .calendar-day.today {
            border-color: var(--primary);
            color: var(--primary);
            background-color: rgba(230, 126, 34, 0.05);
        }
        
        /* Enhanced Toast Notifications */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .toast {
            background: white;
            padding: 18px 20px;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
            border-left: 4px solid var(--success);
            animation: toastSlideIn 0.3s ease;
            display: flex;
            align-items: center;
            gap: 12px;
            max-width: 350px;
            min-width: 300px;
        }
        
        @keyframes toastSlideIn {
            from { opacity: 0; transform: translateX(100%); }
            to { opacity: 1; transform: translateX(0); }
        }
        
        .toast.error {
            border-left-color: var(--danger);
        }
        
        .toast.warning {
            border-left-color: var(--warning);
        }
        
        .toast.info {
            border-left-color: var(--info);
        }
        
        .toast-icon {
            font-size: 1.5em;
        }
        
        .toast-content {
            flex: 1;
        }
        
        .toast-title {
            font-weight: 600;
            color: var(--dark);
            margin-bottom: 3px;
        }
        
        .toast-message {
            color: var(--gray);
            font-size: 0.95em;
        }
        
        .toast-close {
            background: transparent;
            border: none;
            color: var(--gray);
            cursor: pointer;
            font-size: 1.2em;
            transition: color 0.2s;
        }
        
        .toast-close:hover {
            color: var(--dark);
        }
        
        /* Loading States */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255,255,255,0.9);
            z-index: 9999;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 15px;
            backdrop-filter: blur(5px);
        }
        
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid var(--border);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        .loading-text {
            color: var(--dark);
            font-weight: 500;
        }
        
        /* Search Bar Enhancement */
        .search-container {
            position: relative;
            max-width: 400px;
            margin-bottom: 30px;
        }
        
        .search-input {
            border-radius: 25px;
            padding: 14px 20px 14px 45px;
            font-size: 14px;
            border: 2px solid var(--border);
            width: 100%;
            transition: all 0.3s;
        }
        
        .search-input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(230, 126, 34, 0.1);
        }
        
        .search-icon {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--gray);
        }
        
        /* Status Indicators */
        .status-indicator {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 500;
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }
        
        .status-active {
            background: rgba(39, 174, 96, 0.1);
            color: var(--success);
        }
        
        .status-active .status-dot {
            background: var(--success);
        }
        
        .status-inactive {
            background: rgba(231, 76, 60, 0.1);
            color: var(--danger);
        }
        
        .status-inactive .status-dot {
            background: var(--danger);
        }
        
        /* Responsive Design */
        @media (max-width: 768px) {
            .nav {
                flex-direction: column;
                align-items: stretch;
                gap: 10px;
            }
            
            .nav button {
                width: 100%;
                max-width: none;
                justify-content: center;
            }
            
            .header h1 {
                font-size: 1.8em;
                margin-top: 20px;
            }
            
            .school-logo {
                position: relative;
                top: 0;
                left: 0;
                margin: 0 auto 15px;
                width: 70px;
                height: 70px;
            }
            
            .student-grid {
                grid-template-columns: 1fr;
            }
            
            .dashboard-grid {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .quick-stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .modal-content {
                padding: 20px;
            }
        }
        
        @media (max-width: 480px) {
            .quick-stats-grid {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 1.5em;
            }
            
            .header p {
                font-size: 1em;
            }
            
            .content {
                padding: 20px;
            }
            
            .btn {
                padding: 12px 20px;
                font-size: 14px;
            }
        }
        
        /* Scrollbar Styling */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--primary);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: var(--primary-dark);
        }
        
        /* Floating Action Button */
        .fab {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            border: none;
            box-shadow: 0 8px 25px rgba(230, 126, 34, 0.3);
            cursor: pointer;
            z-index: 99;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5em;
            transition: all 0.3s ease;
        }
        
        .fab:hover {
            transform: scale(1.1) rotate(90deg);
            box-shadow: 0 12px 30px rgba(230, 126, 34, 0.4);
        }
        
        /* Card hover effects */
        .hover-lift {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .hover-lift:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 25px rgba(0,0,0,0.12);
        }
        
        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--gray);
        }
        
        .empty-state-icon {
            font-size: 4em;
            margin-bottom: 20px;
            opacity: 0.3;
        }
        
        .empty-state-title {
            font-size: 1.5em;
            margin-bottom: 10px;
            color: var(--dark);
        }
        
        /* Badge Styles */
        .badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .badge-primary {
            background: rgba(230, 126, 34, 0.1);
            color: var(--primary);
        }
        
        .badge-success {
            background: rgba(39, 174, 96, 0.1);
            color: var(--success);
        }
        
        .badge-warning {
            background: rgba(243, 156, 18, 0.1);
            color: var(--warning);
        }
        
        .badge-danger {
            background: rgba(231, 76, 60, 0.1);
            color: var(--danger);
        }
        
        /* Tooltips */
        [data-tooltip] {
            position: relative;
        }
        
        [data-tooltip]:before {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: var(--dark);
            color: white;
            padding: 6px 10px;
            border-radius: 6px;
            font-size: 0.85em;
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.2s;
            z-index: 10;
            margin-bottom: 5px;
        }
        
        [data-tooltip]:hover:before {
            opacity: 1;
            visibility: visible;
        }
        
        /* Animation for numbers */
        @keyframes countUp {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .count-up {
            animation: countUp 0.5s ease forwards;
        }
    </style>
</head>
<body>
    <!-- Toast Container -->
    <div id="toastContainer" class="toast-container"></div>
    
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay" style="display: none;">
        <div class="loading-spinner"></div>
        <div class="loading-text" id="loadingText">Loading...</div>
    </div>
    
    <!-- Floating Action Button -->
    <button class="fab" id="fabButton" onclick="scrollToTop()" data-tooltip="Scroll to top">
        <i class="fas fa-arrow-up"></i>
    </button>
    
    <div class="container">
        <div class="header">
            <div class="school-logo" id="schoolLogo">
                <img src="./gmlogo.png" alt="Genius Mind Academy" onerror="this.style.display='none'; this.parentNode.innerHTML='<i class=\"fas fa-graduation-cap\"></i>'">
            </div>
            <h1>Genius Mind Academy</h1>
            <p>Intelligent Attendance Management System</p>
        </div>
        
        <!-- Firebase Login Section -->
        <div id="loginSection">
            <div class="login-panel" style="background: white; border-radius: 15px; padding: 40px; margin: 30px auto; text-align: center; box-shadow: var(--card-shadow); max-width: 500px; border: 1px solid var(--border);">
                <h2 style="margin-bottom: 20px; color: var(--dark);"><i class="fas fa-lock"></i> Login to Dashboard</h2>
                <p style="margin-bottom: 25px; color: var(--gray);">Sign in to access your synchronized attendance data</p>
                
                <div class="form-group">
                    <input type="email" id="email" placeholder="Email address" class="form-input" style="margin-bottom: 15px;">
                    <input type="password" id="password" placeholder="Password" class="form-input">
                </div>
                
                <div style="display: flex; gap: 10px; justify-content: center; margin-bottom: 20px;">
                    <button class="btn" onclick="login()" style="flex: 1;">
                        <i class="fas fa-sign-in-alt"></i> Login
                    </button>
                    <button class="btn btn-secondary" onclick="signup()" style="flex: 1;">
                        <i class="fas fa-user-plus"></i> Sign Up
                    </button>
                </div>
                
                <p style="margin-top: 15px; font-size: 14px; color: #666;">
                    Don't have an account? Click Sign Up to create one
                </p>
                
                <!-- Test Mode Button -->
                <div style="margin-top: 25px; padding: 20px; background: #f8f9fa; border-radius: 10px; border: 1px solid var(--border);">
                    <p style="margin-bottom: 10px; color: var(--gray); font-size: 14px;"><i class="fas fa-exclamation-triangle"></i> Having login issues? Use test mode:</p>
                    <button onclick="skipLoginForTesting()" class="btn btn-info" style="width: 100%;">
                        <i class="fas fa-flask"></i> Test Mode (Skip Login)
                    </button>
                </div>
            </div>
        </div>

        <div id="appSection" style="display: none;">
            <div class="user-info" style="background: linear-gradient(135deg, var(--success), #20c997); color: white; border-radius: 10px; padding: 15px 20px; margin: 15px 30px; text-align: center; box-shadow: 0 4px 6px rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center;">
                <span style="display: flex; align-items: center; gap: 10px;">
                    <i class="fas fa-user-circle"></i>
                    Welcome, <strong id="userEmail"></strong>
                </span>
                <button class="btn btn-warning" onclick="logout()" style="padding: 8px 16px; font-size: 14px;">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
            </div>
            
            <div class="nav">
                <button onclick="showSection('dashboard')" data-section="dashboard">
                    <i class="fas fa-chart-line"></i> Dashboard
                </button>
                <button onclick="showSection('students')" data-section="students">
                    <i class="fas fa-users"></i> Students
                </button>
                <button onclick="showSection('attendance')" data-section="attendance">
                    <i class="fas fa-clipboard-check"></i> Attendance
                </button>
                <button onclick="showSection('records')" data-section="records">
                    <i class="fas fa-history"></i> Records
                </button>
                <button onclick="showSection('timeslots')" data-section="timeslots">
                    <i class="fas fa-clock"></i> Time Slots
                </button>
                <button onclick="showSection('timeSlotsManagement')" data-section="timeSlotsManagement">
                    <i class="fas fa-plus-circle"></i> Manage Slots
                </button>
                <button onclick="showSection('tools')" data-section="tools">
                    <i class="fas fa-tools"></i> Tools
                </button>
                <button onclick="showSection('exports')" data-section="exports">
                    <i class="fas fa-file-export"></i> Export
                </button>
            </div>
            
            <!-- Sync Status Display -->
            <div class="sync-status" id="syncStatus" style="background: #e8f4fd; border-radius: 10px; padding: 15px; margin: 15px 30px; text-align: center; font-size: 14px; font-weight: 500; border-left: 4px solid var(--info); box-shadow: 0 2px 5px rgba(0,0,0,0.05);">
                <i class="fas fa-sync-alt"></i> Connecting to database...
            </div>
            
            <div class="content">
                <!-- Dashboard -->
                <div id="dashboard" class="section active">
                    <div class="dashboard-header">
                        <h2><i class="fas fa-tachometer-alt"></i> Dashboard Overview</h2>
                        <div class="card-actions">
                            <button class="btn btn-secondary" onclick="refreshDashboard()" data-tooltip="Refresh Dashboard">
                                <i class="fas fa-sync-alt"></i> Refresh
                            </button>
                            <button class="btn btn-info" onclick="showSection('reports')" data-tooltip="View Reports">
                                <i class="fas fa-chart-bar"></i> Reports
                            </button>
                        </div>
                    </div>
                    
                    <!-- Quick Stats -->
                    <div class="quick-stats-grid">
                        <div class="quick-stat-card hover-lift">
                            <div class="stat-icon">
                                <i class="fas fa-users"></i>
                            </div>
                            <div class="stat-value" id="totalStudents">0</div>
                            <div class="stat-label">Total Students</div>
                            <div class="stat-trend trend-up">
                                <i class="fas fa-arrow-up"></i>
                                <span>12% this month</span>
                            </div>
                        </div>
                        
                        <div class="quick-stat-card hover-lift">
                            <div class="stat-icon">
                                <i class="fas fa-calendar-check"></i>
                            </div>
                            <div class="stat-value" id="sessionsRecorded">0</div>
                            <div class="stat-label">Sessions Recorded</div>
                            <div class="stat-trend trend-up">
                                <i class="fas fa-arrow-up"></i>
                                <span>Active tracking</span>
                            </div>
                        </div>
                        
                        <div class="quick-stat-card hover-lift">
                            <div class="stat-icon">
                                <i class="fas fa-chart-line"></i>
                            </div>
                            <div class="stat-value" id="avgAttendance">0%</div>
                            <div class="stat-label">Average Attendance</div>
                            <div class="stat-trend trend-up">
                                <i class="fas fa-arrow-up"></i>
                                <span>+5% improvement</span>
                            </div>
                        </div>
                        
                        <div class="quick-stat-card hover-lift">
                            <div class="stat-icon">
                                <i class="fas fa-clock"></i>
                            </div>
                            <div class="stat-value" id="timeSlotsCountDashboard">0</div>
                            <div class="stat-label">Active Time Slots</div>
                            <div class="stat-trend">
                                <i class="fas fa-check-circle"></i>
                                <span>All active</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Dashboard Content Grid -->
                    <div class="dashboard-grid">
                        <!-- Attendance Chart -->
                        <div class="dashboard-card hover-lift">
                            <div class="card-header">
                                <h3><i class="fas fa-chart-bar"></i> Attendance Trends</h3>
                                <select id="chartPeriod" class="form-input" style="width: auto; padding: 8px 12px; font-size: 14px;" onchange="updateAttendanceChart()">
                                    <option value="7">Last 7 Days</option>
                                    <option value="30">Last 30 Days</option>
                                    <option value="90">Last 3 Months</option>
                                </select>
                            </div>
                            <div class="attendance-chart-container">
                                <canvas id="attendanceChart"></canvas>
                            </div>
                        </div>
                        
                        <!-- Recent Activity -->
                        <div class="dashboard-card hover-lift">
                            <div class="card-header">
                                <h3><i class="fas fa-history"></i> Recent Activity</h3>
                                <button class="btn btn-secondary" onclick="showSection('records')" style="padding: 8px 12px; font-size: 14px;">
                                    View All
                                </button>
                            </div>
                            <div class="recent-activity" id="recentActivity">
                                <!-- Activity items will be loaded here -->
                                <div class="activity-item">
                                    <div class="activity-icon">
                                        <i class="fas fa-user-plus"></i>
                                    </div>
                                    <div class="activity-details">
                                        <div class="activity-title">New student registered</div>
                                        <div class="activity-time">2 hours ago</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Time Slot Distribution -->
                        <div class="dashboard-card hover-lift" style="grid-column: span 2;">
                            <div class="card-header">
                                <h3><i class="fas fa-clock"></i> Time Slot Distribution</h3>
                                <span class="badge badge-primary" id="totalStudentsBySlot">0 students</span>
                            </div>
                            <div class="time-slot-distribution" id="timeSlotDistribution">
                                <!-- Time slot bars will be loaded here -->
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Student Management -->
                <div id="students" class="section">
                    <div class="dashboard-header">
                        <h2><i class="fas fa-users"></i> Student Management</h2>
                        <div class="card-actions">
                            <button class="btn btn-success" onclick="showAddStudentForm()">
                                <i class="fas fa-user-plus"></i> Add Student
                            </button>
                            <button class="btn btn-info" onclick="exportToCSV()">
                                <i class="fas fa-file-export"></i> Export
                            </button>
                        </div>
                    </div>
                    
                    <!-- Batch Operations -->
                    <div class="batch-actions" style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; padding: 15px; background: white; border-radius: 12px; box-shadow: var(--card-shadow);">
                        <button class="btn btn-secondary" onclick="selectAllStudents()">
                            <i class="fas fa-check-square"></i> Select All
                        </button>
                        <button class="btn btn-secondary" onclick="deselectAllStudents()">
                            <i class="fas fa-square"></i> Deselect All
                        </button>
                        <button class="btn btn-info" onclick="openDateSelectionForBatch()">
                            <i class="fas fa-calendar-plus"></i> Batch Add Dates
                        </button>
                        <button class="btn btn-danger" onclick="deleteSelectedStudents()">
                            <i class="fas fa-trash"></i> Delete Selected
                        </button>
                        <div style="margin-left: auto; display: flex; align-items: center; gap: 10px;">
                            <span id="selectedCount" style="color: var(--primary); font-weight: bold;">Selected: 0 students</span>
                            <button class="btn btn-warning" onclick="generateBatchPDFReport()">
                                <i class="fas fa-file-pdf"></i> Batch PDF
                            </button>
                        </div>
                    </div>
                    
                    <!-- Search and Filters -->
                    <div style="display: flex; gap: 15px; margin-bottom: 25px; flex-wrap: wrap;">
                        <div class="search-container" style="flex: 1; min-width: 300px;">
                            <i class="fas fa-search search-icon"></i>
                            <input type="text" id="searchStudents" class="search-input" placeholder="Search students by name, age, gender, or time slot...">
                        </div>
                        <select id="studentFilterTimeSlot" class="form-input" style="width: 200px;" onchange="filterStudents()">
                            <option value="all">All Time Slots</option>
                        </select>
                        <select id="studentFilterGender" class="form-input" style="width: 150px;" onchange="filterStudents()">
                            <option value="all">All Genders</option>
                            <option value="Male">Male</option>
                            <option value="Female">Female</option>
                        </select>
                    </div>
                    
                    <!-- Add Student Form (Initially Hidden) -->
                    <div id="addStudentForm" style="display: none; background: white; padding: 25px; border-radius: 15px; box-shadow: var(--card-shadow); margin-bottom: 30px; border-left: 4px solid var(--info);">
                        <div class="card-header" style="border-bottom: none; margin-bottom: 20px; padding-bottom: 0;">
                            <h3><i class="fas fa-user-plus"></i> Add New Student</h3>
                            <button class="btn btn-secondary" onclick="hideAddStudentForm()">
                                <i class="fas fa-times"></i> Cancel
                            </button>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
                            <div class="form-group">
                                <label class="form-label"><i class="fas fa-user"></i> Student Name</label>
                                <input type="text" id="studentName" class="form-input" placeholder="Enter student name">
                            </div>
                            <div class="form-group">
                                <label class="form-label"><i class="fas fa-birthday-cake"></i> Age</label>
                                <input type="number" id="studentAge" class="form-input" placeholder="Enter age" min="5" max="30">
                            </div>
                            <div class="form-group">
                                <label class="form-label"><i class="fas fa-venus-mars"></i> Gender</label>
                                <select id="studentGender" class="form-input">
                                    <option value="">Select Gender</option>
                                    <option value="Male">Male</option>
                                    <option value="Female">Female</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label"><i class="fas fa-clock"></i> Time Slot</label>
                                <select id="studentTimeSlot" class="form-input">
                                    <option value="">Select Time Slot</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label"><i class="fas fa-calendar-day"></i> Enrolled Date</label>
                                <input type="date" id="studentEnrolledDate" class="form-input">
                            </div>
                            <div class="form-group">
                                <label class="form-label"><i class="fas fa-chalkboard-teacher"></i> Total Sessions</label>
                                <input type="number" id="studentTotalSessions" class="form-input" placeholder="48" min="1" max="200" value="48">
                            </div>
                        </div>
                        
                        <button class="btn btn-success" onclick="addStudent()" style="margin-top: 20px;">
                            <i class="fas fa-save"></i> Add Student
                        </button>
                    </div>
                    
                    <!-- Edit Student Form -->
                    <div id="editStudentForm" style="display: none; background: white; padding: 25px; border-radius: 15px; box-shadow: var(--card-shadow); margin-bottom: 30px; border-left: 4px solid var(--info);">
                        <div class="card-header" style="border-bottom: none; margin-bottom: 20px; padding-bottom: 0;">
                            <h3><i class="fas fa-user-edit"></i> Edit Student</h3>
                            <button class="btn btn-secondary" onclick="cancelEdit()">
                                <i class="fas fa-times"></i> Cancel
                            </button>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
                            <div class="form-group">
                                <label class="form-label"><i class="fas fa-user"></i> Student Name</label>
                                <input type="text" id="editStudentName" class="form-input" placeholder="Enter student name">
                            </div>
                            <div class="form-group">
                                <label class="form-label"><i class="fas fa-birthday-cake"></i> Age</label>
                                <input type="number" id="editStudentAge" class="form-input" placeholder="Enter age" min="5" max="30">
                            </div>
                            <div class="form-group">
                                <label class="form-label"><i class="fas fa-venus-mars"></i> Gender</label>
                                <select id="editStudentGender" class="form-input">
                                    <option value="">Select Gender</option>
                                    <option value="Male">Male</option>
                                    <option value="Female">Female</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label"><i class="fas fa-clock"></i> Time Slot</label>
                                <select id="editStudentTimeSlot" class="form-input">
                                    <option value="">Select Time Slot</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label"><i class="fas fa-calendar-day"></i> Enrolled Date</label>
                                <input type="date" id="editStudentEnrolledDate" class="form-input">
                            </div>
                            <div class="form-group">
                                <label class="form-label"><i class="fas fa-chalkboard-teacher"></i> Total Sessions</label>
                                <input type="number" id="editStudentTotalSessions" class="form-input" placeholder="48" min="1" max="200">
                            </div>
                        </div>
                        
                        <input type="hidden" id="editStudentId">
                        <div style="display: flex; gap: 10px; margin-top: 20px;">
                            <button class="btn" onclick="updateStudent()">
                                <i class="fas fa-save"></i> Update Student
                            </button>
                            <button class="btn btn-danger" onclick="deleteStudent(document.getElementById('editStudentId').value)">
                                <i class="fas fa-trash"></i> Delete Student
                            </button>
                        </div>
                    </div>
                    
                    <!-- Student List -->
                    <div class="time-slot-tabs" id="timeSlotTabs" style="display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 25px; padding-bottom: 15px; border-bottom: 1px solid var(--border);"></div>
                    <div id="timeSlotContents"></div>
                </div>
                
                <!-- Record Attendance -->
                <div id="attendance" class="section">
                    <div class="dashboard-header">
                        <h2><i class="fas fa-clipboard-check"></i> Record Attendance</h2>
                        <div class="card-actions">
                            <button class="btn btn-secondary" onclick="clearAttendanceForm()">
                                <i class="fas fa-redo"></i> Clear Form
                            </button>
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 30px;">
                        <!-- Attendance Form -->
                        <div style="background: white; padding: 25px; border-radius: 15px; box-shadow: var(--card-shadow);">
                            <h3 style="margin-bottom: 20px; color: var(--dark);"><i class="fas fa-calendar-plus"></i> Attendance Details</h3>
                            
                            <div class="form-group">
                                <label class="form-label"><i class="fas fa-clock"></i> Select Time Slot</label>
                                <select id="timeSlotSelect" class="form-input" onchange="updateStudentsCheckboxes()">
                                    <option value="">Select Time Slot</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label"><i class="fas fa-calendar-day"></i> Date</label>
                                <input type="date" id="classDate" class="form-input">
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label"><i class="fas fa-book"></i> Session Topic (Optional)</label>
                                <input type="text" id="sessionTopic" class="form-input" placeholder="Enter session topic">
                            </div>
                            
                            <div class="form-group">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                    <label class="form-label"><i class="fas fa-user-check"></i> Select Present Students</label>
                                    <div>
                                        <button type="button" class="btn btn-secondary" onclick="selectAllCheckboxes()" style="padding: 6px 12px; font-size: 12px;">
                                            Select All
                                        </button>
                                        <button type="button" class="btn btn-secondary" onclick="deselectAllCheckboxes()" style="padding: 6px 12px; font-size: 12px; margin-left: 5px;">
                                            Deselect All
                                        </button>
                                    </div>
                                </div>
                                <div class="checkbox-group" id="studentsCheckboxes" style="max-height: 300px; overflow-y: auto; border: 1px solid var(--border); border-radius: 10px; padding: 20px; background: white;">
                                    <p>Please select a time slot to see students</p>
                                </div>
                            </div>
                            
                            <button class="btn btn-success" onclick="recordAttendance()" style="width: 100%;">
                                <i class="fas fa-save"></i> Record Attendance
                            </button>
                        </div>
                        
                        <!-- Quick Stats -->
                        <div style="background: white; padding: 25px; border-radius: 15px; box-shadow: var(--card-shadow);">
                            <h3 style="margin-bottom: 20px; color: var(--dark);"><i class="fas fa-chart-pie"></i> Quick Stats</h3>
                            
                            <div id="attendanceStats" style="text-align: center; padding: 20px;">
                                <div class="empty-state">
                                    <div class="empty-state-icon">
                                        <i class="fas fa-chart-bar"></i>
                                    </div>
                                    <div class="empty-state-title">No Data</div>
                                    <p>Select a time slot to view statistics</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Attendance Records -->
                <div id="records" class="section">
                    <div class="dashboard-header">
                        <h2><i class="fas fa-history"></i> Attendance Records</h2>
                        <div class="card-actions">
                            <button class="btn btn-info" onclick="refreshRecords()">
                                <i class="fas fa-sync-alt"></i> Refresh
                            </button>
                            <button class="btn btn-secondary" onclick="printReport()">
                                <i class="fas fa-print"></i> Print
                            </button>
                        </div>
                    </div>
                    
                    <div class="accuracy-note" style="background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 8px; padding: 15px; margin: 0 0 30px 0; font-size: 14px; color: #856404; border-left: 4px solid var(--warning);">
                        <i class="fas fa-info-circle"></i> <strong>Accuracy Note:</strong> Attendance rates are calculated based on total sessions set for each student (default: 48). You can adjust total sessions for individual students in the student management section.
                    </div>
                    
                    <!-- Filters -->
                    <div style="display: flex; gap: 15px; margin-bottom: 25px; flex-wrap: wrap; padding: 20px; background: white; border-radius: 12px; box-shadow: var(--card-shadow);">
                        <div style="flex: 1; min-width: 200px;">
                            <label class="form-label"><i class="fas fa-filter"></i> Filter by Time Slot</label>
                            <select id="classFilterTimeSlot" class="form-input" onchange="updateClassAttendanceRecords()">
                                <option value="all">All Time Slots</option>
                            </select>
                        </div>
                        
                        <div style="flex: 1; min-width: 200px;">
                            <label class="form-label"><i class="fas fa-calendar"></i> Date Range</label>
                            <div style="display: flex; gap: 10px;">
                                <input type="date" id="dateFrom" class="form-input" style="flex: 1;" onchange="updateClassAttendanceRecords()">
                                <input type="date" id="dateTo" class="form-input" style="flex: 1;" onchange="updateClassAttendanceRecords()">
                            </div>
                        </div>
                        
                        <div style="flex: 1; min-width: 200px;">
                            <label class="form-label"><i class="fas fa-search"></i> Search Topic</label>
                            <input type="text" id="searchTopic" class="form-input" placeholder="Search by topic..." oninput="updateClassAttendanceRecords()">
                        </div>
                    </div>
                    
                    <!-- Class Attendance Records -->
                    <div style="background: white; padding: 25px; border-radius: 15px; box-shadow: var(--card-shadow); margin-bottom: 30px;">
                        <div class="card-header">
                            <h3><i class="fas fa-calendar-check"></i> Class Attendance Records</h3>
                            <span class="badge badge-primary" id="recordCount">0 records</span>
                        </div>
                        
                        <div class="table-container">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Time Slot</th>
                                        <th>Topic</th>
                                        <th>Present Students</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="classAttendanceRecords"></tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- Student Attendance Summary -->
                    <div style="background: white; padding: 25px; border-radius: 15px; box-shadow: var(--card-shadow);">
                        <div class="card-header">
                            <h3><i class="fas fa-user-graduate"></i> Student Attendance Summary</h3>
                            <div style="display: flex; gap: 10px;">
                                <select id="studentFilterTimeSlotSummary" class="form-input" style="width: auto; padding: 8px 12px; font-size: 14px;" onchange="updateStudentAttendanceSummary()">
                                    <option value="all">All Time Slots</option>
                                </select>
                                <select id="studentFilterStudent" class="form-input" style="width: auto; padding: 8px 12px; font-size: 14px;" onchange="updateStudentAttendanceSummary()">
                                    <option value="all">All Students</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="table-container">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>Age</th>
                                        <th>Gender</th>
                                        <th>Time Slot</th>
                                        <th>Attended</th>
                                        <th>Total</th>
                                        <th>Recent</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="studentAttendanceSummary"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Time Slots -->
                <div id="timeslots" class="section">
                    <div class="dashboard-header">
                        <h2><i class="fas fa-clock"></i> Time Slots</h2>
                        <div class="card-actions">
                            <button class="btn btn-success" onclick="showSection('timeSlotsManagement')">
                                <i class="fas fa-plus-circle"></i> Add Time Slot
                            </button>
                        </div>
                    </div>
                    
                    <p style="margin-bottom: 25px; color: var(--gray);">Students grouped by their class time slots.</p>
                    
                    <div id="timeSlotsContainer">
                        <!-- Time slots will be loaded here -->
                    </div>
                </div>

                <!-- Time Slots Management -->
                <div id="timeSlotsManagement" class="section">
                    <div class="dashboard-header">
                        <h2><i class="fas fa-plus-circle"></i> Manage Time Slots</h2>
                        <div class="card-actions">
                            <button class="btn btn-secondary" onclick="showSection('timeslots')">
                                <i class="fas fa-arrow-left"></i> Back to Time Slots
                            </button>
                        </div>
                    </div>
                    
                    <p style="margin-bottom: 25px; color: var(--gray);">Add, edit or remove time slots to match your class schedule.</p>
                    
                    <!-- Add Time Slot Form -->
                    <div style="background: white; padding: 25px; border-radius: 15px; box-shadow: var(--card-shadow); margin-bottom: 30px;">
                        <h3 style="margin-bottom: 20px; color: var(--dark);"><i class="fas fa-plus"></i> Add New Time Slot</h3>
                        <div class="form-group">
                            <label class="form-label"><i class="fas fa-tag"></i> Time Slot Name</label>
                            <input type="text" id="newTimeSlotName" class="form-input" placeholder="e.g., Friday 7pm-8:30pm">
                        </div>
                        <button class="btn btn-success" onclick="addTimeSlot()">
                            <i class="fas fa-plus"></i> Add Time Slot
                        </button>
                    </div>
                    
                    <!-- Current Time Slots -->
                    <div style="background: white; padding: 25px; border-radius: 15px; box-shadow: var(--card-shadow);">
                        <div class="card-header">
                            <h3><i class="fas fa-list"></i> Current Time Slots</h3>
                            <span class="badge badge-primary" id="timeSlotCount">0 slots</span>
                        </div>
                        
                        <div class="time-slots-list" id="timeSlotsList" style="margin-top: 20px;">
                            <!-- Time slots list will be loaded here -->
                        </div>
                    </div>
                </div>

                <!-- Tools Section -->
                <div id="tools" class="section">
                    <div class="dashboard-header">
                        <h2><i class="fas fa-tools"></i> System Tools</h2>
                        <div class="card-actions">
                            <button class="btn btn-info" onclick="runSystemHealthCheck()">
                                <i class="fas fa-stethoscope"></i> Health Check
                            </button>
                        </div>
                    </div>
                    
                    <p style="margin-bottom: 25px; color: var(--gray);">Use these tools to fix data issues and optimize system performance.</p>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 25px;">
                        <!-- Fix Duplicate Attendance -->
                        <div class="dashboard-card hover-lift">
                            <div class="card-header">
                                <h3><i class="fas fa-exclamation-triangle"></i> Fix Duplicate Attendance</h3>
                                <span class="badge badge-warning">Important</span>
                            </div>
                            <p style="color: var(--gray); margin-bottom: 20px; line-height: 1.5;">Scan and remove duplicate attendance dates for all students. This will clean up data and fix attendance count calculations.</p>
                            <button class="btn btn-warning" onclick="fixDuplicateAttendance()" style="width: 100%;">
                                <i class="fas fa-search"></i> Scan & Fix Duplicates
                            </button>
                            <div style="margin-top: 15px; font-size: 0.9em; color: var(--gray);">
                                <i class="fas fa-clock"></i> Last checked: <span id="lastDuplicateCheck">Never</span>
                            </div>
                        </div>
                        
                        <!-- Recalculate All Attendance -->
                        <div class="dashboard-card hover-lift">
                            <div class="card-header">
                                <h3><i class="fas fa-calculator"></i> Recalculate Attendance</h3>
                                <span class="badge badge-info">Recommended</span>
                            </div>
                            <p style="color: var(--gray); margin-bottom: 20px; line-height: 1.5;">Recalculate attendance counts based on actual attendance records. Useful if attendance numbers seem incorrect.</p>
                            <button class="btn" onclick="recalculateAllAttendance()" style="width: 100%;">
                                <i class="fas fa-sync-alt"></i> Recalculate All
                            </button>
                        </div>
                        
                        <!-- Clean Orphaned Data -->
                        <div class="dashboard-card hover-lift">
                            <div class="card-header">
                                <h3><i class="fas fa-trash-alt"></i> Clean Orphaned Data</h3>
                                <span class="badge badge-secondary">Maintenance</span>
                            </div>
                            <p style="color: var(--gray); margin-bottom: 20px; line-height: 1.5;">Remove attendance records that have no corresponding students. This helps keep the database clean.</p>
                            <button class="btn btn-secondary" onclick="cleanOrphanedData()" style="width: 100%;">
                                <i class="fas fa-broom"></i> Clean Data
                            </button>
                        </div>
                        
                        <!-- Timezone Fixer -->
                        <div class="dashboard-card hover-lift">
                            <div class="card-header">
                                <h3><i class="fas fa-globe"></i> Fix Timezone Issues</h3>
                                <span class="badge badge-warning">Time-sensitive</span>
                            </div>
                            <p style="color: var(--gray); margin-bottom: 20px; line-height: 1.5;">Fix dates that appear one day off due to timezone differences. This ensures selected dates match recorded dates.</p>
                            <button class="btn btn-warning" onclick="DateFixer.fixAllDates()" style="width: 100%;">
                                <i class="fas fa-clock"></i> Fix Timezone Dates
                            </button>
                            <div style="margin-top: 15px; font-size: 0.9em; color: var(--gray);">
                                <i class="fas fa-info-circle"></i> Timezone offset: <span id="timezoneOffset">0</span> minutes
                            </div>
                        </div>
                        
                        <!-- Backup & Restore -->
                        <div class="dashboard-card hover-lift">
                            <div class="card-header">
                                <h3><i class="fas fa-database"></i> Backup & Restore</h3>
                                <span class="badge badge-success">Safety</span>
                            </div>
                            <p style="color: var(--gray); margin-bottom: 20px; line-height: 1.5;">Backup all data to a file or restore from a previous backup. Important for data safety.</p>
                            <div style="display: flex; gap: 10px; margin-top: 20px;">
                                <button class="btn btn-success" onclick="DataBackup.backup()" style="flex: 1;">
                                    <i class="fas fa-download"></i> Backup
                                </button>
                                <label class="btn btn-info" style="flex: 1; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px;">
                                    <i class="fas fa-upload"></i> Restore
                                    <input type="file" accept=".json" style="display: none;" onchange="DataBackup.restore(this.files[0])">
                                </label>
                            </div>
                            <div style="margin-top: 15px; font-size: 0.9em; color: var(--gray);">
                                <i class="fas fa-history"></i> Last backup: <span id="lastBackupTime">Never</span>
                            </div>
                        </div>
                        
                        <!-- System Health Check -->
                        <div class="dashboard-card hover-lift">
                            <div class="card-header">
                                <h3><i class="fas fa-heartbeat"></i> System Health Check</h3>
                                <span class="badge badge-primary">Diagnostic</span>
                            </div>
                            <p style="color: var(--gray); margin-bottom: 20px; line-height: 1.5;">Run a comprehensive check of system data integrity and performance.</p>
                            <button class="btn btn-info" onclick="runSystemHealthCheck()" style="width: 100%;">
                                <i class="fas fa-stethoscope"></i> Run Health Check
                            </button>
                            <div id="healthCheckResult" style="margin-top: 15px;"></div>
                        </div>
                    </div>
                </div>

                <!-- Data Export -->
                <div id="exports" class="section">
                    <div class="dashboard-header">
                        <h2><i class="fas fa-file-export"></i> Data Export</h2>
                        <div class="card-actions">
                            <button class="btn btn-secondary" onclick="showSection('dashboard')">
                                <i class="fas fa-arrow-left"></i> Back to Dashboard
                            </button>
                        </div>
                    </div>
                    
                    <div style="background: white; padding: 25px; border-radius: 15px; box-shadow: var(--card-shadow);">
                        <h3 style="margin-bottom: 20px; color: var(--dark);"><i class="fas fa-download"></i> Export Options</h3>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px;">
                            <!-- CSV Export -->
                            <div class="dashboard-card hover-lift" style="text-align: center;">
                                <div style="font-size: 3em; color: var(--success); margin-bottom: 15px;">
                                    <i class="fas fa-file-csv"></i>
                                </div>
                                <h4 style="margin-bottom: 10px; color: var(--dark);">CSV Export</h4>
                                <p style="color: var(--gray); margin-bottom: 20px; font-size: 0.9em;">Export all student data in CSV format for spreadsheet applications.</p>
                                <button class="btn btn-success" onclick="exportToCSV()" style="width: 100%;">
                                    <i class="fas fa-download"></i> Export to CSV
                                </button>
                            </div>
                            
                            <!-- JSON Export -->
                            <div class="dashboard-card hover-lift" style="text-align: center;">
                                <div style="font-size: 3em; color: var(--info); margin-bottom: 15px;">
                                    <i class="fas fa-file-code"></i>
                                </div>
                                <h4 style="margin-bottom: 10px; color: var(--dark);">JSON Export</h4>
                                <p style="color: var(--gray); margin-bottom: 20px; font-size: 0.9em;">Export complete system data in JSON format for backup or integration.</p>
                                <button class="btn btn-info" onclick="exportToJSON()" style="width: 100%;">
                                    <i class="fas fa-download"></i> Export to JSON
                                </button>
                            </div>
                            
                            <!-- PDF Report -->
                            <div class="dashboard-card hover-lift" style="text-align: center;">
                                <div style="font-size: 3em; color: var(--danger); margin-bottom: 15px;">
                                    <i class="fas fa-file-pdf"></i>
                                </div>
                                <h4 style="margin-bottom: 10px; color: var(--dark);">PDF Reports</h4>
                                <p style="color: var(--gray); margin-bottom: 20px; font-size: 0.9em;">Generate comprehensive PDF reports for students or classes.</p>
                                <button class="btn btn-danger" onclick="showSection('students')" style="width: 100%;">
                                    <i class="fas fa-file-pdf"></i> Generate PDF
                                </button>
                            </div>
                            
                            <!-- Print Report -->
                            <div class="dashboard-card hover-lift" style="text-align: center;">
                                <div style="font-size: 3em; color: var(--primary); margin-bottom: 15px;">
                                    <i class="fas fa-print"></i>
                                </div>
                                <h4 style="margin-bottom: 10px; color: var(--dark);">Print Report</h4>
                                <p style="color: var(--gray); margin-bottom: 20px; font-size: 0.9em;">Print attendance reports directly from your browser.</p>
                                <button class="btn" onclick="printReport()" style="width: 100%;">
                                    <i class="fas fa-print"></i> Print Report
                                </button>
                            </div>
                        </div>
                        
                        <div id="exportResult" style="margin-top: 20px;"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Student Details Modal -->
    <div id="studentDetailsModal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="fas fa-user-graduate"></i> Student Details
                </div>
                <button class="modal-close" onclick="closeStudentDetails()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 25px; margin-bottom: 25px;">
                <div>
                    <h4 style="color: var(--dark); margin-bottom: 15px; display: flex; align-items: center; gap: 8px;">
                        <i class="fas fa-user"></i> Personal Information
                    </h4>
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 10px;">
                        <div style="margin-bottom: 15px;">
                            <div style="font-weight: 600; color: var(--gray); font-size: 0.9em;">Name</div>
                            <div style="font-size: 1.1em; font-weight: 600; color: var(--dark);" id="detailStudentName"></div>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <div>
                                <div style="font-weight: 600; color: var(--gray); font-size: 0.9em;">Age</div>
                                <div id="detailStudentAge"></div>
                            </div>
                            <div>
                                <div style="font-weight: 600; color: var(--gray); font-size: 0.9em;">Gender</div>
                                <div id="detailStudentGender"></div>
                            </div>
                            <div>
                                <div style="font-weight: 600; color: var(--gray); font-size: 0.9em;">Time Slot</div>
                                <div id="detailStudentTimeSlot"></div>
                            </div>
                            <div>
                                <div style="font-weight: 600; color: var(--gray); font-size: 0.9em;">Enrolled Date</div>
                                <div id="detailStudentEnrolledDate"></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div>
                    <h4 style="color: var(--dark); margin-bottom: 15px; display: flex; align-items: center; gap: 8px;">
                        <i class="fas fa-chart-bar"></i> Attendance Summary
                    </h4>
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 10px;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                            <div style="text-align: center;">
                                <div style="font-size: 2.5em; font-weight: 700; color: var(--primary);" id="detailAttendanceCount">0</div>
                                <div style="font-weight: 600; color: var(--gray); font-size: 0.9em;">Sessions Attended</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 2.5em; font-weight: 700; color: var(--info);" id="detailRemainingSessions">0</div>
                                <div style="font-weight: 600; color: var(--gray); font-size: 0.9em;">Remaining Sessions</div>
                            </div>
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <div style="font-weight: 600; color: var(--gray); font-size: 0.9em;">Total Sessions</div>
                            <div style="font-size: 1.1em; font-weight: 600; color: var(--dark);" id="detailStudentTotalSessions"></div>
                        </div>
                        
                        <div>
                            <div style="font-weight: 600; color: var(--gray); font-size: 0.9em;">Last Attended</div>
                            <div style="font-size: 1.1em; font-weight: 600; color: var(--dark);" id="detailLastAttended"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="card-header">
                <h4 style="color: var(--dark); margin: 0; display: flex; align-items: center; gap: 8px;">
                    <i class="fas fa-calendar-check"></i> Attendance Dates
                </h4>
                <span id="detailTotalDates" style="color: var(--gray); font-size: 0.9em;">0 dates</span>
            </div>
            
            <div id="duplicateWarning" class="duplicate-warning" style="display: none; background: #fff3cd; color: #856404; padding: 12px; border-radius: 8px; margin: 15px 0; border-left: 4px solid var(--warning);">
                <i class="fas fa-exclamation-triangle"></i> <strong>Found duplicate dates!</strong> Some dates appear multiple times.
            </div>
            
            <div id="detailAttendanceDates" class="attendance-dates-grid" style="display: grid; grid-template-columns: repeat(6, 1fr); gap: 8px; margin-top: 15px; margin-bottom: 25px;">
                <!-- Dates will be loaded here -->
            </div>
            
            <div style="display: flex; gap: 10px; justify-content: flex-end;">
                <button class="btn btn-info" onclick="editCurrentStudent()">
                    <i class="fas fa-edit"></i> Edit Student
                </button>
                <button class="btn btn-success" onclick="openDateSelectionForSingleStudent()">
                    <i class="fas fa-calendar-plus"></i> Add Dates
                </button>
                <button class="btn btn-danger" onclick="generateStudentPDF(currentSelectedStudentId)">
                    <i class="fas fa-file-pdf"></i> PDF Report
                </button>
                <button class="btn btn-warning" onclick="fixStudentDuplicates()">
                    <i class="fas fa-exclamation-triangle"></i> Fix Duplicates
                </button>
                <button class="btn btn-secondary" onclick="closeStudentDetails()">
                    <i class="fas fa-times"></i> Close
                </button>
            </div>
        </div>
    </div>

    <!-- Date Selection Calendar Modal -->
    <div id="dateSelectionModal" class="modal-overlay" style="display: none;">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="fas fa-calendar-alt"></i> Select Attendance Dates
                </div>
                <button class="modal-close" onclick="closeDateSelectionModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 10px;">
                <button class="btn btn-secondary" onclick="changeCalendarMonth(-1)">
                    <i class="fas fa-chevron-left"></i> Previous Month
                </button>
                <span id="currentMonthLabel" style="font-weight: bold; font-size: 1.2em;">January 2024</span>
                <button class="btn btn-secondary" onclick="changeCalendarMonth(1)">
                    Next Month <i class="fas fa-chevron-right"></i>
                </button>
            </div>
            
            <div class="calendar-grid" id="calendarGrid">
                <!-- Calendar will be generated here -->
            </div>
            
            <div style="background: #f8f9fa; border-radius: 10px; padding: 15px; margin-top: 20px;">
                <div style="font-weight: 600; margin-bottom: 10px; color: var(--dark);">
                    <i class="fas fa-check-circle"></i> Selected Dates: <span id="selectedDatesCount">0</span> days
                </div>
                <div id="selectedDatesList" style="max-height: 100px; overflow-y: auto; font-size: 0.9em;">
                    <!-- Selected dates will be listed here -->
                </div>
            </div>
            
            <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                <button class="btn btn-secondary" onclick="closeDateSelectionModal()">
                    <i class="fas fa-times"></i> Cancel
                </button>
                <button class="btn btn-success" onclick="saveSelectedDates()">
                    <i class="fas fa-save"></i> Save Selection
                </button>
            </div>
        </div>
    </div>

    <script>
        // ==================== FIREBASE CONFIGURATION ====================
        const firebaseConfig = {
            apiKey: "AIzaSyB-enIolDzqs9sVcbB2Rxu7o86L5q7Kd7E",
            authDomain: "memoschool-kuching.firebaseapp.com",
            projectId: "memoschool-kuching",
            storageBucket: "memoschool-kuching.firebasestorage.app",
            messagingSenderId: "815724557443",
            appId: "1:815724557443:web:4033c1d71ef7e339fa97b6",
            measurementId: "G-KM0MJ80MN9"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        // Default time slot configuration
        const DEFAULT_TIME_SLOTS = [
            "Friday 2pm-3:30pm",
            "Saturday 9am-10:30am", 
            "Saturday 11am-12:30pm",
            "Saturday 2pm-4pm",
            "Sunday 9am-10:30am",
            "Sunday 11am-12:30pm",
            "Sunday 4pm-5:30pm"
        ];

        // Global variables
        let currentSearchTerm = '';
        let currentSelectedStudentId = '';
        let selectedDates = new Set();
        let currentCalendarDate = new Date();
        let dateSelectionMode = '';
        let dateSelectionStudentId = '';
        let dateSelectionStudentIds = [];
        let attendanceChart = null;

        // ==================== SYSTEM CLASS ====================
        class MemoschoolAttendanceSystem {
            constructor() {
                this.students = new Map();
                this.attendanceRecords = [];
                this.timeSlots = [];
                this.userId = null;
                this.isOnline = false;
            }
            
            async initialize(userId) {
                this.userId = userId;
                await this.loadFromFirestore();
                this.startRealtimeSync();
            }
            
            async loadFromFirestore() {
                if (!this.userId) return;
                
                try {
                    updateSyncStatus('<i class="fas fa-sync-alt"></i> Loading data from cloud...', 'syncing');
                    
                    // Load students
                    const studentsSnapshot = await db.collection('users').doc(this.userId)
                        .collection('students').get();
                    
                    this.students.clear();
                    studentsSnapshot.forEach(doc => {
                        this.students.set(doc.id, doc.data());
                    });
                    
                    // Load attendance records
                    const attendanceSnapshot = await db.collection('users').doc(this.userId)
                        .collection('attendance').get();
                    
                    this.attendanceRecords = [];
                    attendanceSnapshot.forEach(doc => {
                        this.attendanceRecords.push(doc.data());
                    });
                    
                    // Load time slots
                    const timeSlotsSnapshot = await db.collection('users').doc(this.userId)
                        .collection('timeSlots').get();
                    
                    this.timeSlots = [];
                    if (timeSlotsSnapshot.empty) {
                        await this.initializeDefaultTimeSlots();
                    } else {
                        timeSlotsSnapshot.forEach(doc => {
                            this.timeSlots.push(doc.data());
                        });
                        this.sortTimeSlots();
                    }
                    
                    updateSyncStatus('<i class="fas fa-check-circle"></i> Data loaded from cloud', 'synced');
                    this.isOnline = true;
                    updateUI();
                    
                } catch (error) {
                    console.error('Error loading from Firestore:', error);
                    updateSyncStatus('<i class="fas fa-exclamation-circle"></i> Error loading data', 'error');
                }
            }
            
            sortTimeSlots() {
                this.timeSlots.sort((a, b) => {
                    return this.getTimeSlotOrder(a.name) - this.getTimeSlotOrder(b.name);
                });
            }
            
            getTimeSlotOrder(timeSlotName) {
                const dayOrder = {
                    'Monday': 1, 'Tuesday': 2, 'Wednesday': 3, 'Thursday': 4,
                    'Friday': 5, 'Saturday': 6, 'Sunday': 7
                };
                
                const dayMatch = timeSlotName.match(/(Monday|Tuesday|Wednesday|Thursday|Friday|Saturday|Sunday)/i);
                const day = dayMatch ? dayMatch[0] : '';
                
                const timeMatch = timeSlotName.match(/(\d{1,2}(?::\d{2})?(?:am|pm))/i);
                let time = timeMatch ? timeMatch[0] : '';
                
                let timeValue = 0;
                if (time) {
                    time = time.toLowerCase();
                    let [hour, minute = '0'] = time.replace(/[ap]m/, '').split(':');
                    hour = parseInt(hour);
                    minute = parseInt(minute);
                    
                    if (time.includes('pm') && hour !== 12) hour += 12;
                    if (time.includes('am') && hour === 12) hour = 0;
                    
                    timeValue = hour * 60 + minute;
                }
                
                return (dayOrder[day] || 99) * 10000 + timeValue;
            }
            
            formatLocalDate(date) {
                if (!date || !(date instanceof Date) || isNaN(date.getTime())) {
                    const today = new Date();
                    const year = today.getFullYear();
                    const month = String(today.getMonth() + 1).padStart(2, '0');
                    const day = String(today.getDate()).padStart(2, '0');
                    return `${year}-${month}-${day}`;
                }
                
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            }
            
            getLocalDateString(dateInput) {
                if (!dateInput) {
                    return this.formatLocalDate(new Date());
                }
                
                if (dateInput instanceof Date) {
                    return this.formatLocalDate(dateInput);
                }
                
                if (typeof dateInput === 'string') {
                    if (/^\d{4}-\d{2}-\d{2}$/.test(dateInput)) {
                        return dateInput;
                    }
                    
                    if (/^\d{2}\/\d{2}\/\d{4}$/.test(dateInput)) {
                        const [day, month, year] = dateInput.split('/');
                        return `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
                    }
                    
                    const date = new Date(dateInput);
                    if (!isNaN(date.getTime())) {
                        return this.formatLocalDate(date);
                    }
                }
                
                return this.formatLocalDate(new Date());
            }
            
            formatDateForDisplay(dateString) {
                if (!dateString) return 'N/A';
                const localDateStr = this.getLocalDateString(dateString);
                const [year, month, day] = localDateStr.split('-');
                return `${day}/${month}/${year}`;
            }
            
            formatDate(dateString) {
                return this.formatDateForDisplay(dateString);
            }
            
            parseDate(dateString) {
                return this.getLocalDateString(dateString);
            }
            
            async initializeDefaultTimeSlots() {
                for (const timeSlot of DEFAULT_TIME_SLOTS) {
                    const timeSlotId = timeSlot.replace(/\s+/g, '-').toLowerCase();
                    const timeSlotData = {
                        id: timeSlotId,
                        name: timeSlot,
                        isDefault: true,
                        createdAt: new Date().toISOString()
                    };
                    
                    await db.collection('users').doc(this.userId).collection('timeSlots')
                        .doc(timeSlotId).set(timeSlotData);
                    
                    this.timeSlots.push(timeSlotData);
                }
                this.sortTimeSlots();
            }
            
            startRealtimeSync() {
                if (!this.userId) return;
                
                // Students listener
                db.collection('users').doc(this.userId).collection('students')
                    .onSnapshot((snapshot) => {
                        snapshot.docChanges().forEach((change) => {
                            if (change.type === 'added' || change.type === 'modified') {
                                this.students.set(change.doc.id, change.doc.data());
                            } else if (change.type === 'removed') {
                                this.students.delete(change.doc.id);
                            }
                        });
                        updateUI();
                        updateSyncStatus('<i class="fas fa-check-circle"></i> Real-time sync active', 'synced');
                    });
                
                // Attendance records listener
                db.collection('users').doc(this.userId).collection('attendance')
                    .onSnapshot((snapshot) => {
                        this.attendanceRecords = snapshot.docs.map(doc => doc.data());
                        updateUI();
                        updateSyncStatus('<i class="fas fa-check-circle"></i> Real-time sync active', 'synced');
                    });
                
                // Time slots listener
                db.collection('users').doc(this.userId).collection('timeSlots')
                    .onSnapshot((snapshot) => {
                        this.timeSlots = [];
                        snapshot.forEach(doc => {
                            this.timeSlots.push(doc.data());
                        });
                        this.sortTimeSlots();
                        updateUI();
                        updateSyncStatus('<i class="fas fa-check-circle"></i> Real-time sync active', 'synced');
                    });
            }
            
            async addStudent(name, age, gender, timeSlot, enrolledDate, totalSessions = 48) {
                if (!name || !timeSlot) {
                    throw new Error('Student name and time slot are required');
                }
                
                const studentId = `${name.replace(/\s+/g, '')}-${timeSlot.replace(/\s+/g, '')}-${Date.now()}`;
                const student = {
                    id: studentId,
                    name,
                    age: age || '',
                    gender: gender || '',
                    timeSlot,
                    enrolledDate: this.getLocalDateString(enrolledDate) || this.getLocalDateString(new Date()),
                    totalSessions: parseInt(totalSessions) || 48,
                    attendanceCount: 0,
                    attendanceDates: [],
                    createdAt: new Date().toISOString()
                };
                
                if (this.isOnline) {
                    await db.collection('users').doc(this.userId).collection('students')
                        .doc(studentId).set(student);
                } else {
                    this.students.set(studentId, student);
                }
                
                return student;
            }

            async updateStudent(studentId, updatedData) {
                const student = this.students.get(studentId);
                if (!student) {
                    throw new Error('Student not found');
                }
                
                const updatedStudent = {
                    ...student,
                    ...updatedData
                };
                
                if (this.isOnline) {
                    await db.collection('users').doc(this.userId).collection('students')
                        .doc(studentId).update(updatedData);
                } else {
                    this.students.set(studentId, updatedStudent);
                }
                
                return updatedStudent;
            }
            
            async recordAttendance(timeSlot, date, topic, presentStudentIds) {
                if (!timeSlot || !date) {
                    throw new Error('Time slot and date are required');
                }
                
                const localDate = this.getLocalDateString(date);
                const recordId = `${timeSlot}-${localDate}`.replace(/[^a-zA-Z0-9]/g, '-');
                
                const existingRecord = this.attendanceRecords.find(record => 
                    record.timeSlot === timeSlot && record.date === localDate
                );
                
                if (existingRecord) {
                    throw new Error(`Attendance for ${timeSlot} on ${this.formatDate(localDate)} already recorded`);
                }
                
                const record = {
                    id: recordId,
                    timeSlot,
                    date: localDate,
                    topic: topic || '',
                    presentStudents: presentStudentIds,
                    recordedAt: new Date().toISOString()
                };
                
                for (const studentId of presentStudentIds) {
                    const student = this.students.get(studentId);
                    if (student && localDate >= student.enrolledDate) {
                        
                        const alreadyRecorded = student.attendanceDates && 
                                              student.attendanceDates.includes(localDate);
                        
                        if (!alreadyRecorded) {
                            if (!student.attendanceDates) {
                                student.attendanceDates = [];
                            }
                            
                            student.attendanceDates.push(localDate);
                            const uniqueDates = [...new Set(student.attendanceDates)];
                            student.attendanceDates = uniqueDates;
                            student.attendanceCount = uniqueDates.length;
                            
                            if (this.isOnline) {
                                await db.collection('users').doc(this.userId).collection('students')
                                    .doc(studentId).update({
                                        attendanceDates: uniqueDates,
                                        attendanceCount: uniqueDates.length
                                    });
                            }
                        }
                    }
                }
                
                if (this.isOnline) {
                    await db.collection('users').doc(this.userId).collection('attendance')
                        .doc(recordId).set(record);
                } else {
                    this.attendanceRecords.push(record);
                }
                
                return record;
            }
            
            getStudentAttendance(studentId) {
                const student = this.students.get(studentId);
                if (!student) return null;
                
                const attendanceDates = student.attendanceDates || [];
                const uniqueDates = [...new Set(attendanceDates)];
                const validAttendanceDates = uniqueDates.filter(date => 
                    date >= student.enrolledDate
                );
                
                if (uniqueDates.length !== attendanceDates.length) {
                    student.attendanceDates = uniqueDates;
                    student.attendanceCount = uniqueDates.length;
                    
                    if (this.isOnline) {
                        db.collection('users').doc(system.userId).collection('students')
                            .doc(studentId).update({
                                attendanceDates: uniqueDates,
                                attendanceCount: uniqueDates.length
                            }).catch(console.error);
                    }
                }
                
                const validAttendanceCount = validAttendanceDates.length;
                const totalSessions = student.totalSessions || 48;
                
                if (student.attendanceCount !== validAttendanceCount) {
                    student.attendanceCount = validAttendanceCount;
                    
                    if (system.isOnline) {
                        db.collection('users').doc(system.userId).collection('students')
                            .doc(studentId).update({
                                attendanceCount: validAttendanceCount
                            }).catch(console.error);
                    }
                }
                
                const attendanceRate = totalSessions > 0 ? 
                    (validAttendanceCount / totalSessions * 100).toFixed(1) : 0;
                
                return {
                    ...student,
                    attendanceCount: validAttendanceCount,
                    totalSessions: totalSessions,
                    attendanceRate,
                    recentAttendance: validAttendanceDates.slice(-5)
                };
            }
            
            getStudentsByTimeSlot(timeSlot, searchTerm = '') {
                const students = [];
                for (const student of this.students.values()) {
                    if (timeSlot === 'all' || student.timeSlot === timeSlot) {
                        const studentWithAttendance = this.getStudentAttendance(student.id);
                        
                        if (!searchTerm || this.doesStudentMatchSearch(studentWithAttendance, searchTerm)) {
                            students.push(studentWithAttendance);
                        }
                    }
                }
                return students;
            }

            doesStudentMatchSearch(student, searchTerm) {
                if (!searchTerm) return true;
                
                const term = searchTerm.toLowerCase();
                return (
                    student.name.toLowerCase().includes(term) ||
                    (student.age && student.age.toString().includes(term)) ||
                    (student.gender && student.gender.toLowerCase().includes(term)) ||
                    (student.timeSlot && student.timeSlot.toLowerCase().includes(term)) ||
                    (student.enrolledDate && student.enrolledDate.toLowerCase().includes(term))
                );
            }
            
            getAllAttendance() {
                const result = [];
                for (const student of this.students.values()) {
                    result.push(this.getStudentAttendance(student.id));
                }
                return result;
            }
            
            getSummary() {
                const totalStudents = this.students.size;
                let totalAttendance = 0;
                let totalPossibleSessions = 0;
                
                for (const student of this.students.values()) {
                    const studentAttendance = this.getStudentAttendance(student.id);
                    totalAttendance += studentAttendance.attendanceCount;
                    totalPossibleSessions += studentAttendance.totalSessions;
                }
                
                const avgAttendanceRate = totalStudents > 0 && totalPossibleSessions > 0 ? 
                    (totalAttendance / totalPossibleSessions * 100).toFixed(1) : 0;
                
                return {
                    totalStudents,
                    totalSessions: this.attendanceRecords.length,
                    totalAttendance,
                    totalPossibleSessions,
                    averageAttendanceRate: avgAttendanceRate,
                    timeSlots: this.timeSlots.length
                };
            }

            exportToCSV() {
                let csv = 'Name,Age,Gender,Enrolled Date,Time Slot,Sessions Attended,Total Sessions\n';
                for (const student of this.students.values()) {
                    const info = this.getStudentAttendance(student.id);
                    const formattedDate = this.formatDateForDisplay(student.enrolledDate);
                    csv += `"${student.name}",${student.age},${student.gender},"${formattedDate}","${student.timeSlot}",${info.attendanceCount},${info.totalSessions}\n`;
                }
                return csv;
            }

            exportToJSON() {
                const data = {
                    system: {
                        school: "Genius Mind Academy",
                        timeSlots: this.timeSlots
                    },
                    students: Array.from(this.students.values()),
                    attendanceRecords: this.attendanceRecords
                };
                return JSON.stringify(data, null, 2);
            }
            
            async addTimeSlot(name) {
                if (!name) {
                    throw new Error('Time slot name is required');
                }
                
                const timeSlotId = name.replace(/\s+/g, '-').toLowerCase();
                const timeSlot = {
                    id: timeSlotId,
                    name: name,
                    isDefault: false,
                    createdAt: new Date().toISOString()
                };
                
                if (this.isOnline) {
                    await db.collection('users').doc(this.userId).collection('timeSlots')
                        .doc(timeSlotId).set(timeSlot);
                } else {
                    this.timeSlots.push(timeSlot);
                    this.sortTimeSlots();
                }
                
                return timeSlot;
            }
            
            async deleteTimeSlot(timeSlotId) {
                const studentsInTimeSlot = Array.from(this.students.values()).filter(
                    student => student.timeSlot === this.getTimeSlotNameById(timeSlotId)
                );
                
                if (studentsInTimeSlot.length > 0) {
                    throw new Error(`Cannot delete time slot. ${studentsInTimeSlot.length} student(s) are assigned to this time slot.`);
                }
                
                if (this.isOnline) {
                    await db.collection('users').doc(this.userId).collection('timeSlots')
                        .doc(timeSlotId).delete();
                } else {
                    this.timeSlots = this.timeSlots.filter(slot => slot.id !== timeSlotId);
                }
                
                return true;
            }
            
            getTimeSlotNameById(timeSlotId) {
                const timeSlot = this.timeSlots.find(slot => slot.id === timeSlotId);
                return timeSlot ? timeSlot.name : '';
            }
            
            async fixDuplicateAttendance() {
                let fixedCount = 0;
                
                for (const [studentId, student] of this.students.entries()) {
                    if (!student.attendanceDates || student.attendanceDates.length === 0) {
                        continue;
                    }
                    
                    const uniqueDates = [...new Set(student.attendanceDates)];
                    
                    if (uniqueDates.length !== student.attendanceDates.length) {
                        student.attendanceDates = uniqueDates;
                        student.attendanceCount = uniqueDates.length;
                        
                        if (this.isOnline) {
                            try {
                                await db.collection('users').doc(this.userId).collection('students')
                                    .doc(studentId).update({
                                        attendanceDates: uniqueDates,
                                        attendanceCount: uniqueDates.length
                                    });
                                fixedCount++;
                            } catch (error) {
                                console.error(`Error fixing student ${student.name}:`, error);
                            }
                        }
                    }
                }
                
                return fixedCount;
            }
            
            async recalculateAllAttendance() {
                let recalculatedCount = 0;
                const attendanceByStudent = new Map();
                
                for (const record of this.attendanceRecords) {
                    for (const studentId of record.presentStudents) {
                        if (!attendanceByStudent.has(studentId)) {
                            attendanceByStudent.set(studentId, new Set());
                        }
                        attendanceByStudent.get(studentId).add(record.date);
                    }
                }
                
                for (const [studentId, student] of this.students.entries()) {
                    const attendedDates = attendanceByStudent.get(studentId) || new Set();
                    const uniqueDates = [...attendedDates];
                    
                    student.attendanceDates = uniqueDates;
                    student.attendanceCount = uniqueDates.length;
                    
                    if (this.isOnline) {
                        try {
                            await db.collection('users').doc(this.userId).collection('students')
                                .doc(studentId).update({
                                    attendanceDates: uniqueDates,
                                    attendanceCount: uniqueDates.length
                                });
                            recalculatedCount++;
                        } catch (error) {
                            console.error(`Error recalculating student ${student.name}:`, error);
                        }
                    }
                }
                
                return recalculatedCount;
            }
        }

        // Create system instance
        const system = new MemoschoolAttendanceSystem();

        // ==================== UI ENHANCEMENTS ====================
        
        // Enhanced Toast System
        class ToastSystem {
            static show(message, type = 'success', duration = 3000) {
                const toastContainer = document.getElementById('toastContainer');
                if (!toastContainer) return;
                
                const toastId = 'toast-' + Date.now();
                const icons = {
                    success: '<i class="fas fa-check-circle"></i>',
                    error: '<i class="fas fa-exclamation-circle"></i>',
                    warning: '<i class="fas fa-exclamation-triangle"></i>',
                    info: '<i class="fas fa-info-circle"></i>'
                };
                
                const toast = document.createElement('div');
                toast.id = toastId;
                toast.className = `toast ${type}`;
                toast.innerHTML = `
                    <div class="toast-icon">${icons[type] || icons.info}</div>
                    <div class="toast-content">
                        <div class="toast-title">${type.charAt(0).toUpperCase() + type.slice(1)}</div>
                        <div class="toast-message">${message}</div>
                    </div>
                    <button class="toast-close" onclick="ToastSystem.close('${toastId}')">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                
                toastContainer.appendChild(toast);
                
                // Auto-remove after duration
                setTimeout(() => {
                    ToastSystem.close(toastId);
                }, duration);
                
                return toastId;
            }
            
            static close(toastId) {
                const toast = document.getElementById(toastId);
                if (toast) {
                    toast.style.animation = 'toastSlideIn 0.3s ease reverse';
                    setTimeout(() => {
                        if (toast.parentNode) {
                            toast.parentNode.removeChild(toast);
                        }
                    }, 300);
                }
            }
        }

        // Loading Overlay
        class LoadingOverlay {
            static show(message = 'Loading...') {
                const overlay = document.getElementById('loadingOverlay');
                const text = document.getElementById('loadingText');
                if (overlay && text) {
                    text.textContent = message;
                    overlay.style.display = 'flex';
                }
            }
            
            static hide() {
                const overlay = document.getElementById('loadingOverlay');
                if (overlay) {
                    overlay.style.display = 'none';
                }
            }
        }

        // Date Fixer
        class DateFixer {
            static fixAllDates() {
                console.log(' Fixing timezone issues...');
                
                let fixedCount = 0;
                
                for (const [studentId, student] of system.students.entries()) {
                    if (student.attendanceDates && student.attendanceDates.length > 0) {
                        const fixedDates = student.attendanceDates.map(date => 
                            system.getLocalDateString(date)
                        );
                        
                        if (JSON.stringify(fixedDates) !== JSON.stringify(student.attendanceDates)) {
                            student.attendanceDates = fixedDates;
                            fixedCount++;
                            
                            if (system.isOnline) {
                                db.collection('users').doc(system.userId).collection('students')
                                    .doc(studentId).update({
                                        attendanceDates: fixedDates
                                    }).catch(console.error);
                            }
                        }
                    }
                }
                
                for (const record of system.attendanceRecords) {
                    const fixedDate = system.getLocalDateString(record.date);
                    if (fixedDate !== record.date) {
                        record.date = fixedDate;
                        fixedCount++;
                        
                        if (system.isOnline) {
                            const recordId = record.id;
                            db.collection('users').doc(system.userId).collection('attendance')
                                .doc(recordId).update({
                                    date: fixedDate
                                }).catch(console.error);
                        }
                    }
                }
                
                console.log(` Fixed ${fixedCount} timezone issues`);
                ToastSystem.show(`Fixed ${fixedCount} timezone issues`, 'success');
                
                updateUI();
            }
        }

        // Data Backup System
        class DataBackup {
            static async backup() {
                try {
                    LoadingOverlay.show('Creating backup...');
                    
                    const data = {
                        students: Array.from(system.students.values()),
                        attendanceRecords: system.attendanceRecords,
                        timeSlots: system.timeSlots,
                        timestamp: new Date().toISOString(),
                        version: '1.0'
                    };
                    
                    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    const dateStr = new Date().toISOString().split('T')[0];
                    a.download = `genius_mind_backup_${dateStr}.json`;
                    a.click();
                    
                    URL.revokeObjectURL(url);
                    
                    // Update last backup time
                    const lastBackupElement = document.getElementById('lastBackupTime');
                    if (lastBackupElement) {
                        lastBackupElement.textContent = new Date().toLocaleString();
                    }
                    
                    LoadingOverlay.hide();
                    ToastSystem.show('Backup created successfully', 'success');
                    
                } catch (error) {
                    LoadingOverlay.hide();
                    ToastSystem.show('Backup failed: ' + error.message, 'error');
                }
            }
            
            static async restore(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = async (e) => {
                        try {
                            const data = JSON.parse(e.target.result);
                            
                            if (!data.students || !data.attendanceRecords) {
                                throw new Error('Invalid backup file format');
                            }
                            
                            // Show confirmation dialog
                            if (confirm(`Restore backup data?\n\nBackup contains:\n ${data.students.length} students\n ${data.attendanceRecords.length} attendance records\n Created: ${new Date(data.timestamp).toLocaleString()}\n\nThis will overwrite current data.`)) {
                                LoadingOverlay.show('Restoring data...');
                                
                                // Clear existing data
                                if (system.isOnline) {
                                    // Delete all existing data
                                    const batch = db.batch();
                                    
                                    // Delete students
                                    const studentsSnapshot = await db.collection('users').doc(system.userId)
                                        .collection('students').get();
                                    studentsSnapshot.forEach(doc => {
                                        batch.delete(doc.ref);
                                    });
                                    
                                    // Delete attendance records
                                    const attendanceSnapshot = await db.collection('users').doc(system.userId)
                                        .collection('attendance').get();
                                    attendanceSnapshot.forEach(doc => {
                                        batch.delete(doc.ref);
                                    });
                                    
                                    // Delete time slots
                                    const timeSlotsSnapshot = await db.collection('users').doc(system.userId)
                                        .collection('timeSlots').get();
                                    timeSlotsSnapshot.forEach(doc => {
                                        batch.delete(doc.ref);
                                    });
                                    
                                    await batch.commit();
                                    
                                    // Restore new data
                                    for (const student of data.students) {
                                        await db.collection('users').doc(system.userId)
                                            .collection('students').doc(student.id).set(student);
                                    }
                                    
                                    for (const record of data.attendanceRecords) {
                                        await db.collection('users').doc(system.userId)
                                            .collection('attendance').doc(record.id).set(record);
                                    }
                                    
                                    for (const timeSlot of data.timeSlots) {
                                        await db.collection('users').doc(system.userId)
                                            .collection('timeSlots').doc(timeSlot.id).set(timeSlot);
                                    }
                                }
                                
                                LoadingOverlay.hide();
                                ToastSystem.show('Data restored successfully', 'success');
                                
                                // Reload the page after 2 seconds
                                setTimeout(() => {
                                    location.reload();
                                }, 2000);
                            }
                            
                            resolve();
                        } catch (error) {
                            LoadingOverlay.hide();
                            ToastSystem.show('Restore failed: ' + error.message, 'error');
                            reject(error);
                        }
                    };
                    
                    reader.readAsText(file);
                });
            }
        }

        // ==================== DASHBOARD ENHANCEMENTS ====================
        
        // Update Dashboard Stats with animation
        function updateDashboard() {
            const summary = system.getSummary();
            
            // Animate number changes
            animateNumberChange('totalStudents', summary.totalStudents);
            animateNumberChange('sessionsRecorded', summary.totalSessions);
            animateNumberChange('avgAttendance', summary.averageAttendanceRate + '%');
            animateNumberChange('timeSlotsCountDashboard', summary.timeSlots);
            
            // Update other dashboard elements
            document.getElementById('timeSlotsCount').textContent = summary.timeSlots;
            document.getElementById('recordedSessionsCount').textContent = summary.totalSessions;
            
            // Update time slot distribution
            updateTimeSlotDistribution();
            
            // Update recent activity
            updateRecentActivity();
            
            // Update attendance chart
            updateAttendanceChart();
        }
        
        function animateNumberChange(elementId, newValue) {
            const element = document.getElementById(elementId);
            if (!element) return;
            
            const oldValue = parseInt(element.textContent) || 0;
            const newNum = parseInt(newValue) || 0;
            
            if (oldValue === newNum) {
                element.textContent = newValue;
                return;
            }
            
            element.classList.add('count-up');
            element.textContent = newValue;
            
            setTimeout(() => {
                element.classList.remove('count-up');
            }, 500);
        }
        
        function updateTimeSlotDistribution() {
            const container = document.getElementById('timeSlotDistribution');
            if (!container) return;
            
            // Count students per time slot
            const slotCounts = {};
            system.timeSlots.forEach(slot => {
                slotCounts[slot.name] = 0;
            });
            
            for (const student of system.students.values()) {
                if (slotCounts[student.timeSlot] !== undefined) {
                    slotCounts[student.timeSlot]++;
                }
            }
            
            const totalStudents = system.students.size;
            document.getElementById('totalStudentsBySlot').textContent = `${totalStudents} students`;
            
            // Clear container
            container.innerHTML = '';
            
            // Add bars for each time slot
            for (const [slotName, count] of Object.entries(slotCounts)) {
                const percentage = totalStudents > 0 ? (count / totalStudents * 100) : 0;
                
                const bar = document.createElement('div');
                bar.className = 'time-slot-bar';
                bar.innerHTML = `
                    <div class="time-slot-label">${slotName}</div>
                    <div class="time-slot-progress">
                        <div class="time-slot-fill" style="width: ${percentage}%"></div>
                    </div>
                    <div class="time-slot-count">${count}</div>
                `;
                
                container.appendChild(bar);
            }
        }
        
        function updateRecentActivity() {
            const container = document.getElementById('recentActivity');
            if (!container) return;
            
            // Get recent attendance records (sorted by date, newest first)
            const recentRecords = [...system.attendanceRecords]
                .sort((a, b) => new Date(b.date) - new Date(a.date))
                .slice(0, 5);
            
            if (recentRecords.length === 0) {
                container.innerHTML = `
                    <div class="empty-state" style="padding: 20px;">
                        <div class="empty-state-icon">
                            <i class="fas fa-history"></i>
                        </div>
                        <div class="empty-state-title">No recent activity</div>
                        <p>Record attendance to see activity here</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = '';
            
            recentRecords.forEach(record => {
                const activityItem = document.createElement('div');
                activityItem.className = 'activity-item hover-lift';
                
                const studentCount = record.presentStudents.length;
                const formattedDate = system.formatDateForDisplay(record.date);
                
                activityItem.innerHTML = `
                    <div class="activity-icon" style="background: var(--primary);">
                        <i class="fas fa-calendar-check"></i>
                    </div>
                    <div class="activity-details">
                        <div class="activity-title">${record.timeSlot} - ${studentCount} students attended</div>
                        <div class="activity-time">${formattedDate}  ${record.topic || 'No topic'}</div>
                    </div>
                `;
                
                container.appendChild(activityItem);
            });
        }
        
        function updateAttendanceChart() {
            const canvas = document.getElementById('attendanceChart');
            if (!canvas || typeof Chart === 'undefined') return;
            
            const period = parseInt(document.getElementById('chartPeriod')?.value || 7);
            
            // Calculate attendance for the last N days
            const dates = [];
            const counts = [];
            const today = new Date();
            
            for (let i = period - 1; i >= 0; i--) {
                const date = new Date(today);
                date.setDate(today.getDate() - i);
                const dateStr = system.getLocalDateString(date);
                
                // Format for display
                const displayDate = date.toLocaleDateString('en-US', { 
                    month: 'short', 
                    day: 'numeric' 
                });
                dates.push(displayDate);
                
                // Count attendance for this date
                let dayCount = 0;
                for (const record of system.attendanceRecords) {
                    if (record.date === dateStr) {
                        dayCount += record.presentStudents.length;
                    }
                }
                counts.push(dayCount);
            }
            
            // Destroy existing chart if it exists
            if (attendanceChart) {
                attendanceChart.destroy();
            }
            
            // Create new chart
            const ctx = canvas.getContext('2d');
            attendanceChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [{
                        label: 'Daily Attendance',
                        data: counts,
                        borderColor: 'rgb(230, 126, 34)',
                        backgroundColor: 'rgba(230, 126, 34, 0.1)',
                        tension: 0.4,
                        fill: true,
                        pointBackgroundColor: 'rgb(230, 126, 34)',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2,
                        pointRadius: 4,
                        pointHoverRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                color: 'var(--dark)',
                                font: {
                                    size: 12
                                }
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            titleColor: '#fff',
                            bodyColor: '#fff',
                            borderColor: 'var(--primary)',
                            borderWidth: 1
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            },
                            ticks: {
                                color: 'var(--gray)'
                            },
                            title: {
                                display: true,
                                text: 'Number of Students',
                                color: 'var(--dark)'
                            }
                        },
                        x: {
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            },
                            ticks: {
                                color: 'var(--gray)'
                            },
                            title: {
                                display: true,
                                text: 'Date',
                                color: 'var(--dark)'
                            }
                        }
                    }
                }
            });
        }

        // ==================== ENHANCED UI FUNCTIONS ====================
        
        function showSection(sectionId) {
            // Hide all sections
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            
            // Remove active class from all nav buttons
            document.querySelectorAll('.nav button').forEach(button => {
                button.classList.remove('active');
            });
            
            // Show selected section
            const section = document.getElementById(sectionId);
            if (section) {
                section.classList.add('active');
                
                // Add active class to corresponding nav button
                const navButton = document.querySelector(`.nav button[data-section="${sectionId}"]`);
                if (navButton) {
                    navButton.classList.add('active');
                }
                
                // Scroll to top of content
                document.querySelector('.content').scrollTop = 0;
                
                // Update section-specific UI
                if (sectionId === 'dashboard') {
                    updateDashboard();
                } else if (sectionId === 'students') {
                    updateTimeSlotTabs();
                } else if (sectionId === 'attendance') {
                    // Set today's date by default
                    const today = system.getLocalDateString(new Date());
                    document.getElementById('classDate').value = today;
                }
            }
        }
        
        function showAddStudentForm() {
            document.getElementById('addStudentForm').style.display = 'block';
            document.getElementById('editStudentForm').style.display = 'none';
            
            // Scroll to form
            document.getElementById('addStudentForm').scrollIntoView({ 
                behavior: 'smooth',
                block: 'start'
            });
        }
        
        function hideAddStudentForm() {
            document.getElementById('addStudentForm').style.display = 'none';
            
            // Clear form
            document.getElementById('studentName').value = '';
            document.getElementById('studentAge').value = '';
            document.getElementById('studentGender').value = '';
            document.getElementById('studentTimeSlot').value = '';
            document.getElementById('studentEnrolledDate').value = '';
            document.getElementById('studentTotalSessions').value = '48';
        }
        
        function clearAttendanceForm() {
            document.getElementById('timeSlotSelect').value = '';
            document.getElementById('classDate').value = system.getLocalDateString(new Date());
            document.getElementById('sessionTopic').value = '';
            
            // Clear checkboxes
            const checkboxes = document.querySelectorAll('#studentsCheckboxes input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                checkbox.checked = false;
            });
            
            // Reset stats display
            const statsContainer = document.getElementById('attendanceStats');
            statsContainer.innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">
                        <i class="fas fa-chart-bar"></i>
                    </div>
                    <div class="empty-state-title">No Data</div>
                    <p>Select a time slot to view statistics</p>
                </div>
            `;
            
            ToastSystem.show('Form cleared', 'info');
        }
        
        function selectAllCheckboxes() {
            const checkboxes = document.querySelectorAll('#studentsCheckboxes input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                checkbox.checked = true;
            });
            updateAttendanceStats();
        }
        
        function deselectAllCheckboxes() {
            const checkboxes = document.querySelectorAll('#studentsCheckboxes input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                checkbox.checked = false;
            });
            updateAttendanceStats();
        }
        
        function updateAttendanceStats() {
            const checkboxes = document.querySelectorAll('#studentsCheckboxes input[type="checkbox"]:checked');
            const totalStudents = document.querySelectorAll('#studentsCheckboxes input[type="checkbox"]').length;
            
            if (totalStudents === 0) return;
            
            const statsContainer = document.getElementById('attendanceStats');
            const percentage = Math.round((checkboxes.length / totalStudents) * 100);
            
            statsContainer.innerHTML = `
                <div style="text-align: center;">
                    <div style="font-size: 3em; font-weight: 700; color: var(--primary); margin-bottom: 10px;">
                        ${checkboxes.length}/${totalStudents}
                    </div>
                    <div style="font-size: 1.5em; font-weight: 600; color: var(--dark); margin-bottom: 5px;">
                        ${percentage}%
                    </div>
                    <div style="color: var(--gray); margin-bottom: 20px;">Attendance Rate</div>
                    
                    <div style="height: 10px; background: #e9ecef; border-radius: 5px; overflow: hidden; margin: 20px 0;">
                        <div style="height: 100%; width: ${percentage}%; background: linear-gradient(90deg, var(--primary), var(--primary-dark)); border-radius: 5px;"></div>
                    </div>
                    
                    <div style="display: flex; justify-content: space-around; margin-top: 25px;">
                        <div style="text-align: center;">
                            <div style="font-size: 1.8em; font-weight: 700; color: var(--success);">${checkboxes.length}</div>
                            <div style="color: var(--gray); font-size: 0.9em;">Present</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 1.8em; font-weight: 700; color: var(--danger);">${totalStudents - checkboxes.length}</div>
                            <div style="color: var(--gray); font-size: 0.9em;">Absent</div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function scrollToTop() {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
        
        function refreshDashboard() {
            LoadingOverlay.show('Refreshing dashboard...');
            
            // Simulate loading
            setTimeout(() => {
                updateDashboard();
                LoadingOverlay.hide();
                ToastSystem.show('Dashboard refreshed', 'success');
            }, 500);
        }
        
        function refreshRecords() {
            updateClassAttendanceRecords();
            updateStudentAttendanceSummary();
            ToastSystem.show('Records refreshed', 'success');
        }

        // ==================== INITIALIZATION ====================
        
        window.onload = function() {
            // Set today's date
            const today = system.getLocalDateString(new Date());
            document.getElementById('classDate').value = today;
            document.getElementById('studentEnrolledDate').value = today;
            
            // Set date range defaults for records
            const dateFrom = new Date();
            dateFrom.setDate(dateFrom.getDate() - 30); // 30 days ago
            document.getElementById('dateFrom').value = system.getLocalDateString(dateFrom);
            document.getElementById('dateTo').value = today;
            
            updateSyncStatus('<i class="fas fa-circle-notch fa-spin"></i> Ready to connect', 'syncing');
            updateTimezoneInfo();
            
            // Setup search functionality
            const searchInput = document.getElementById('searchStudents');
            if (searchInput) {
                let searchTimeout;
                searchInput.addEventListener('input', function(e) {
                    clearTimeout(searchTimeout);
                    searchTimeout = setTimeout(() => {
                        currentSearchTerm = e.target.value.trim();
                        updateTimeSlotTabs();
                    }, 300);
                });
            }
            
            // Set last duplicate check time
            document.getElementById('lastDuplicateCheck').textContent = 'Never';
            
            // Set last backup time
            document.getElementById('lastBackupTime').textContent = 'Never';
            
            // Debug timezone info
            console.log('Timezone offset:', new Date().getTimezoneOffset());
            console.log('Today local date:', system.getLocalDateString(new Date()));
            
            // Initialize FAB visibility
            window.addEventListener('scroll', function() {
                const fab = document.getElementById('fabButton');
                if (fab) {
                    if (window.scrollY > 300) {
                        fab.style.display = 'flex';
                    } else {
                        fab.style.display = 'none';
                    }
                }
            });
            
            // Auto-fix duplicates after 3 seconds
            setTimeout(() => {
                if (system.isOnline && system.students.size > 0) {
                    system.fixDuplicateAttendance().then(fixedCount => {
                        if (fixedCount > 0) {
                            console.log(`Automatically fixed ${fixedCount} duplicate attendance records`);
                        }
                    });
                }
            }, 3000);
        };

        // ==================== EXISTING FUNCTIONS (with minor enhancements) ====================
        // Note: Many existing functions remain the same but now use the enhanced UI components
        
        function showToast(message, type = 'success') {
            ToastSystem.show(message, type);
        }
        
        function updateSyncStatus(message, type = 'syncing') {
            const statusElement = document.getElementById('syncStatus');
            if (statusElement) {
                statusElement.innerHTML = message;
                statusElement.className = `sync-status ${type}`;
            }
        }
        
        function updateUI() {
            updateDashboard();
            updateTimeSlotSelects();
            updateTimeSlotTabs();
            updateStudentsCheckboxes();
            updateClassAttendanceRecords();
            updateStudentAttendanceSummary();
            updateTimeSlots();
            updateFilterStudent();
            updateTimeSlotsList();
            updateSelectedCount();
            updateTimezoneInfo();
        }
        
        // Update timezone info
        function updateTimezoneInfo() {
            const timezoneOffset = new Date().getTimezoneOffset();
            const timezoneElement = document.getElementById('timezoneOffset');
            if (timezoneElement) {
                const timezoneNote = timezoneOffset < 0 ? 
                    `(UTC+${Math.abs(timezoneOffset)/60})` : 
                    `(UTC-${timezoneOffset/60})`;
                timezoneElement.textContent = `${timezoneOffset} minutes ${timezoneNote}`;
            }
        }
        
        // The rest of your existing functions remain largely the same
        // but will now use the enhanced UI components
        // (login, logout, addStudent, editStudent, recordAttendance, etc.)
        
        // For brevity, I'm not copying all existing functions here since they remain
        // largely the same but will automatically use the enhanced UI elements
        
    </script>
</body>
</html>
