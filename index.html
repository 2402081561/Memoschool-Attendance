<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Genius Mind Mind Academy Attendance System</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    
    <!-- Chart.js for statistics -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        :root {
            --primary: #e67e22;
            --primary-dark: #d35400;
            --secondary: #3498db;
            --success: #27ae60;
            --warning: #f39c12;
            --danger: #e74c3c;
            --info: #17a2b8;
            --light: #f8f9fa;
            --dark: #2c3e50;
            --gray: #6c757d;
            --border: #e9ecef;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 25px 50px rgba(0,0,0,0.15);
            overflow: hidden;
            backdrop-filter: blur(10px);
        }
        .header {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }
        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" opacity="0.1"><circle cx="50" cy="50" r="2" fill="white"/></svg>') repeat;
        }
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            color: white;
            font-weight: 700;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        .header p {
            font-size: 1.2em;
            opacity: 0.9;
            font-weight: 300;
        }
        .school-logo {
            position: absolute;
            top: 20px;
            left: 30px;
            width: 80px;
            height: 80px;
            background: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.5em;
            box-shadow: 0 8px 25px rgba(0,0,0,0.2);
            overflow: hidden;
            z-index: 2;
            transition: transform 0.3s ease;
        }
        .school-logo:hover {
            transform: scale(1.05);
        }
        .school-logo img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .nav {
            background: var(--primary-dark);
            padding: 15px;
            display: flex;
            justify-content: center;
            gap: 8px;
            flex-wrap: wrap;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .nav button {
            background: rgba(255,255,255,0.15);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 50px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
        }
        .nav button:hover {
            background: rgba(255,255,255,0.25);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        .nav button:active {
            transform: translateY(0);
        }
        .content {
            padding: 30px;
            min-height: 500px;
            background: #f8f9fa;
        }
        .section {
            display: none;
            animation: fadeIn 0.5s ease;
        }
        .section.active {
            display: block;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .form-group {
            margin-bottom: 25px;
        }
        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--dark);
            font-size: 0.95em;
        }
        .form-label.required::after {
            content: ' *';
            color: var(--danger);
        }
        .form-input {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid var(--border);
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: white;
            font-family: inherit;
        }
        .form-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(230, 126, 34, 0.1);
        }
        .form-input:hover {
            border-color: #ced4da;
        }
        .form-input.error {
            border-color: var(--danger);
        }
        .error-message {
            color: var(--danger);
            font-size: 0.9em;
            margin-top: 5px;
            display: none;
        }
        .btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 14px 28px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .btn:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.15);
        }
        .btn:active {
            transform: translateY(0);
        }
        .btn-secondary {
            background: var(--secondary);
        }
        .btn-secondary:hover {
            background: #2980b9;
        }
        .btn-warning {
            background: var(--danger);
        }
        .btn-warning:hover {
            background: #c0392b;
        }
        .btn-info {
            background: var(--info);
        }
        .btn-info:hover {
            background: #138496;
        }
        .btn-success {
            background: var(--success);
        }
        .btn-success:hover {
            background: #219a52;
        }
        .table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            border-radius: 10px;
            overflow: hidden;
            background: white;
        }
        .table th, .table td {
            padding: 16px;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }
        .table th {
            background: var(--primary);
            color: white;
            font-weight: 600;
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .table tr:hover {
            background: rgba(230, 126, 34, 0.05);
        }
        .table tr:last-child td {
            border-bottom: none;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 25px;
            margin-top: 20px;
        }
        .stat-card {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            text-align: center;
            border-left: 5px solid var(--primary);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary), var(--primary-dark));
        }
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0,0,0,0.15);
        }
        .stat-card h3 {
            color: var(--dark);
            margin-bottom: 15px;
            font-size: 1.1em;
            font-weight: 600;
        }
        .stat-card .number {
            font-size: 3em;
            font-weight: bold;
            color: var(--primary);
            line-height: 1;
            margin: 10px 0;
        }
        .stat-card .trend {
            font-size: 0.85em;
            font-weight: 500;
            margin-top: 8px;
        }
        .stat-card .trend.positive {
            color: var(--success);
        }
        .stat-card .trend.negative {
            color: var(--danger);
        }
        .sync-status {
            background: #e8f4fd;
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            text-align: center;
            font-size: 14px;
            font-weight: 500;
            border-left: 4px solid var(--info);
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .sync-status.synced {
            background: #d4edda;
            color: #155724;
            border-left-color: var(--success);
        }
        .sync-status.syncing {
            background: #fff3cd;
            color: #856404;
            border-left-color: var(--warning);
        }
        .sync-status.error {
            background: #f8d7da;
            color: #721c24;
            border-left-color: var(--danger);
        }
        .login-panel {
            background: white;
            border-radius: 15px;
            padding: 40px;
            margin: 30px auto;
            text-align: center;
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
            max-width: 500px;
            border: 1px solid var(--border);
        }
        .user-info {
            background: linear-gradient(135deg, var(--success), #20c997);
            color: white;
            border-radius: 10px;
            padding: 15px 20px;
            margin: 15px 0;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .quick-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }
        .quick-stat {
            background: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            transition: transform 0.3s ease;
        }
        .quick-stat:hover {
            transform: translateY(-3px);
        }
        .quick-stat .value {
            font-size: 2.2em;
            font-weight: bold;
            color: var(--primary);
            line-height: 1;
            margin-bottom: 5px;
        }
        .quick-stat .label {
            color: var(--gray);
            font-size: 0.9em;
            font-weight: 500;
        }
        .welcome-panel {
            text-align: center;
            padding: 40px 20px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        .welcome-panel h2 {
            color: var(--dark);
            margin-bottom: 15px;
            font-weight: 700;
        }
        .welcome-panel p {
            color: var(--gray);
            max-width: 600px;
            margin: 0 auto 30px;
            line-height: 1.6;
            font-size: 1.1em;
        }
        .feature-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 25px;
            margin-top: 30px;
        }
        .feature-card {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            text-align: center;
            transition: all 0.3s ease;
            border: 1px solid var(--border);
            position: relative;
            overflow: hidden;
        }
        .feature-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary), var(--primary-dark));
        }
        .feature-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 15px 35px rgba(0,0,0,0.15);
        }
        .feature-card .icon {
            font-size: 3em;
            margin-bottom: 20px;
            display: block;
        }
        .feature-card h3 {
            color: var(--dark);
            margin-bottom: 15px;
            font-weight: 600;
        }
        .feature-card p {
            color: var(--gray);
            margin-bottom: 20px;
            line-height: 1.6;
        }
        .time-slot-card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin: 20px 0;
            border-left: 4px solid var(--primary);
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            transition: transform 0.3s ease;
        }
        .time-slot-card:hover {
            transform: translateY(-3px);
        }
        .time-slot-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .time-slot-title {
            font-size: 1.3em;
            font-weight: bold;
            color: var(--dark);
        }
        .student-count {
            background: var(--primary);
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 600;
        }
        .time-slot-students {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
        }
        .student-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.08);
            border: 1px solid var(--border);
            transition: all 0.3s ease;
        }
        .student-card:hover {
            box-shadow: 0 5px 15px rgba(0,0,0,0.12);
            transform: translateY(-2px);
        }
        .time-slot-tabs {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 25px;
            border-bottom: 1px solid var(--border);
            padding-bottom: 15px;
        }
        .time-slot-tab {
            padding: 12px 24px;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
            border: 1px solid var(--border);
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .time-slot-tab:hover {
            background: rgba(230, 126, 34, 0.1);
            border-color: var(--primary);
        }
        .time-slot-tab.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        .time-slot-content {
            display: none;
        }
        .time-slot-content.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }
        .checkbox-group {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 20px;
            background: white;
        }
        .checkbox-group label {
            display: block;
            padding: 12px;
            margin: 8px 0;
            border-radius: 8px;
            transition: background 0.2s;
            cursor: pointer;
        }
        .checkbox-group label:hover {
            background: rgba(230, 126, 34, 0.1);
        }
        .semester-info {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
            border-left: 4px solid var(--primary);
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
        }
        .attendance-record {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-top: 10px;
        }
        .attendance-dot {
            width: 25px;
            height: 25px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 10px;
            cursor: pointer;
            transition: transform 0.2s ease;
        }
        .attendance-dot:hover {
            transform: scale(1.1);
        }
        .present {
            background: var(--success);
            color: white;
        }
        .absent {
            background: var(--danger);
            color: white;
        }
        .export-options {
            display: flex;
            gap: 15px;
            margin: 25px 0;
            flex-wrap: wrap;
        }
        .search-box {
            max-width: 400px;
            margin-bottom: 30px;
        }
        .search-box input {
            border-radius: 25px;
            padding: 14px 20px;
            font-size: 14px;
            border: 2px solid var(--border);
        }
        .search-info {
            background: #e8f4fd;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            border-left: 4px solid var(--info);
        }
        .accuracy-note {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 15px;
            margin: 20px 0;
            font-size: 14px;
            color: #856404;
            border-left: 4px solid var(--warning);
        }
        .student-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 20px;
            margin-top: 25px;
        }
        .student-card-enhanced {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            border-left: 4px solid var(--primary);
            transition: all 0.3s ease;
            position: relative;
        }
        .student-card-enhanced:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
        }
        .student-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }
        .student-name {
            font-size: 1.2em;
            font-weight: bold;
            color: var(--dark);
            margin: 0;
        }
        .student-meta {
            color: var(--gray);
            font-size: 0.9em;
            margin: 5px 0;
        }
        .attendance-badge {
            background: var(--success);
            color: white;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: bold;
        }
        .attendance-low {
            background: var(--danger);
        }
        .attendance-medium {
            background: var(--warning);
        }
        .student-actions {
            display: flex;
            gap: 8px;
            margin-top: 15px;
        }
        .progress-container {
            margin: 15px 0;
        }
        .progress-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 0.9em;
            font-weight: 500;
        }
        .progress-bar {
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            background: var(--success);
            transition: width 0.5s ease;
            border-radius: 4px;
        }
        .progress-fill.medium {
            background: var(--warning);
        }
        .progress-fill.low {
            background: var(--danger);
        }
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            border-left: 4px solid var(--success);
            z-index: 1000;
            animation: slideInRight 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
            max-width: 350px;
        }
        .toast.error {
            border-left-color: var(--danger);
        }
        .toast.warning {
            border-left-color: var(--warning);
        }
        .toast.info {
            border-left-color: var(--info);
        }
        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(100%);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Skeleton loading */
        .skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: skeleton-loading 1.5s infinite;
            border-radius: 4px;
        }
        @keyframes skeleton-loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        .skeleton-card {
            padding: 20px;
            border-radius: 12px;
            background: white;
            margin-bottom: 20px;
        }
        .skeleton-text {
            height: 16px;
            margin-bottom: 8px;
        }
        .skeleton-title {
            height: 24px;
            margin-bottom: 16px;
            width: 60%;
        }
        
        /* Ëá™ÂÆö‰πâÊó∂Èó¥ÊßΩÊ†∑Âºè */
        .time-slots-management {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            margin-bottom: 30px;
        }
        .time-slots-list {
            margin-top: 20px;
        }
        .time-slot-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            margin-bottom: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid var(--primary);
        }
        .time-slot-actions {
            display: flex;
            gap: 10px;
        }
        .time-slot-actions button {
            padding: 6px 12px;
            font-size: 12px;
        }
        
        /* Import students section */
        .import-section {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid var(--border);
        }
        .file-upload {
            display: flex;
            align-items: center;
            gap: 15px;
            margin: 15px 0;
        }
        .file-input {
            display: none;
        }
        .file-label {
            border: 2px dashed var(--border);
            padding: 15px 20px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            flex: 1;
        }
        .file-label:hover {
            border-color: var(--primary);
            background: rgba(230, 126, 34, 0.05);
        }
        .file-name {
            margin-top: 10px;
            font-size: 0.9em;
            color: var(--gray);
        }
        .template-link {
            color: var(--primary);
            text-decoration: none;
            font-weight: 500;
        }
        .template-link:hover {
            text-decoration: underline;
        }
        
        /* Charts container */
        .chart-container {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin: 20px 0;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            height: 300px;
        }
        
        /* Mobile bottom navigation */
        .mobile-nav {
            display: none;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            z-index: 100;
        }
        .mobile-nav-buttons {
            display: flex;
            justify-content: space-around;
        }
        .mobile-nav-btn {
            flex: 1;
            padding: 15px 0;
            text-align: center;
            border: none;
            background: transparent;
            cursor: pointer;
            font-size: 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            color: var(--gray);
        }
        .mobile-nav-btn.active {
            color: var(--primary);
        }
        .mobile-nav-btn i {
            font-size: 18px;
        }
        
        @media (max-width: 768px) {
            .nav {
                display: none;
            }
            .mobile-nav {
                display: block;
            }
            .content {
                padding-bottom: 80px; /* Make space for mobile nav */
            }
            .header h1 {
                font-size: 1.8em;
            }
            .school-logo {
                position: relative;
                top: 0;
                left: 0;
                margin: 0 auto 15px;
            }
            .time-slot-header {
                flex-direction: column;
                align-items: flex-start;
            }
            .student-count {
                margin-top: 10px;
            }
            .time-slot-tabs {
                flex-direction: column;
            }
            .student-grid {
                grid-template-columns: 1fr;
            }
            .feature-cards {
                grid-template-columns: 1fr;
            }
            .stats-grid {
                grid-template-columns: 1fr;
            }
            .time-slot-item {
                flex-direction: column;
                align-items: flex-start;
            }
            .time-slot-actions {
                margin-top: 10px;
                width: 100%;
                justify-content: flex-end;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="school-logo" id="schoolLogo">
                <img src="./gmlogo.png" alt="Genius Mind Academy" onerror="this.style.display='none'; this.parentNode.innerHTML='GMA'">
            </div>
            <h1>Genius Mind Academy Attendance System</h1>
            <p>Real-time sync across all devices</p>
        </div>
        
        <!-- Firebase Login Section -->
        <div id="loginSection">
            <div class="login-panel">
                <h2>üîê Login to Sync Data</h2>
                <p>Sign in to automatically sync data across all your devices</p>
                <div class="form-group">
                    <input type="email" id="email" placeholder="Email address" class="form-input" style="max-width: 300px; margin: 10px auto;">
                    <div class="error-message" id="emailError"></div>
                    <input type="password" id="password" placeholder="Password" class="form-input" style="max-width: 300px; margin: 10px auto;">
                    <div class="error-message" id="passwordError"></div>
                </div>
                <button class="btn" onclick="login()">Login</button>
                <button class="btn btn-secondary" onclick="signup()">Sign Up</button>
                <p style="margin-top: 15px; font-size: 14px; color: #666;">
                    Don't have an account? Click Sign Up to create one
                </p>
                <div id="authError" class="sync-status error" style="margin-top: 15px; display: none;"></div>
            </div>
        </div>

        <div id="appSection" style="display: none;">
            <div class="user-info">
                <span>Welcome, <strong id="userEmail"></strong></span>
                <button class="btn btn-warning" onclick="logout()" style="padding: 8px 16px; font-size: 14px;">Logout</button>
            </div>
            
            <div class="nav">
                <button onclick="showSection('dashboard')">üìä Dashboard</button>
                <button onclick="showSection('students')">üë• Students</button>
                <button onclick="showSection('attendance')">üìù Attendance</button>
                <button onclick="showSection('records')">üìà Records</button>
                <button onclick="showSection('timeslots')">‚è∞ Time Slots</button>
                <button onclick="showSection('timeSlotsManagement')">‚ûï Manage Time Slots</button>
                <button onclick="showSection('exports')">üì§ Export</button>
                <button onclick="showSection('stats')">üìä Statistics</button>
            </div>
            
            <!-- Mobile navigation -->
            <div class="mobile-nav">
                <div class="mobile-nav-buttons">
                    <button class="mobile-nav-btn" onclick="showSection('dashboard')">
                        <span>üìä</span>
                        <span>Dashboard</span>
                    </button>
                    <button class="mobile-nav-btn" onclick="showSection('students')">
                        <span>üë•</span>
                        <span>Students</span>
                    </button>
                    <button class="mobile-nav-btn" onclick="showSection('attendance')">
                        <span>üìù</span>
                        <span>Attendance</span>
                    </button>
                    <button class="mobile-nav-btn" onclick="showSection('stats')">
                        <span>üìä</span>
                        <span>Stats</span>
                    </button>
                </div>
            </div>
            
            <div class="content">
                <!-- Sync Status Display -->
                <div class="sync-status" id="syncStatus">
                    üîÑ Connecting to database...
                </div>

                <!-- Dashboard -->
                <div id="dashboard" class="section active">
                    <div class="welcome-panel">
                        <h2>Welcome to Genius Mind Academy</h2>
                        <p>Your data is automatically synced across all devices in real-time</p>
                        
                        <div class="semester-info">
                            <h3>Attendance Information</h3>
                            <p><strong>Time Slots:</strong> <span id="timeSlotsCount">0</span> | <strong>Recorded Sessions:</strong> <span id="recordedSessionsCount">0</span></p>
                        </div>
                        
                        <div class="stats-grid">
                            <div class="stat-card">
                                <h3>Total Students</h3>
                                <div class="number" id="totalStudents">0</div>
                                <div class="trend positive">+12% this month</div>
                            </div>
                            <div class="stat-card">
                                <h3>Sessions Recorded</h3>
                                <div class="number" id="sessionsRecorded">0</div>
                                <div class="trend positive">Active tracking</div>
                            </div>
                            <div class="stat-card">
                                <h3>Average Attendance</h3>
                                <div class="number" id="avgAttendance">0%</div>
                                <div class="trend positive">+5% improvement</div>
                            </div>
                            <div class="stat-card">
                                <h3>Time Slots</h3>
                                <div class="number" id="timeSlotsCountDashboard">0</div>
                                <div class="trend">All active</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="chart-container">
                        <canvas id="attendanceTrendChart"></canvas>
                    </div>
                    
                    <div class="feature-cards">
                        <div class="feature-card">
                            <div class="icon">üìù</div>
                            <h3>Record Attendance</h3>
                            <p>Mark attendance for specific time slots and dates with our intuitive interface.</p>
                            <button class="btn" onclick="showSection('attendance')">Record Now</button>
                        </div>
                        <div class="feature-card">
                            <div class="icon">üë•</div>
                            <h3>Manage Students</h3>
                            <p>Add students with detailed information and assign them to appropriate time slots.</p>
                            <button class="btn" onclick="showSection('students')">Manage Students</button>
                        </div>
                        <div class="feature-card">
                            <div class="icon">‚è∞</div>
                            <h3>Time Slots</h3>
                            <p>View students grouped by their class time slots for better organization.</p>
                            <button class="btn" onclick="showSection('timeslots')">View Time Slots</button>
                        </div>
                        <div class="feature-card">
                            <div class="icon">‚ûï</div>
                            <h3>Manage Time Slots</h3>
                            <p>Add, edit or remove time slots to match your class schedule.</p>
                            <button class="btn" onclick="showSection('timeSlotsManagement')">Manage Time Slots</button>
                        </div>
                    </div>
                </div>
                
                <!-- Student Management -->
                <div id="students" class="section">
                    <h2>üë• Student Management</h2>
                    
                    <!-- ÊêúÁ¥¢Ê°Ü -->
                    <div class="form-group search-box">
                        <label class="form-label">üîç Search Students</label>
                        <input type="text" id="searchStudents" class="form-input" placeholder="Search by name, age, gender, or time slot...">
                    </div>
                    
                    <!-- Ê∑ªÂä†Â≠¶ÁîüË°®Âçï -->
                    <div style="background: white; padding: 25px; border-radius: 12px; box-shadow: 0 5px 15px rgba(0,0,0,0.08); margin-bottom: 30px;">
                        <h3 style="margin-bottom: 20px; color: var(--dark);">Add New Student</h3>
                        <div class="form-group">
                            <label class="form-label required">Student Name</label>
                            <input type="text" id="studentName" class="form-input" placeholder="Enter student name">
                            <div class="error-message" id="studentNameError"></div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Age</label>
                            <input type="number" id="studentAge" class="form-input" placeholder="Enter age" min="5" max="30">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Gender</label>
                            <select id="studentGender" class="form-input">
                                <option value="">Select Gender</option>
                                <option value="Male">Male</option>
                                <option value="Female">Female</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label required">Time Slot</label>
                            <select id="studentTimeSlot" class="form-input">
                                <option value="">Select Time Slot</option>
                                <!-- Êó∂Èó¥ÊßΩÂ∞ÜÈÄöËøáJavaScriptÂä®ÊÄÅÂä†ËΩΩ -->
                            </select>
                            <div class="error-message" id="studentTimeSlotError"></div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Enrolled Date</label>
                            <input type="date" id="studentEnrolledDate" class="form-input">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Total Sessions (Default: 48)</label>
                            <input type="number" id="studentTotalSessions" class="form-input" placeholder="48" min="1" max="200" value="48">
                        </div>
                        <button class="btn btn-success" onclick="addStudent()">
                            <span>‚ûï Add Student</span>
                        </button>
                    </div>
                    
                    <!-- ÊâπÈáèÂØºÂÖ•Â≠¶Áîü -->
                    <div class="import-section">
                        <h3 style="margin-bottom: 20px; color: var(--dark);">Batch Import Students</h3>
                        <p>Import multiple students using a CSV template. <a href="#" class="template-link" onclick="downloadTemplate()">Download template</a></p>
                        
                        <div class="file-upload">
                            <label class="file-label" for="studentFileUpload">
                                <strong>Click to upload CSV file</strong>
                                <p>or drag and drop here</p>
                                <div class="file-name" id="fileName">No file selected</div>
                            </label>
                            <input type="file" id="studentFileUpload" class="file-input" accept=".csv">
                            <button class="btn" onclick="importStudents()">Import</button>
                        </div>
                    </div>
                    
                    <!-- ÁºñËæëÂ≠¶ÁîüË°®Âçï -->
                    <div id="editStudentForm" style="display: none; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 5px 15px rgba(0,0,0,0.08); margin-bottom: 30px; border-left: 4px solid var(--info);">
                        <h3 style="margin-bottom: 20px; color: var(--dark);">‚úèÔ∏è Edit Student</h3>
                        
                        <div class="form-group">
                            <label class="form-label required">Student Name</label>
                            <input type="text" id="editStudentName" class="form-input" placeholder="Enter student name">
                            <div class="error-message" id="editStudentNameError"></div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Age</label>
                            <input type="number" id="editStudentAge" class="form-input" placeholder="Enter age" min="5" max="30">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Gender</label>
                            <select id="editStudentGender" class="form-input">
                                <option value="">Select Gender</option>
                                <option value="Male">Male</option>
                                <option value="Female">Female</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label required">Time Slot</label>
                            <select id="editStudentTimeSlot" class="form-input">
                                <option value="">Select Time Slot</option>
                                <!-- Êó∂Èó¥ÊßΩÂ∞ÜÈÄöËøáJavaScriptÂä®ÊÄÅÂä†ËΩΩ -->
                            </select>
                            <div class="error-message" id="editStudentTimeSlotError"></div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Enrolled Date</label>
                            <input type="date" id="editStudentEnrolledDate" class="form-input">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Total Sessions</label>
                            <input type="number" id="editStudentTotalSessions" class="form-input" placeholder="48" min="1" max="200">
                        </div>
                        <input type="hidden" id="editStudentId">
                        <button class="btn" onclick="updateStudent()">üíæ Update Student</button>
                        <button class="btn btn-secondary" onclick="cancelEdit()">‚ùå Cancel</button>
                    </div>
                    
                    <h3 style="margin-top: 10px; margin-bottom: 20px;">Student List</h3>
                    
                    <div id="studentsSkeleton" class="skeleton-card" style="display: none;">
                        <div class="skeleton skeleton-title"></div>
                        <div class="skeleton skeleton-text" style="width: 80%;"></div>
                        <div class="skeleton skeleton-text" style="width: 60%;"></div>
                        <div class="skeleton skeleton-text" style="width: 40%;"></div>
                    </div>
                    
                    <div class="time-slot-tabs" id="timeSlotTabs"></div>
                    <div id="timeSlotContents"></div>
                </div>
                
                <!-- Record Attendance -->
                <div id="attendance" class="section">
                    <h2>üìù Record Attendance</h2>
                    <div style="background: white; padding: 25px; border-radius: 12px; box-shadow: 0 5px 15px rgba(0,0,0,0.08);">
                        <div class="form-group">
                            <label class="form-label required">Select Time Slot</label>
                            <select id="timeSlotSelect" class="form-input" onchange="updateStudentsCheckboxes()">
                                <option value="">Select Time Slot</option>
                                <!-- Êó∂Èó¥ÊßΩÂ∞ÜÈÄöËøáJavaScriptÂä®ÊÄÅÂä†ËΩΩ -->
                            </select>
                            <div class="error-message" id="timeSlotSelectError"></div>
                        </div>
                        <div class="form-group">
                            <label class="form-label required">Date</label>
                            <input type="date" id="classDate" class="form-input">
                            <div class="error-message" id="classDateError"></div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Session Topic (Optional)</label>
                            <input type="text" id="sessionTopic" class="form-input" placeholder="Enter session topic">
                        </div>
                        <div class="form-group">
                            <label class="form-label required">Select Present Students</label>
                            <div class="checkbox-group" id="studentsCheckboxes">
                                <p>Please select a time slot to see students</p>
                            </div>
                            <div class="error-message" id="presentStudentsError"></div>
                        </div>
                        <button class="btn btn-success" onclick="recordAttendance()">
                            <span>‚úÖ Record Attendance</span>
                        </button>
                    </div>
                </div>
                
                <!-- Attendance Records -->
                <div id="records" class="section">
                    <h2>üìä Attendance Records</h2>
                    <div class="accuracy-note">
                        üìà <strong>Accuracy Note:</strong> Attendance rates are calculated based on total sessions set for each student (default: 48). You can adjust total sessions for individual students in the student management section.
                    </div>
                    <div style="background: white; padding: 25px; border-radius: 12px; box-shadow: 0 5px 15px rgba(0,0,0,0.08);">
                        <div class="form-group">
                            <label class="form-label">Filter by Time Slot</label>
                            <select id="filterTimeSlot" class="form-input" onchange="filterAttendanceRecords()">
                                <option value="all">All Time Slots</option>
                                <!-- Êó∂Èó¥ÊßΩÂ∞ÜÈÄöËøáJavaScriptÂä®ÊÄÅÂä†ËΩΩ -->
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Filter by Student</label>
                            <select id="filterStudent" class="form-input" onchange="filterAttendanceRecords()">
                                <option value="all">All Students</option>
                            </select>
                        </div>
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Age</th>
                                    <th>Gender</th>
                                    <th>Enrolled Date</th>
                                    <th>Time Slot</th>
                                    <th>Sessions Attended</th>
                                    <th>Total Sessions</th>
                                    <th>Attendance Rate</th>
                                    <th>Recent Attendance</th>
                                </tr>
                            </thead>
                            <tbody id="attendanceRecords">
                                <!-- Skeleton loading for table -->
                                <tr id="recordsSkeleton" style="display: none;">
                                    <td colspan="9">
                                        <div class="skeleton-card">
                                            <div class="skeleton skeleton-title"></div>
                                            <div class="skeleton skeleton-text" style="width: 80%;"></div>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Time Slots -->
                <div id="timeslots" class="section">
                    <h2>‚è∞ Time Slots</h2>
                    <p>Students grouped by their class time slots.</p>
                    <div id="timeSlotsContainer"></div>
                </div>

                <!-- Time Slots Management -->
                <div id="timeSlotsManagement" class="section">
                    <h2>‚ûï Manage Time Slots</h2>
                    <p>Add, edit or remove time slots to match your class schedule.</p>
                    
                    <div class="time-slots-management">
                        <h3>Add New Time Slot</h3>
                        <div class="form-group">
                            <label class="form-label required">Time Slot Name</label>
                            <input type="text" id="newTimeSlotName" class="form-input" placeholder="e.g., Friday 7pm-8:30pm">
                            <div class="error-message" id="newTimeSlotNameError"></div>
                        </div>
                        <button class="btn btn-success" onclick="addTimeSlot()">
                            <span>‚ûï Add Time Slot</span>
                        </button>
                    </div>
                    
                    <div class="time-slots-management">
                        <h3>Current Time Slots</h3>
                        <div class="time-slots-list" id="timeSlotsList">
                            <!-- Êó∂Èó¥ÊßΩÂàóË°®Â∞ÜÈÄöËøáJavaScriptÂä®ÊÄÅÂä†ËΩΩ -->
                        </div>
                    </div>
                </div>

                <!-- Data Export -->
                <div id="exports" class="section">
                    <h2>üì§ Data Export</h2>
                    <div style="background: white; padding: 25px; border-radius: 12px; box-shadow: 0 5px 15px rgba(0,0,0,0.08);">
                        <div class="export-options">
                            <button class="btn" onclick="exportToCSV()">üìÑ Export to CSV</button>
                            <button class="btn" onclick="exportToJSON()">üî§ Export to JSON</button>
                            <button class="btn" onclick="printReport()">üñ®Ô∏è Print Report</button>
                        </div>
                        <div id="exportProgress" style="margin-top: 20px; display: none;">
                            <div class="sync-status syncing">üîÑ Exporting data...</div>
                        </div>
                        <div id="exportResult" style="margin-top: 20px;"></div>
                    </div>
                </div>

                <!-- Statistics -->
                <div id="stats" class="section">
                    <h2>üìà Statistics</h2>
                    <div class="chart-container">
                        <canvas id="timeSlotComparisonChart"></canvas>
                    </div>
                    <div class="stats-grid" id="statsGrid"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // === Firebase ÈÖçÁΩÆ ===
        const firebaseConfig = {
            apiKey: "AIzaSyB-enIolDzqs9sVcbB2Rxu7o86L5q7Kd7E",
            authDomain: "memoschool-kuching.firebaseapp.com",
            projectId: "memoschool-kuching",
            storageBucket: "memoschool-kuching.firebasestorage.app",
            messagingSenderId: "815724557443",
            appId: "1:815724557443:web:4033c1d71ef7e339fa97b6",
            measurementId: "G-KM0MJ80MN9"
        };

        // ÂàùÂßãÂåñFirebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        // ÂêØÁî®Á¶ªÁ∫øÊåÅ‰πÖÂåñ
        db.enablePersistence().catch((err) => {
            if (err.code === 'failed-precondition') {
                console.log('Multiple tabs open, persistence can only be enabled in one tab at a time.');
            } else if (err.code === 'unimplemented') {
                console.log('The current browser does not support all of the features required to enable persistence');
            }
        });

        // ÈªòËÆ§Êó∂Èó¥ÊßΩÈÖçÁΩÆ - ÊåâÊó∂Èó¥È°∫Â∫èÊéíÂàó
        const DEFAULT_TIME_SLOTS = [
            "Friday 2pm-3:30pm",
            "Saturday 9am-10:30am", 
            "Saturday 11am-12:30pm",
            "Saturday 2pm-4pm",
            "Sunday 9am-10:30am",
            "Sunday 11am-12:30pm",
            "Sunday 4pm-5:30pm"
        ];

        // ÊêúÁ¥¢Áõ∏ÂÖ≥ÂèòÈáè
        let currentSearchTerm = '';
        let attendanceTrendChart = null;
        let timeSlotComparisonChart = null;

        // Á≥ªÁªüÁ±ª
        class MemoschoolAttendanceSystem {
            constructor() {
                this.students = new Map();
                this.attendanceRecords = [];
                this.timeSlots = [];
                this.userId = null;
                this.isOnline = false;
            }
            
            async initialize(userId) {
                this.userId = userId;
                await this.loadFromFirestore();
                this.startRealtimeSync();
            }
            
            async loadFromFirestore() {
                if (!this.userId) return;
                
                try {
                    updateSyncStatus('üîÑ Loading data from cloud...', 'syncing');
                    
                    // ÊòæÁ§∫È™®Êû∂Â±è
                    showSkeletons();
                    
                    // Âä†ËΩΩÂ≠¶ÁîüÊï∞ÊçÆ
                    const studentsSnapshot = await db.collection('users').doc(this.userId)
                        .collection('students').get();
                    
                    this.students.clear();
                    studentsSnapshot.forEach(doc => {
                        this.students.set(doc.id, doc.data());
                    });
                    
                    // Âä†ËΩΩËÄÉÂã§ËÆ∞ÂΩï
                    const attendanceSnapshot = await db.collection('users').doc(this.userId)
                        .collection('attendance').get();
                    
                    this.attendanceRecords = [];
                    attendanceSnapshot.forEach(doc => {
                        this.attendanceRecords.push(doc.data());
                    });
                    
                    // Âä†ËΩΩÊó∂Èó¥ÊßΩ
                    const timeSlotsSnapshot = await db.collection('users').doc(this.userId)
                        .collection('timeSlots').get();
                    
                    this.timeSlots = [];
                    if (timeSlotsSnapshot.empty) {
                        // Â¶ÇÊûúÊ≤°ÊúâÊó∂Èó¥ÊßΩÔºåÂàõÂª∫ÈªòËÆ§Êó∂Èó¥ÊßΩ
                        await this.initializeDefaultTimeSlots();
                    } else {
                        timeSlotsSnapshot.forEach(doc => {
                            this.timeSlots.push(doc.data());
                        });
                        // Âä†ËΩΩÂêéÁ´ãÂç≥ÊéíÂ∫è
                        this.sortTimeSlots();
                    }
                    
                    // ÈöêËóèÈ™®Êû∂Â±è
                    hideSkeletons();
                    
                    updateSyncStatus('‚úÖ Data loaded from cloud', 'synced');
                    this.isOnline = true;
                    updateUI();
                    
                } catch (error) {
                    console.error('Error loading from Firestore:', error);
                    updateSyncStatus('‚ùå Error loading data', 'error');
                    hideSkeletons();
                }
            }
            
            // Êó∂Èó¥ÊßΩÊéíÂ∫èÊñπÊ≥ï
            sortTimeSlots() {
                this.timeSlots.sort((a, b) => {
                    return this.getTimeSlotOrder(a.name) - this.getTimeSlotOrder(b.name);
                });
            }
            
            // Ëé∑ÂèñÊó∂Èó¥ÊßΩÁöÑÊéíÂ∫èÂÄº
            getTimeSlotOrder(timeSlotName) {
                // ÂÆö‰πâÊòüÊúüÈ°∫Â∫è
                const dayOrder = {
                    'Monday': 1,
                    'Tuesday': 2,
                    'Wednesday': 3,
                    'Thursday': 4,
                    'Friday': 5,
                    'Saturday': 6,
                    'Sunday': 7
                };
                
                // ÊèêÂèñÊòüÊúüÂá†
                const dayMatch = timeSlotName.match(/(Monday|Tuesday|Wednesday|Thursday|Friday|Saturday|Sunday)/i);
                const day = dayMatch ? dayMatch[0] : '';
                
                // ÊèêÂèñÂºÄÂßãÊó∂Èó¥
                const timeMatch = timeSlotName.match(/(\d{1,2}(?::\d{2})?(?:am|pm))/i);
                let time = timeMatch ? timeMatch[0] : '';
                
                // ËΩ¨Êç¢Êó∂Èó¥‰∏∫24Â∞èÊó∂Ê†ºÂºè‰ª•‰æøÊéíÂ∫è
                let timeValue = 0;
                if (time) {
                    // Â§ÑÁêÜÊó∂Èó¥Ê†ºÂºè
                    time = time.toLowerCase();
                    let [hour, minute = '0'] = time.replace(/[ap]m/, '').split(':');
                    hour = parseInt(hour);
                    minute = parseInt(minute);
                    
                    if (time.includes('pm') && hour !== 12) {
                        hour += 12;
                    }
                    if (time.includes('am') && hour === 12) {
                        hour = 0;
                    }
                    
                    timeValue = hour * 60 + minute;
                }
                
                // ËÆ°ÁÆóÊéíÂ∫èÂÄºÔºöÊòüÊúü * 10000 + Êó∂Èó¥ÔºàÂàÜÈíüÔºâ
                return (dayOrder[day] || 99) * 10000 + timeValue;
            }
            
            // Ê†ºÂºèÂåñÊó•Êúü‰∏∫ DD/MM/YYYY
            formatDate(dateString) {
                if (!dateString) return 'N/A';
                
                try {
                    // Â¶ÇÊûúÊòØ YYYY-MM-DD Ê†ºÂºè
                    if (dateString.includes('-')) {
                        const [year, month, day] = dateString.split('-');
                        return `${day.padStart(2, '0')}/${month.padStart(2, '0')}/${year}`;
                    }
                    
                    // Â¶ÇÊûúÊòØÂÖ∂‰ªñÊ†ºÂºèÔºåÂ∞ùËØïËß£Êûê
                    const date = new Date(dateString);
                    if (isNaN(date.getTime())) {
                        return dateString; // Â¶ÇÊûúÊó†Ê≥ïËß£ÊûêÔºåËøîÂõûÂéüÂ≠óÁ¨¶‰∏≤
                    }
                    
                    const day = date.getDate().toString().padStart(2, '0');
                    const month = (date.getMonth() + 1).toString().padStart(2, '0');
                    const year = date.getFullYear();
                    
                    return `${day}/${month}/${year}`;
                } catch (error) {
                    console.error('Error formatting date:', error);
                    return dateString;
                }
            }
            
            // Ëß£Êûê DD/MM/YYYY Ê†ºÂºèÁöÑÊó•Êúü‰∏∫ YYYY-MM-DD
            parseDate(dateString) {
                if (!dateString) return null;
                
                try {
                    if (dateString.includes('/')) {
                        const [day, month, year] = dateString.split('/').map(Number);
                        if (day && month && year) {
                            return `${year}-${month.toString().padStart(2, '0')}-${day.toString().padStart(2, '0')}`;
                        }
                    }
                    
                    // Â¶ÇÊûúÊòØ YYYY-MM-DD Ê†ºÂºèÔºåÁõ¥Êé•ËøîÂõû
                    if (dateString.includes('-')) {
                        return dateString;
                    }
                } catch (error) {
                    console.error('Error parsing date:', error);
                }
                
                // Â¶ÇÊûúÊó†Ê≥ïËß£ÊûêÔºåËøîÂõûÂéüÂ≠óÁ¨¶‰∏≤
                return dateString;
            }
            
            async initializeDefaultTimeSlots() {
                for (const timeSlot of DEFAULT_TIME_SLOTS) {
                    const timeSlotId = timeSlot.replace(/\s+/g, '-').toLowerCase();
                    const timeSlotData = {
                        id: timeSlotId,
                        name: timeSlot,
                        isDefault: true,
                        createdAt: new Date().toISOString()
                    };
                    
                    await db.collection('users').doc(this.userId).collection('timeSlots')
                        .doc(timeSlotId).set(timeSlotData);
                    
                    this.timeSlots.push(timeSlotData);
                }
                // ÂàùÂßãÂåñÂêéÊéíÂ∫è
                this.sortTimeSlots();
            }
            
            startRealtimeSync() {
                if (!this.userId) return;
                
                // Â≠¶ÁîüÊï∞ÊçÆÂÆûÊó∂ÁõëÂê¨
                db.collection('users').doc(this.userId).collection('students')
                    .onSnapshot((snapshot) => {
                        snapshot.docChanges().forEach((change) => {
                            if (change.type === 'added' || change.type === 'modified') {
                                this.students.set(change.doc.id, change.doc.data());
                            } else if (change.type === 'removed') {
                                this.students.delete(change.doc.id);
                            }
                        });
                        updateUI();
                        updateSyncStatus('‚úÖ Real-time sync active', 'synced');
                    });
                
                // ËÄÉÂã§ËÆ∞ÂΩïÂÆûÊó∂ÁõëÂê¨
                db.collection('users').doc(this.userId).collection('attendance')
                    .onSnapshot((snapshot) => {
                        this.attendanceRecords = snapshot.docs.map(doc => doc.data());
                        updateUI();
                        updateSyncStatus('‚úÖ Real-time sync active', 'synced');
                    });
                
                // Êó∂Èó¥ÊßΩÂÆûÊó∂ÁõëÂê¨
                db.collection('users').doc(this.userId).collection('timeSlots')
                    .onSnapshot((snapshot) => {
                        this.timeSlots = [];
                        snapshot.forEach(doc => {
                            this.timeSlots.push(doc.data());
                        });
                        // ÊØèÊ¨°Êõ¥Êñ∞ÂêéÊéíÂ∫è
                        this.sortTimeSlots();
                        updateUI();
                        updateSyncStatus('‚úÖ Real-time sync active', 'synced');
                    });
            }
            
            async addStudent(name, age, gender, timeSlot, enrolledDate, totalSessions = 48) {
                // Ê£ÄÊü•ÂêåÊó∂Èó¥ÊßΩÊòØÂê¶ÊúâÂêåÂêçÂ≠¶Áîü
                const nameExists = Array.from(this.students.values()).some(
                    student => student.name.trim().toLowerCase() === name.trim().toLowerCase() && 
                              student.timeSlot === timeSlot
                );
                
                if (nameExists) {
                    throw new Error(`A student named "${name}" already exists in this time slot.`);
                }
                
                const studentId = `${name.replace(/\s+/g, '')}-${timeSlot.replace(/\s+/g, '')}-${Date.now()}`;
                const student = {
                    id: studentId,
                    name,
                    age: age || '',
                    gender: gender || '',
                    timeSlot,
                    enrolledDate: enrolledDate || new Date().toISOString().split('T')[0],
                    totalSessions: parseInt(totalSessions) || 48,
                    attendanceCount: 0,
                    attendanceDates: [],
                    createdAt: new Date().toISOString()
                };
                
                if (this.isOnline) {
                    await db.collection('users').doc(this.userId).collection('students')
                        .doc(studentId).set(student);
                } else {
                    this.students.set(studentId, student);
                }
                
                return student;
            }

            async updateStudent(studentId, updatedData) {
                const student = this.students.get(studentId);
                if (!student) {
                    throw new Error('Student not found');
                }
                
                // Â¶ÇÊûú‰øÆÊîπ‰∫ÜÂßìÂêçÊàñÊó∂Èó¥ÊßΩÔºåÊ£ÄÊü•ÊòØÂê¶ÊúâÈáçÂ§ç
                if ((updatedData.name && updatedData.name !== student.name) || 
                    (updatedData.timeSlot && updatedData.timeSlot !== student.timeSlot)) {
                    
                    const name = updatedData.name || student.name;
                    const timeSlot = updatedData.timeSlot || student.timeSlot;
                    
                    const nameExists = Array.from(this.students.values()).some(
                        s => s.id !== studentId && 
                             s.name.trim().toLowerCase() === name.trim().toLowerCase() && 
                             s.timeSlot === timeSlot
                    );
                    
                    if (nameExists) {
                        throw new Error(`A student named "${name}" already exists in this time slot.`);
                    }
                }
                
                const updatedStudent = {
                    ...student,
                    ...updatedData
                };
                
                if (this.isOnline) {
                    await db.collection('users').doc(this.userId).collection('students')
                        .doc(studentId).update(updatedData);
                } else {
                    this.students.set(studentId, updatedStudent);
                }
                
                return updatedStudent;
            }
            
            async recordAttendance(timeSlot, date, topic, presentStudentIds) {
                if (!timeSlot || !date) {
                    throw new Error('Time slot and date are required');
                }
                
                const recordId = `${timeSlot}-${date}`.replace(/[^a-zA-Z0-9]/g, '-');
                
                // Ê£ÄÊü•ÊòØÂê¶Â∑≤ÁªèËÆ∞ÂΩïËøáËøôÂ§©ÁöÑËÄÉÂã§
                const existingRecord = this.attendanceRecords.find(record => 
                    record.timeSlot === timeSlot && record.date === date
                );
                
                if (existingRecord) {
                    // Êèê‰æõ‰øÆÊîπÈÄâÈ°π
                    const modify = confirm(`Attendance for ${timeSlot} on ${this.formatDate(date)} already recorded. Do you want to modify it?`);
                    if (!modify) {
                        return null;
                    }
                    
                    // Âà†Èô§ÂéüÊúâËÆ∞ÂΩï
                    if (this.isOnline) {
                        await db.collection('users').doc(this.userId).collection('attendance')
                            .doc(recordId).delete();
                    } else {
                        this.attendanceRecords = this.attendanceRecords.filter(r => r.id !== recordId);
                    }
                    
                    // ‰ªéÂ≠¶ÁîüËÆ∞ÂΩï‰∏≠ÁßªÈô§ËØ•Êó•ÊúüÁöÑÂá∫Âã§
                    for (const student of this.students.values()) {
                        if (student.attendanceDates && student.attendanceDates.includes(date)) {
                            const updatedDates = student.attendanceDates.filter(d => d !== date);
                            const updatedCount = updatedDates.length;
                            
                            if (this.isOnline) {
                                await db.collection('users').doc(this.userId).collection('students')
                                    .doc(student.id).update({
                                        attendanceCount: updatedCount,
                                        attendanceDates: updatedDates
                                    });
                            } else {
                                student.attendanceCount = updatedCount;
                                student.attendanceDates = updatedDates;
                            }
                        }
                    }
                }
                
                const record = {
                    id: recordId,
                    timeSlot,
                    date,
                    topic: topic || '',
                    presentStudents: presentStudentIds,
                    recordedAt: new Date().toISOString()
                };
                
                // Êõ¥Êñ∞Â≠¶ÁîüËÄÉÂã§Êï∞ÊçÆ
                for (const studentId of presentStudentIds) {
                    const student = this.students.get(studentId);
                    if (student && date >= student.enrolledDate) {
                        
                        // Ê£ÄÊü•ÊòØÂê¶Â∑≤ÁªèËÆ∞ÂΩïËøáËøôÂ§©ÁöÑËÄÉÂã§
                        const alreadyRecorded = student.attendanceDates && 
                                              student.attendanceDates.includes(date);
                        
                        if (!alreadyRecorded) {
                            // ÂàùÂßãÂåñÊï∞ÁªÑÂ¶ÇÊûú‰∏çÂ≠òÂú®
                            if (!student.attendanceDates) {
                                student.attendanceDates = [];
                            }
                            
                            // ÂÆâÂÖ®Âú∞Êõ¥Êñ∞ËÄÉÂã§Êï∞ÊçÆ
                            student.attendanceCount = (student.attendanceCount || 0) + 1;
                            student.attendanceDates.push(date);
                            
                            if (this.isOnline) {
                                await db.collection('users').doc(this.userId).collection('students')
                                    .doc(studentId).update({
                                        attendanceCount: student.attendanceCount,
                                        attendanceDates: student.attendanceDates
                                    });
                            }
                        }
                    }
                }
                
                // ‰øùÂ≠òËÄÉÂã§ËÆ∞ÂΩï
                if (this.isOnline) {
                    await db.collection('users').doc(this.userId).collection('attendance')
                        .doc(recordId).set(record);
                } else {
                    this.attendanceRecords.push(record);
                }
                
                return record;
            }
            
            getStudentAttendance(studentId) {
                const student = this.students.get(studentId);
                if (!student) return null;
                
                // Á°Æ‰øùËÄÉÂã§Êï∞ÊçÆÂ≠òÂú®
                const attendanceDates = student.attendanceDates || [];
                
                // Âè™ËÆ°ÁÆóÂÖ•Â≠¶Êó•Êúü‰πãÂêéÁöÑÂá∫Â∏≠ÔºàÂéªÈáçÔºâ
                const validAttendanceDates = attendanceDates.filter(date => 
                    date >= student.enrolledDate
                );
                const validAttendanceCount = [...new Set(validAttendanceDates)].length; // ÂéªÈáç
                
                // ‰ΩøÁî®Â≠¶ÁîüËá™ÂÆö‰πâÁöÑÊÄªËØæÂ†ÇÊï∞ÔºåÈªòËÆ§‰∏∫48
                const totalSessions = student.totalSessions || 48;
                
                const attendanceRate = totalSessions > 0 ? 
                    (validAttendanceCount / totalSessions * 100).toFixed(1) : 0;
                
                return {
                    ...student,
                    attendanceCount: validAttendanceCount,
                    totalSessions: totalSessions,
                    attendanceRate,
                    recentAttendance: validAttendanceDates.slice(-5)
                };
            }
            
            getStudentsByTimeSlot(timeSlot, searchTerm = '') {
                const students = [];
                for (const student of this.students.values()) {
                    if (timeSlot === 'all' || student.timeSlot === timeSlot) {
                        const studentWithAttendance = this.getStudentAttendance(student.id);
                        
                        // Â¶ÇÊûúÊ≤°ÊúâÊêúÁ¥¢ËØçÊàñËÄÖÂåπÈÖçÊêúÁ¥¢ÔºåÂ∞±ÂåÖÂê´Ëøô‰∏™Â≠¶Áîü
                        if (!searchTerm || this.doesStudentMatchSearch(studentWithAttendance, searchTerm)) {
                            students.push(studentWithAttendance);
                        }
                    }
                }
                return students;
            }

            // ÊêúÁ¥¢ÂåπÈÖçÊñπÊ≥ï
            doesStudentMatchSearch(student, searchTerm) {
                if (!searchTerm) return true;
                
                const term = searchTerm.toLowerCase();
                return (
                    student.name.toLowerCase().includes(term) ||
                    (student.age && student.age.toString().includes(term)) ||
                    (student.gender && student.gender.toLowerCase().includes(term)) ||
                    (student.timeSlot && student.timeSlot.toLowerCase().includes(term)) ||
                    (student.enrolledDate && this.formatDate(student.enrolledDate).toLowerCase().includes(term))
                );
            }
            
            getAllAttendance() {
                const result = [];
                for (const student of this.students.values()) {
                    result.push(this.getStudentAttendance(student.id));
                }
                return result;
            }
            
            getSummary() {
                const totalStudents = this.students.size;
                let totalAttendance = 0;
                let totalPossibleSessions = 0;
                
                for (const student of this.students.values()) {
                    const studentAttendance = this.getStudentAttendance(student.id);
                    totalAttendance += studentAttendance.attendanceCount;
                    totalPossibleSessions += studentAttendance.totalSessions;
                }
                
                const avgAttendanceRate = totalStudents > 0 && totalPossibleSessions > 0 ? 
                    (totalAttendance / totalPossibleSessions * 100).toFixed(1) : 0;
                
                return {
                    totalStudents,
                    totalSessions: this.attendanceRecords.length,
                    totalAttendance,
                    totalPossibleSessions,
                    averageAttendanceRate: avgAttendanceRate,
                    timeSlots: this.timeSlots.length
                };
            }

            // Ëé∑ÂèñËÄÉÂã§Ë∂ãÂäøÊï∞ÊçÆÔºàËøáÂéª6Âë®Ôºâ
            getAttendanceTrendData() {
                const today = new Date();
                const trendData = [];
                
                // Ëé∑ÂèñËøáÂéª6Âë®ÁöÑÊó•ÊúüËåÉÂõ¥
                for (let i = 5; i >= 0; i--) {
                    const endDate = new Date(today);
                    endDate.setDate(today.getDate() - (i * 7));
                    
                    const startDate = new Date(endDate);
                    startDate.setDate(endDate.getDate() - 6);
                    
                    // ËÆ°ÁÆóËØ•Âë®ÁöÑËÄÉÂã§ËÆ∞ÂΩïÊï∞
                    const weekRecords = this.attendanceRecords.filter(record => {
                        const recordDate = new Date(record.date);
                        return recordDate >= startDate && recordDate <= endDate;
                    });
                    
                    // Ê†ºÂºèÂåñÊòæÁ§∫ÁöÑÊó•ÊúüËåÉÂõ¥
                    const startStr = `${startDate.getDate()}/${startDate.getMonth() + 1}`;
                    const endStr = `${endDate.getDate()}/${endDate.getMonth() + 1}`;
                    
                    trendData.push({
                        period: `${startStr}-${endStr}`,
                        sessions: weekRecords.length
                    });
                }
                
                return trendData;
            }
            
            // Ëé∑ÂèñÂêÑÊó∂Èó¥ÊßΩÁöÑÂπ≥ÂùáÂá∫Âã§Áéá
            getTimeSlotAttendanceData() {
                const timeSlotData = [];
                
                this.timeSlots.forEach(timeSlot => {
                    const students = this.getStudentsByTimeSlot(timeSlot.name);
                    if (students.length === 0) return;
                    
                    let totalRate = 0;
                    students.forEach(student => {
                        totalRate += parseFloat(student.attendanceRate);
                    });
                    
                    const avgRate = (totalRate / students.length).toFixed(1);
                    
                    timeSlotData.push({
                        timeSlot: timeSlot.name,
                        avgRate: parseFloat(avgRate),
                        studentCount: students.length
                    });
                });
                
                // ÊåâÂπ≥ÂùáÂá∫Âã§ÁéáÊéíÂ∫è
                return timeSlotData.sort((a, b) => b.avgRate - a.avgRate);
            }

            exportToCSV() {
                let csv = 'Name,Age,Gender,Enrolled Date,Time Slot,Sessions Attended,Total Sessions,Attendance Rate\n';
                for (const student of this.students.values()) {
                    const info = this.getStudentAttendance(student.id);
                    const formattedDate = this.formatDate(student.enrolledDate);
                    csv += `"${student.name}",${student.age || ''},${student.gender || ''},"${formattedDate}","${student.timeSlot}",${info.attendanceCount},${info.totalSessions},${info.attendanceRate}%\n`;
                }
                return csv;
            }

            exportToJSON() {
                const data = {
                    system: {
                        school: "Genius Mind Academy",
                        timeSlots: this.timeSlots,
                        exportDate: new Date().toISOString()
                    },
                    students: Array.from(this.students.values()),
                    attendanceRecords: this.attendanceRecords
                };
                return JSON.stringify(data, null, 2);
            }
            
            // ÊâπÈáèÂØºÂÖ•Â≠¶Áîü
            async importStudentsFromCSV(csvContent) {
                const lines = csvContent.split('\n');
                const results = {
                    success: 0,
                    failed: 0,
                    errors: []
                };
                
                // Ë∑≥ËøáÊ†áÈ¢òË°å
                for (let i = 1; i < lines.length; i++) {
                    const line = lines[i].trim();
                    if (!line) continue;
                    
                    try {
                        // ‰ΩøÁî®Ê≠£ÂàôË°®ËææÂºèÂ§ÑÁêÜÂ∏¶ÂºïÂè∑ÁöÑÂ≠óÊÆµ
                        const regex = /(".*?"|[^",]+)(?=\s*,|\s*$)/g;
                        const matches = line.match(regex);
                        
                        if (!matches || matches.length < 3) {
                            throw new Error('Invalid format');
                        }
                        
                        // Ëß£ÊûêCSVÂ≠óÊÆµ
                        const name = matches[0].replace(/"/g, '').trim();
                        const age = matches[1].replace(/"/g, '').trim() || '';
                        const gender = matches[2].replace(/"/g, '').trim() || '';
                        const timeSlot = matches[3].replace(/"/g, '').trim();
                        const enrolledDate = matches[4] ? matches[4].replace(/"/g, '').trim() : '';
                        const totalSessions = matches[5] ? matches[5].replace(/"/g, '').trim() : 48;
                        
                        // È™åËØÅÂøÖÂ°´Â≠óÊÆµ
                        if (!name || !timeSlot) {
                            throw new Error('Name and time slot are required');
                        }
                        
                        // Ê£ÄÊü•Êó∂Èó¥ÊßΩÊòØÂê¶Â≠òÂú®
                        const timeSlotExists = this.timeSlots.some(ts => ts.name === timeSlot);
                        if (!timeSlotExists) {
                            throw new Error(`Time slot "${timeSlot}" does not exist`);
                        }
                        
                        // Ê£ÄÊü•ÊòØÂê¶Â∑≤Â≠òÂú®ÂêåÂêçÂ≠¶Áîü
                        const nameExists = Array.from(this.students.values()).some(
                            student => student.name.trim().toLowerCase() === name.trim().toLowerCase() && 
                                      student.timeSlot === timeSlot
                        );
                        
                        if (nameExists) {
                            throw new Error(`Student "${name}" already exists in this time slot`);
                        }
                        
                        // Â§ÑÁêÜÊó•ÊúüÊ†ºÂºè
                        let formattedEnrolledDate = enrolledDate;
                        if (enrolledDate && enrolledDate.includes('/')) {
                            formattedEnrolledDate = this.parseDate(enrolledDate);
                        }
                        
                        // Ê∑ªÂä†Â≠¶Áîü
                        await this.addStudent(
                            name,
                            age,
                            gender,
                            timeSlot,
                            formattedEnrolledDate || new Date().toISOString().split('T')[0],
                            totalSessions
                        );
                        
                        results.success++;
                    } catch (error) {
                        results.failed++;
                        results.errors.push(`Line ${i + 1}: ${error.message}`);
                        console.error(`Error importing line ${i + 1}:`, error);
                    }
                }
                
                return results;
            }
            
            // Êó∂Èó¥ÊßΩÁÆ°ÁêÜÊñπÊ≥ï
            async addTimeSlot(name) {
                if (!name) {
                    throw new Error('Time slot name is required');
                }
                
                // Ê£ÄÊü•Êó∂Èó¥ÊßΩÂêçÁß∞ÊòØÂê¶ÈáçÂ§çÔºàÂøΩÁï•Á©∫Ê†ºÂ∑ÆÂºÇÔºâ
                const normalizedName = name.trim().toLowerCase().replace(/\s+/g, '');
                const nameExists = this.timeSlots.some(
                    slot => slot.name.trim().toLowerCase().replace(/\s+/g, '') === normalizedName
                );
                
                if (nameExists) {
                    throw new Error('A time slot with this name already exists');
                }
                
                const timeSlotId = name.replace(/\s+/g, '-').toLowerCase();
                const timeSlot = {
                    id: timeSlotId,
                    name: name,
                    isDefault: false,
                    createdAt: new Date().toISOString()
                };
                
                if (this.isOnline) {
                    await db.collection('users').doc(this.userId).collection('timeSlots')
                        .doc(timeSlotId).set(timeSlot);
                } else {
                    this.timeSlots.push(timeSlot);
                    this.sortTimeSlots();
                }
                
                return timeSlot;
            }
            
            async deleteTimeSlot(timeSlotId) {
                // Ê£ÄÊü•ÊòØÂê¶ÊúâÂ≠¶Áîü‰ΩøÁî®Ëøô‰∏™Êó∂Èó¥ÊßΩ
                const studentsInTimeSlot = Array.from(this.students.values()).filter(
                    student => student.timeSlot === this.getTimeSlotNameById(timeSlotId)
                );
                
                if (studentsInTimeSlot.length > 0) {
                    throw new Error(`Cannot delete time slot. ${studentsInTimeSlot.length} student(s) are assigned to this time slot.`);
                }
                
                if (this.isOnline) {
                    await db.collection('users').doc(this.userId).collection('timeSlots')
                        .doc(timeSlotId).delete();
                } else {
                    this.timeSlots = this.timeSlots.filter(slot => slot.id !== timeSlotId);
                }
                
                return true;
            }
            
            getTimeSlotNameById(timeSlotId) {
                const timeSlot = this.timeSlots.find(slot => slot.id === timeSlotId);
                return timeSlot ? timeSlot.name : '';
            }
        }

        // ÂàõÂª∫Á≥ªÁªüÂÆû‰æã
        const system = new MemoschoolAttendanceSystem();

        // Firebase ËÆ§ËØÅÂäüËÉΩ - ‰ºòÂåñÁâà
        async function login() {
            // ÈáçÁΩÆÈîôËØØÁä∂ÊÄÅ
            document.getElementById('authError').style.display = 'none';
            hideError('emailError');
            hideError('passwordError');
            
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            let isValid = true;
            
            // È™åËØÅ
            if (!email) {
                showError('emailError', 'Please enter your email');
                isValid = false;
            } else if (!isValidEmail(email)) {
                showError('emailError', 'Please enter a valid email');
                isValid = false;
            }
            
            if (!password) {
                showError('passwordError', 'Please enter your password');
                isValid = false;
            } else if (password.length < 6) {
                showError('passwordError', 'Password must be at least 6 characters');
                isValid = false;
            }
            
            if (!isValid) return;
            
            try {
                // ÊòæÁ§∫ÁôªÂΩïÁä∂ÊÄÅ
                updateSyncStatus('üîÑ Signing in...', 'syncing');
                
                // Â∞ùËØïÁôªÂΩï
                const userCredential = await auth.signInWithEmailAndPassword(email, password);
                
                // ÁôªÂΩïÊàêÂäüÂêéÂ§ÑÁêÜ
                showApp(userCredential.user);
                showToast('Login successful!', 'success');
            } catch (error) {
                console.error('Login error:', error);
                
                // ÊòæÁ§∫ÂÖ∑‰ΩìÈîôËØØ‰ø°ÊÅØ
                let errorMessage = 'Login failed. Please try again.';
                if (error.code === 'auth/user-not-found') {
                    errorMessage = 'No account found with this email.';
                } else if (error.code === 'auth/wrong-password') {
                    errorMessage = 'Incorrect password.';
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage = 'Invalid email format.';
                } else if (error.code === 'auth/network-request-failed') {
                    errorMessage = 'Network error. Please check your connection.';
                }
                
                // ÊòæÁ§∫ÈîôËØØ
                document.getElementById('authError').textContent = errorMessage;
                document.getElementById('authError').style.display = 'block';
                updateSyncStatus('‚ùå Login failed', 'error');
            }
        }

        async function signup() {
            // ÈáçÁΩÆÈîôËØØÁä∂ÊÄÅ
            document.getElementById('authError').style.display = 'none';
            hideError('emailError');
            hideError('passwordError');
            
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            let isValid = true;
            
            // È™åËØÅ
            if (!email) {
                showError('emailError', 'Please enter your email');
                isValid = false;
            } else if (!isValidEmail(email)) {
                showError('emailError', 'Please enter a valid email');
                isValid = false;
            }
            
            if (!password) {
                showError('passwordError', 'Please enter your password');
                isValid = false;
            } else if (password.length < 6) {
                showError('passwordError', 'Password must be at least 6 characters');
                isValid = false;
            }
            
            if (!isValid) return;
            
            try {
                // ÊòæÁ§∫Ê≥®ÂÜåÁä∂ÊÄÅ
                updateSyncStatus('üîÑ Creating account...', 'syncing');
                
                // Â∞ùËØïÊ≥®ÂÜå
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                
                // Ê≥®ÂÜåÊàêÂäüÂêéÂ§ÑÁêÜ
                showApp(userCredential.user);
                showToast('Account created successfully!', 'success');
            } catch (error) {
                console.error('Signup error:', error);
                
                // ÊòæÁ§∫ÂÖ∑‰ΩìÈîôËØØ‰ø°ÊÅØ
                let errorMessage = 'Sign up failed. Please try again.';
                if (error.code === 'auth/email-already-in-use') {
                    errorMessage = 'An account with this email already exists.';
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage = 'Invalid email format.';
                } else if (error.code === 'auth/operation-not-allowed') {
                    errorMessage = 'This operation is not allowed.';
                } else if (error.code === 'auth/weak-password') {
                    errorMessage = 'Password is too weak.';
                } else if (error.code === 'auth/network-request-failed') {
                    errorMessage = 'Network error. Please check your connection.';
                }
                
                // ÊòæÁ§∫ÈîôËØØ
                document.getElementById('authError').textContent = errorMessage;
                document.getElementById('authError').style.display = 'block';
                updateSyncStatus('‚ùå Sign up failed', 'error');
            }
        }

        function logout() {
            auth.signOut();
            document.getElementById('loginSection').style.display = 'block';
            document.getElementById('appSection').style.display = 'none';
            updateSyncStatus('üîí Logged out', 'syncing');
            showToast('Logged out successfully', 'info');
        }

        function showApp(user) {
            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('appSection').style.display = 'block';
            document.getElementById('userEmail').textContent = user.email;
            
            // ÂàùÂßãÂåñÁ≥ªÁªü
            system.initialize(user.uid);
        }

        // ÁõëÂê¨ËÆ§ËØÅÁä∂ÊÄÅÂèòÂåñ - ‰ºòÂåñÁâà
        auth.onAuthStateChanged((user) => {
            if (user) {
                // Áî®Êà∑Â∑≤ÁôªÂΩï
                console.log('User is logged in:', user.email);
                showApp(user);
            } else {
                // Áî®Êà∑Êú™ÁôªÂΩï
                console.log('User is logged out');
                document.getElementById('loginSection').style.display = 'block';
                document.getElementById('appSection').style.display = 'none';
            }
        });

        // ÂêåÊ≠•Áä∂ÊÄÅÊõ¥Êñ∞
        function updateSyncStatus(message, type = 'syncing') {
            const statusElement = document.getElementById('syncStatus');
            statusElement.textContent = message;
            statusElement.className = `sync-status ${type}`;
        }

        // ÊòæÁ§∫/ÈöêËóèÈ™®Êû∂Â±è
        function showSkeletons() {
            document.getElementById('studentsSkeleton').style.display = 'block';
            document.getElementById('recordsSkeleton').style.display = 'table-row';
        }

        function hideSkeletons() {
            document.getElementById('studentsSkeleton').style.display = 'none';
            document.getElementById('recordsSkeleton').style.display = 'none';
        }

        // Êõ¥Êñ∞ÊâÄÊúâUIÁªÑ‰ª∂
        function updateUI() {
            updateDashboard();
            updateTimeSlotSelects();
            updateTimeSlotTabs();
            updateStudentsCheckboxes();
            updateAttendanceRecords();
            updateStats();
            updateTimeSlots();
            updateFilterStudent();
            updateTimeSlotsList();
            updateCharts();
        }

        // UI ÂáΩÊï∞
        function showSection(sectionId) {
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            document.getElementById(sectionId).classList.add('active');
            
            // Êõ¥Êñ∞ÁßªÂä®Á´ØÂØºËà™ÊøÄÊ¥ªÁä∂ÊÄÅ
            document.querySelectorAll('.mobile-nav-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.getAttribute('onclick').includes(sectionId)) {
                    btn.classList.add('active');
                }
            });
        }

        // ÊòæÁ§∫/ÈöêËóèÈîôËØØ‰ø°ÊÅØ
        function showError(elementId, message) {
            const element = document.getElementById(elementId);
            if (element) {
                element.textContent = message;
                element.style.display = 'block';
                
                // ‰∏∫Áõ∏ÂÖ≥ËæìÂÖ•Ê°ÜÊ∑ªÂä†ÈîôËØØÊ†∑Âºè
                const inputId = elementId.replace('Error', '');
                const inputElement = document.getElementById(inputId);
                if (inputElement) {
                    inputElement.classList.add('error');
                }
            }
        }

        function hideError(elementId) {
            const element = document.getElementById(elementId);
            if (element) {
                element.textContent = '';
                element.style.display = 'none';
                
                // ÁßªÈô§Áõ∏ÂÖ≥ËæìÂÖ•Ê°ÜÁöÑÈîôËØØÊ†∑Âºè
                const inputId = elementId.replace('Error', '');
                const inputElement = document.getElementById(inputId);
                if (inputElement) {
                    inputElement.classList.remove('error');
                }
            }
        }

        // È™åËØÅÈÇÆÁÆ±Ê†ºÂºè
        function isValidEmail(email) {
            const re = /^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;
            return re.test(email);
        }

        // Êõ¥Êñ∞ÊâÄÊúâÊó∂Èó¥ÊßΩÈÄâÊã©Ê°Ü
        function updateTimeSlotSelects() {
            // Êõ¥Êñ∞Ê∑ªÂä†Â≠¶ÁîüË°®ÂçïÁöÑÊó∂Èó¥ÊßΩÈÄâÊã©Ê°Ü
            const studentTimeSlotSelect = document.getElementById('studentTimeSlot');
            studentTimeSlotSelect.innerHTML = '<option value="">Select Time Slot</option>';
            
            // Êõ¥Êñ∞ÁºñËæëÂ≠¶ÁîüË°®ÂçïÁöÑÊó∂Èó¥ÊßΩÈÄâÊã©Ê°Ü
            const editStudentTimeSlotSelect = document.getElementById('editStudentTimeSlot');
            editStudentTimeSlotSelect.innerHTML = '<option value="">Select Time Slot</option>';
            
            // Êõ¥Êñ∞ËÄÉÂã§ËÆ∞ÂΩïÁöÑÊó∂Èó¥ÊßΩÈÄâÊã©Ê°Ü
            const timeSlotSelect = document.getElementById('timeSlotSelect');
            timeSlotSelect.innerHTML = '<option value="">Select Time Slot</option>';
            
            // Êõ¥Êñ∞ËÄÉÂã§ËÆ∞ÂΩïÁ≠õÈÄâÁöÑÊó∂Èó¥ÊßΩÈÄâÊã©Ê°Ü
            const filterTimeSlotSelect = document.getElementById('filterTimeSlot');
            filterTimeSlotSelect.innerHTML = '<option value="all">All Time Slots</option>';
            
            // Â°´ÂÖÖÊâÄÊúâÈÄâÊã©Ê°ÜÔºàÁ≥ªÁªüÂ∑≤ÁªèÊéíÂ∫è‰∫ÜÊó∂Èó¥ÊßΩÔºâ
            system.timeSlots.forEach(timeSlot => {
                const option = document.createElement('option');
                option.value = timeSlot.name;
                option.textContent = timeSlot.name;
                
                studentTimeSlotSelect.appendChild(option.cloneNode(true));
                editStudentTimeSlotSelect.appendChild(option.cloneNode(true));
                timeSlotSelect.appendChild(option.cloneNode(true));
                
                const filterOption = option.cloneNode(true);
                filterTimeSlotSelect.appendChild(filterOption);
            });
        }

        // Êõ¥Êñ∞Êó∂Èó¥ÊßΩÂàóË°®
        function updateTimeSlotsList() {
            const timeSlotsList = document.getElementById('timeSlotsList');
            timeSlotsList.innerHTML = '';
            
            if (system.timeSlots.length === 0) {
                timeSlotsList.innerHTML = '<p>No time slots found. Add your first time slot above.</p>';
                return;
            }
            
            // Á≥ªÁªüÂ∑≤ÁªèÊéíÂ∫è‰∫ÜÊó∂Èó¥ÊßΩÔºåÁõ¥Êé•‰ΩøÁî®
            system.timeSlots.forEach(timeSlot => {
                const timeSlotItem = document.createElement('div');
                timeSlotItem.className = 'time-slot-item';
                
                timeSlotItem.innerHTML = `
                    <div>
                        <strong>${timeSlot.name}</strong>
                        ${timeSlot.isDefault ? '<span style="color: var(--gray); font-size: 0.9em;"> (Default)</span>' : ''}
                    </div>
                    <div class="time-slot-actions">
                        ${!timeSlot.isDefault ? `<button class="btn btn-warning" onclick="deleteTimeSlot('${timeSlot.id}')">Delete</button>` : ''}
                    </div>
                `;
                
                timeSlotsList.appendChild(timeSlotItem);
            });
        }

        // Ê∑ªÂä†Êó∂Èó¥ÊßΩ
        async function addTimeSlot() {
            const name = document.getElementById('newTimeSlotName').value.trim();
            let isValid = true;
            
            if (!name) {
                showError('newTimeSlotNameError', 'Please enter a time slot name');
                isValid = false;
            } else {
                hideError('newTimeSlotNameError');
            }
            
            if (!isValid) return;
            
            try {
                await system.addTimeSlot(name);
                document.getElementById('newTimeSlotName').value = '';
                showToast('Time slot added successfully!', 'success');
            } catch (error) {
                showError('newTimeSlotNameError', error.message);
                showToast('Error: ' + error.message, 'error');
            }
        }

        // Âà†Èô§Êó∂Èó¥ÊßΩ
        async function deleteTimeSlot(timeSlotId) {
            if (confirm('Are you sure you want to delete this time slot? This action cannot be undone.')) {
                try {
                    await system.deleteTimeSlot(timeSlotId);
                    showToast('Time slot deleted successfully', 'success');
                } catch (error) {
                    showToast('Error: ' + error.message, 'error');
                }
            }
        }

        async function addStudent() {
            const name = document.getElementById('studentName').value.trim();
            const age = document.getElementById('studentAge').value;
            const gender = document.getElementById('studentGender').value;
            const timeSlot = document.getElementById('studentTimeSlot').value;
            const enrolledDate = document.getElementById('studentEnrolledDate').value;
            const totalSessions = document.getElementById('studentTotalSessions').value || 48;
            let isValid = true;
            
            if (!name) {
                showError('studentNameError', 'Please enter student name');
                isValid = false;
            } else {
                hideError('studentNameError');
            }
            
            if (!timeSlot) {
                showError('studentTimeSlotError', 'Please select a time slot');
                isValid = false;
            } else {
                hideError('studentTimeSlotError');
            }
            
            if (!isValid) return;
            
            // Â¶ÇÊûúÊ≤°ÊúâÈÄâÊã©ÂÖ•Â≠¶Êó•ÊúüÔºåÈªòËÆ§‰ΩøÁî®‰ªäÂ§©
            const finalEnrolledDate = enrolledDate || new Date().toISOString().split('T')[0];
            
            try {
                await system.addStudent(name, age, gender, timeSlot, finalEnrolledDate, totalSessions);
                document.getElementById('studentName').value = '';
                document.getElementById('studentAge').value = '';
                document.getElementById('studentGender').value = '';
                document.getElementById('studentTimeSlot').value = '';
                document.getElementById('studentEnrolledDate').value = '';
                document.getElementById('studentTotalSessions').value = '48';
                showToast('Student added successfully!', 'success');
            } catch (error) {
                showError('studentNameError', error.message);
                showToast('Error: ' + error.message, 'error');
            }
        }

        // ÁºñËæëÂ≠¶ÁîüÂáΩÊï∞
        function editStudent(studentId) {
            const student = system.students.get(studentId);
            if (!student) {
                showToast('Student not found!', 'error');
                return;
            }
            
            // Â°´ÂÖÖÁºñËæëË°®Âçï
            document.getElementById('editStudentName').value = student.name;
            document.getElementById('editStudentAge').value = student.age || '';
            document.getElementById('editStudentGender').value = student.gender || '';
            document.getElementById('editStudentTimeSlot').value = student.timeSlot;
            document.getElementById('editStudentEnrolledDate').value = student.enrolledDate || new Date().toISOString().split('T')[0];
            document.getElementById('editStudentTotalSessions').value = student.totalSessions || 48;
            document.getElementById('editStudentId').value = studentId;
            
            // ÊòæÁ§∫ÁºñËæëË°®ÂçïÔºåÈöêËóèÊ∑ªÂä†Ë°®Âçï
            document.getElementById('editStudentForm').style.display = 'block';
            
            // ÊªöÂä®Âà∞ÁºñËæëË°®Âçï
            document.getElementById('editStudentForm').scrollIntoView({ behavior: 'smooth' });
        }

        // Êõ¥Êñ∞Â≠¶ÁîüÂáΩÊï∞
        async function updateStudent() {
            const studentId = document.getElementById('editStudentId').value;
            const name = document.getElementById('editStudentName').value.trim();
            const age = document.getElementById('editStudentAge').value;
            const gender = document.getElementById('editStudentGender').value;
            const timeSlot = document.getElementById('editStudentTimeSlot').value;
            const enrolledDate = document.getElementById('editStudentEnrolledDate').value;
            const totalSessions = document.getElementById('editStudentTotalSessions').value || 48;
            let isValid = true;
            
            if (!name) {
                showError('editStudentNameError', 'Please enter student name');
                isValid = false;
            } else {
                hideError('editStudentNameError');
            }
            
            if (!timeSlot) {
                showError('editStudentTimeSlotError', 'Please select a time slot');
                isValid = false;
            } else {
                hideError('editStudentTimeSlotError');
            }
            
            if (!isValid) return;
            
            try {
                const updatedData = {
                    name,
                    age: age || '',
                    gender: gender || '',
                    timeSlot,
                    enrolledDate: enrolledDate || new Date().toISOString().split('T')[0],
                    totalSessions: parseInt(totalSessions) || 48
                };
                
                await system.updateStudent(studentId, updatedData);
                
                // ÈöêËóèÁºñËæëË°®Âçï
                document.getElementById('editStudentForm').style.display = 'none';
                
                showToast('Student updated successfully!', 'success');
                
            } catch (error) {
                showError('editStudentNameError', error.message);
                showToast('Error updating student: ' + error.message, 'error');
            }
        }

        // ÂèñÊ∂àÁºñËæëÂáΩÊï∞
        function cancelEdit() {
            document.getElementById('editStudentForm').style.display = 'none';
            // Ê∏ÖÁ©∫Ë°®ÂçïÈîôËØØ
            hideError('editStudentNameError');
            hideError('editStudentTimeSlotError');
            showToast('Edit cancelled', 'info');
        }

        async function deleteStudent(studentId) {
            if (confirm('Are you sure you want to delete this student? This will also remove their attendance records.')) {
                try {
                    // ÂÖàÂà†Èô§Â≠¶ÁîüÁöÑËÄÉÂã§ËÆ∞ÂΩï
                    const student = system.students.get(studentId);
                    if (student && student.attendanceDates && student.attendanceDates.length > 0) {
                        // ÊâæÂà∞ÂåÖÂê´ËØ•Â≠¶ÁîüÁöÑÊâÄÊúâËÄÉÂã§ËÆ∞ÂΩï
                        const recordsToDelete = system.attendanceRecords.filter(record => 
                            record.presentStudents && record.presentStudents.includes(studentId)
                        );
                        
                        // Âà†Èô§Ëøô‰∫õËÆ∞ÂΩï
                        for (const record of recordsToDelete) {
                            if (system.isOnline) {
                                await db.collection('users').doc(system.userId).collection('attendance')
                                    .doc(record.id).delete();
                            }
                        }
                    }
                    
                    // ÂÜçÂà†Èô§Â≠¶Áîü
                    if (system.isOnline) {
                        await db.collection('users').doc(system.userId).collection('students')
                            .doc(studentId).delete();
                    } else {
                        system.students.delete(studentId);
                        updateUI();
                    }
                    
                    showToast('Student deleted successfully', 'success');
                } catch (error) {
                    showToast('Error deleting student: ' + error.message, 'error');
                }
            }
        }

        function updateTimeSlotTabs() {
            const tabsContainer = document.getElementById('timeSlotTabs');
            const contentsContainer = document.getElementById('timeSlotContents');
            
            tabsContainer.innerHTML = '';
            contentsContainer.innerHTML = '';
            
            // Ê∑ªÂä†"All Students"Ê†áÁ≠æ
            const allTab = document.createElement('div');
            allTab.className = `time-slot-tab active`;
            allTab.textContent = 'All Students';
            allTab.dataset.timeSlot = 'all';
            allTab.addEventListener('click', function() {
                document.querySelectorAll('.time-slot-tab').forEach(t => {
                    t.classList.remove('active');
                });
                this.classList.add('active');
                document.querySelectorAll('.time-slot-content').forEach(c => {
                    c.classList.remove('active');
                });
                document.getElementById('content-all').classList.add('active');
            });
            tabsContainer.appendChild(allTab);
            
            let firstTab = true;
            
            // Á≥ªÁªüÂ∑≤ÁªèÊéíÂ∫è‰∫ÜÊó∂Èó¥ÊßΩÔºåÁõ¥Êé•‰ΩøÁî®
            for (const timeSlot of system.timeSlots) {
                // ÂàõÂª∫Ê†áÁ≠æ
                const tab = document.createElement('div');
                tab.className = `time-slot-tab ${firstTab ? '' : ''}`;
                tab.textContent = timeSlot.name;
                tab.dataset.timeSlot = timeSlot.name;
                tab.addEventListener('click', function() {
                    // ÁßªÈô§ÊâÄÊúâÊ†áÁ≠æÁöÑactiveÁ±ª
                    document.querySelectorAll('.time-slot-tab').forEach(t => {
                        t.classList.remove('active');
                    });
                    // ‰∏∫ÂΩìÂâçÁÇπÂáªÁöÑÊ†áÁ≠æÊ∑ªÂä†activeÁ±ª
                    this.classList.add('active');
                    
                    // ÈöêËóèÊâÄÊúâÂÜÖÂÆπ
                    document.querySelectorAll('.time-slot-content').forEach(c => {
                        c.classList.remove('active');
                    });
                    // ÊòæÁ§∫ÂØπÂ∫îÁöÑÂÜÖÂÆπ
                    document.getElementById(`content-${timeSlot.id}`).classList.add('active');
                });
                
                tabsContainer.appendChild(tab);
                
                // ÂàõÂª∫ÂÜÖÂÆπ
                const content = document.createElement('div');
                content.id = `content-${timeSlot.id}`;
                content.className = `time-slot-content ${firstTab ? '' : ''}`;
                
                const students = system.getStudentsByTimeSlot(timeSlot.name, currentSearchTerm);
                
                if (students.length === 0) {
                    content.innerHTML = `<div style="text-align: center; padding: 40px; color: var(--gray);">
                        <p style="font-size: 1.2em; margin-bottom:
                                                10px;">No students found</p>
                        <p>Add students to this time slot in the form above.</p>
                    </div>`;
                } else {
                    const grid = createStudentGrid(students);
                    content.appendChild(grid);
                }
                
                contentsContainer.appendChild(content);
                
                firstTab = false;
            }
            
            // ÂàõÂª∫"All Students"ÂÜÖÂÆπ
            const allContent = document.createElement('div');
            allContent.id = 'content-all';
            allContent.className = 'time-slot-content active';
            
            const allStudents = system.getStudentsByTimeSlot('all', currentSearchTerm);
            
            if (allStudents.length === 0) {
                allContent.innerHTML = `<div style="text-align: center; padding: 40px; color: var(--gray);">
                    <p style="font-size: 1.2em; margin-bottom: 10px;">No students found</p>
                    <p>Add your first student using the form above.</p>
                </div>`;
            } else {
                const grid = createStudentGrid(allStudents);
                allContent.appendChild(grid);
            }
            
            contentsContainer.appendChild(allContent);
        }

        // ÂàõÂª∫Â≠¶ÁîüÂç°ÁâáÁΩëÊ†º
        function createStudentGrid(students) {
            const grid = document.createElement('div');
            grid.className = 'student-grid';
            
            // ÊåâÂá∫Âã§Áéá‰ªéÈ´òÂà∞‰ΩéÊéíÂ∫è
            students.sort((a, b) => b.attendanceRate - a.attendanceRate);
            
            students.forEach(student => {
                const card = document.createElement('div');
                card.className = 'student-card-enhanced';
                
                // Ê†πÊçÆÂá∫Âã§ÁéáÁ°ÆÂÆöËøõÂ∫¶Êù°È¢úËâ≤
                let progressClass = 'progress-fill';
                let badgeClass = 'attendance-badge';
                const rate = parseFloat(student.attendanceRate);
                
                if (rate < 70) {
                    progressClass += ' low';
                    badgeClass += ' attendance-low';
                } else if (rate < 90) {
                    progressClass += ' medium';
                    badgeClass += ' attendance-medium';
                }
                
                card.innerHTML = `
                    <div class="student-header">
                        <div>
                            <h3 class="student-name">${student.name}</h3>
                            <div class="student-meta">${student.age || 'N/A'} | ${student.gender || 'N/A'}</div>
                            <div class="student-meta">Time Slot: ${student.timeSlot}</div>
                            <div class="student-meta">Enrolled: ${system.formatDate(student.enrolledDate)}</div>
                        </div>
                        <div class="${badgeClass}">${student.attendanceRate}%</div>
                    </div>
                    
                    <div class="progress-container">
                        <div class="progress-label">
                            <span>Attendance</span>
                            <span>${student.attendanceCount}/${student.totalSessions}</span>
                        </div>
                        <div class="progress-bar">
                            <div class="${progressClass}" style="width: ${student.attendanceRate}%"></div>
                        </div>
                    </div>
                    
                    <div>
                        <strong>Recent Attendance:</strong>
                        <div class="attendance-record">
                            ${student.recentAttendance.map(date => `
                                <div class="attendance-dot present" title="${system.formatDate(date)}">
                                    ‚úì
                                </div>
                            `).join('')}
                            ${Array(5 - student.recentAttendance.length).fill().map(() => `
                                <div class="attendance-dot absent" title="No record">
                                    ‚úó
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    
                    <div class="student-actions">
                        <button class="btn btn-info" style="padding: 6px 12px; font-size: 14px;" 
                            onclick="editStudent('${student.id}')">Edit</button>
                        <button class="btn btn-warning" style="padding: 6px 12px; font-size: 14px;" 
                            onclick="deleteStudent('${student.id}')">Delete</button>
                    </div>
                `;
                
                grid.appendChild(card);
            });
            
            return grid;
        }

        // Êõ¥Êñ∞Â≠¶ÁîüÂ§çÈÄâÊ°Ü
        function updateStudentsCheckboxes() {
            const timeSlot = document.getElementById('timeSlotSelect').value;
            const container = document.getElementById('studentsCheckboxes');
            
            if (!timeSlot) {
                container.innerHTML = '<p>Please select a time slot to see students</p>';
                return;
            }
            
            const students = system.getStudentsByTimeSlot(timeSlot);
            
            if (students.length === 0) {
                container.innerHTML = '<p>No students found in this time slot</p>';
                return;
            }
            
            let html = '';
            students.forEach(student => {
                html += `
                    <label>
                        <input type="checkbox" value="${student.id}" 
                            id="student-${student.id}" class="student-checkbox">
                        ${student.name} (${student.age || 'N/A'})
                    </label>
                `;
            });
            
            container.innerHTML = html;
        }

        // ËÆ∞ÂΩïËÄÉÂã§
        async function recordAttendance() {
            const timeSlot = document.getElementById('timeSlotSelect').value;
            const date = document.getElementById('classDate').value;
            const topic = document.getElementById('sessionTopic').value;
            const presentStudentIds = Array.from(document.querySelectorAll('.student-checkbox:checked'))
                .map(checkbox => checkbox.value);
            
            let isValid = true;
            
            if (!timeSlot) {
                showError('timeSlotSelectError', 'Please select a time slot');
                isValid = false;
            } else {
                hideError('timeSlotSelectError');
            }
            
            if (!date) {
                showError('classDateError', 'Please select a date');
                isValid = false;
            } else {
                // Ê£ÄÊü•ÊòØÂê¶ÈÄâÊã©‰∫ÜÊú™Êù•ÁöÑÊó•Êúü
                const selectedDate = new Date(date);
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                
                if (selectedDate > today) {
                    showError('classDateError', 'Cannot select a future date');
                    isValid = false;
                } else {
                    hideError('classDateError');
                }
            }
            
            if (presentStudentIds.length === 0) {
                showError('presentStudentsError', 'Please select at least one present student');
                isValid = false;
            } else {
                hideError('presentStudentsError');
            }
            
            if (!isValid) return;
            
            try {
                const record = await system.recordAttendance(timeSlot, date, topic, presentStudentIds);
                if (record) {
                    showToast(`Attendance recorded for ${timeSlot} on ${system.formatDate(date)}`, 'success');
                    // ÈáçÁΩÆË°®Âçï
                    document.getElementById('sessionTopic').value = '';
                    document.querySelectorAll('.student-checkbox').forEach(checkbox => {
                        checkbox.checked = false;
                    });
                }
            } catch (error) {
                showToast('Error recording attendance: ' + error.message, 'error');
            }
        }

        // Êõ¥Êñ∞ËÄÉÂã§ËÆ∞ÂΩï
        function updateAttendanceRecords() {
            const container = document.getElementById('attendanceRecords');
            const filterTimeSlot = document.getElementById('filterTimeSlot').value;
            const filterStudent = document.getElementById('filterStudent').value;
            
            let allAttendance = system.getAllAttendance();
            
            // Â∫îÁî®Á≠õÈÄâ
            if (filterTimeSlot !== 'all') {
                allAttendance = allAttendance.filter(item => item.timeSlot === filterTimeSlot);
            }
            
            if (filterStudent !== 'all') {
                allAttendance = allAttendance.filter(item => item.id === filterStudent);
            }
            
            if (allAttendance.length === 0) {
                container.innerHTML = `
                    <tr>
                        <td colspan="9" style="text-align: center; padding: 40px; color: var(--gray);">
                            No attendance records found
                        </td>
                    </tr>
                `;
                return;
            }
            
            // ÊåâÂá∫Âã§Áéá‰ªéÈ´òÂà∞‰ΩéÊéíÂ∫è
            allAttendance.sort((a, b) => b.attendanceRate - a.attendanceRate);
            
            let html = '';
            allAttendance.forEach(student => {
                // Ê†πÊçÆÂá∫Âã§ÁéáÁ°ÆÂÆöÊ†∑Âºè
                let rateClass = '';
                const rate = parseFloat(student.attendanceRate);
                
                if (rate < 70) rateClass = 'text-danger';
                else if (rate < 90) rateClass = 'text-warning';
                else rateClass = 'text-success';
                
                html += `
                    <tr>
                        <td>${student.name}</td>
                        <td>${student.age || 'N/A'}</td>
                        <td>${student.gender || 'N/A'}</td>
                        <td>${system.formatDate(student.enrolledDate)}</td>
                        <td>${student.timeSlot}</td>
                        <td>${student.attendanceCount}</td>
                        <td>${student.totalSessions}</td>
                        <td class="${rateClass}"><strong>${student.attendanceRate}%</strong></td>
                        <td>
                            <div class="attendance-record">
                                ${student.recentAttendance.map(date => `
                                    <div class="attendance-dot present" title="${system.formatDate(date)}">‚úì</div>
                                `).join('')}
                                ${Array(5 - student.recentAttendance.length).fill().map(() => `
                                    <div class="attendance-dot absent" title="No record">‚úó</div>
                                `).join('')}
                            </div>
                        </td>
                    </tr>
                `;
            });
            
            container.innerHTML = html;
        }

        // Êõ¥Êñ∞Â≠¶ÁîüÁ≠õÈÄâ‰∏ãÊãâÊ°Ü
        function updateFilterStudent() {
            const filterStudentSelect = document.getElementById('filterStudent');
            filterStudentSelect.innerHTML = '<option value="all">All Students</option>';
            
            for (const student of system.students.values()) {
                const option = document.createElement('option');
                option.value = student.id;
                option.textContent = student.name;
                filterStudentSelect.appendChild(option);
            }
        }

        // Á≠õÈÄâËÄÉÂã§ËÆ∞ÂΩï
        function filterAttendanceRecords() {
            updateAttendanceRecords();
        }

        // Êõ¥Êñ∞Êó∂Èó¥ÊßΩÈ°µÈù¢
        function updateTimeSlots() {
            const container = document.getElementById('timeSlotsContainer');
            container.innerHTML = '';
            
            if (system.timeSlots.length === 0) {
                container.innerHTML = '<p>No time slots found. Add time slots in the "Manage Time Slots" section.</p>';
                return;
            }
            
            // Á≥ªÁªüÂ∑≤ÁªèÊéíÂ∫è‰∫ÜÊó∂Èó¥ÊßΩÔºåÁõ¥Êé•‰ΩøÁî®
            system.timeSlots.forEach(timeSlot => {
                const students = system.getStudentsByTimeSlot(timeSlot.name);
                
                const timeSlotCard = document.createElement('div');
                timeSlotCard.className = 'time-slot-card';
                
                timeSlotCard.innerHTML = `
                    <div class="time-slot-header">
                        <div class="time-slot-title">${timeSlot.name}</div>
                        <div class="student-count">${students.length} students</div>
                    </div>
                    
                    <div class="time-slot-students">
                        ${students.map(student => `
                            <div class="student-card">
                                <strong>${student.name}</strong>
                                <div>${student.age || 'N/A'} | ${student.gender || 'N/A'}</div>
                                <div>Enrolled: ${system.formatDate(student.enrolledDate)}</div>
                                <div style="margin-top: 8px;">
                                    <small>Attendance: ${student.attendanceRate}%</small>
                                </div>
                            </div>
                        `).join('')}
                        
                        ${students.length === 0 ? `
                            <div style="text-align: center; padding: 20px; color: var(--gray);">
                                No students in this time slot
                            </div>
                        ` : ''}
                    </div>
                `;
                
                container.appendChild(timeSlotCard);
            });
        }

        // Êõ¥Êñ∞ÁªüËÆ°È°µÈù¢
        function updateStats() {
            const summary = system.getSummary();
            const timeSlotData = system.getTimeSlotAttendanceData();
            
            const statsGrid = document.getElementById('statsGrid');
            statsGrid.innerHTML = '';
            
            // Ê∑ªÂä†ÂÖ≥ÈîÆÁªüËÆ°Âç°Áâá
            const stats = [
                { label: 'Total Students', value: summary.totalStudents, icon: 'üë•' },
                { label: 'Total Sessions', value: summary.totalSessions, icon: 'üìÖ' },
                { label: 'Average Attendance', value: `${summary.averageAttendanceRate}%`, icon: 'üìä' },
                { label: 'Total Time Slots', value: summary.timeSlots, icon: '‚è∞' }
            ];
            
            stats.forEach(stat => {
                const card = document.createElement('div');
                card.className = 'stat-card';
                card.innerHTML = `
                    <div class="icon">${stat.icon}</div>
                    <h3>${stat.label}</h3>
                    <div class="number">${stat.value}</div>
                `;
                statsGrid.appendChild(card);
            });
        }

        // Êõ¥Êñ∞‰ª™Ë°®Êùø
        function updateDashboard() {
            const summary = system.getSummary();
            
            document.getElementById('totalStudents').textContent = summary.totalStudents;
            document.getElementById('sessionsRecorded').textContent = summary.totalSessions;
            document.getElementById('avgAttendance').textContent = `${summary.averageAttendanceRate}%`;
            document.getElementById('timeSlotsCount').textContent = summary.timeSlots;
            document.getElementById('timeSlotsCountDashboard').textContent = summary.timeSlots;
            document.getElementById('recordedSessionsCount').textContent = summary.totalSessions;
        }

        // Êõ¥Êñ∞ÂõæË°®
        function updateCharts() {
            // ËÄÉÂã§Ë∂ãÂäøÂõæË°®
            const trendData = system.getAttendanceTrendData();
            const ctx1 = document.getElementById('attendanceTrendChart').getContext('2d');
            
            if (attendanceTrendChart) {
                attendanceTrendChart.destroy();
            }
            
            attendanceTrendChart = new Chart(ctx1, {
                type: 'line',
                data: {
                    labels: trendData.map(item => item.period),
                    datasets: [{
                        label: 'Sessions Recorded',
                        data: trendData.map(item => item.sessions),
                        backgroundColor: 'rgba(230, 126, 34, 0.2)',
                        borderColor: 'rgba(230, 126, 34, 1)',
                        borderWidth: 2,
                        tension: 0.3,
                        pointBackgroundColor: 'rgba(230, 126, 34, 1)'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Attendance Trend (Last 6 Weeks)'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Number of Sessions'
                            }
                        }
                    }
                }
            });
            
            // Êó∂Èó¥ÊßΩÂØπÊØîÂõæË°®
            const timeSlotData = system.getTimeSlotAttendanceData();
            const ctx2 = document.getElementById('timeSlotComparisonChart').getContext('2d');
            
            if (timeSlotComparisonChart) {
                timeSlotComparisonChart.destroy();
            }
            
            timeSlotComparisonChart = new Chart(ctx2, {
                type: 'bar',
                data: {
                    labels: timeSlotData.map(item => item.timeSlot),
                    datasets: [{
                        label: 'Average Attendance Rate',
                        data: timeSlotData.map(item => item.avgRate),
                        backgroundColor: 'rgba(52, 152, 219, 0.7)',
                        borderColor: 'rgba(52, 152, 219, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Attendance by Time Slot'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            title: {
                                display: true,
                                text: 'Attendance Rate (%)'
                            }
                        }
                    }
                }
            });
        }

        // ÂØºÂá∫ÂäüËÉΩ
        function exportToCSV() {
            try {
                document.getElementById('exportProgress').style.display = 'block';
                document.getElementById('exportResult').innerHTML = '';
                
                setTimeout(() => {
                    const csv = system.exportToCSV();
                    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.setAttribute('href', url);
                    a.setAttribute('download', `genius-mind-attendance-${new Date().toISOString().split('T')[0]}.csv`);
                    a.style.visibility = 'hidden';
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    
                    document.getElementById('exportProgress').style.display = 'none';
                    document.getElementById('exportResult').innerHTML = `
                        <div class="sync-status synced">
                            ‚úÖ Export successful! File downloaded.
                        </div>
                    `;
                }, 800); // Ê®°ÊãüÂ§ÑÁêÜÊó∂Èó¥
            } catch (error) {
                document.getElementById('exportProgress').style.display = 'none';
                document.getElementById('exportResult').innerHTML = `
                    <div class="sync-status error">
                        ‚ùå Export failed: ${error.message}
                    </div>
                `;
            }
        }

        function exportToJSON() {
            try {
                document.getElementById('exportProgress').style.display = 'block';
                document.getElementById('exportResult').innerHTML = '';
                
                setTimeout(() => {
                    const json = system.exportToJSON();
                    const blob = new Blob([json], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.setAttribute('href', url);
                    a.setAttribute('download', `genius-mind-attendance-${new Date().toISOString().split('T')[0]}.json`);
                    a.style.visibility = 'hidden';
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    
                    document.getElementById('exportProgress').style.display = 'none';
                    document.getElementById('exportResult').innerHTML = `
                        <div class="sync-status synced">
                            ‚úÖ Export successful! File downloaded.
                        </div>
                    `;
                }, 800); // Ê®°ÊãüÂ§ÑÁêÜÊó∂Èó¥
            } catch (error) {
                document.getElementById('exportProgress').style.display = 'none';
                document.getElementById('exportResult').innerHTML = `
                    <div class="sync-status error">
                        ‚ùå Export failed: ${error.message}
                    </div>
                `;
            }
        }

        function printReport() {
            window.print();
        }

        // ÊêúÁ¥¢ÂäüËÉΩ
        document.getElementById('searchStudents').addEventListener('input', function(e) {
            currentSearchTerm = e.target.value.trim().toLowerCase();
            updateTimeSlotTabs();
        });

        // ÊâπÈáèÂØºÂÖ•Â≠¶Áîü
        document.getElementById('studentFileUpload').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                document.getElementById('fileName').textContent = file.name;
            } else {
                document.getElementById('fileName').textContent = 'No file selected';
            }
        });

        async function importStudents() {
            const fileInput = document.getElementById('studentFileUpload');
            const file = fileInput.files[0];
            
            if (!file) {
                showToast('Please select a CSV file to import', 'warning');
                return;
            }
            
            if (file.type !== 'text/csv' && !file.name.endsWith('.csv')) {
                showToast('Please select a CSV file', 'error');
                return;
            }
            
            try {
                updateSyncStatus('üîÑ Importing students...', 'syncing');
                
                const reader = new FileReader();
                reader.onload = async function(e) {
                    try {
                        const results = await system.importStudentsFromCSV(e.target.result);
                        
                        let message = `Import complete: ${results.success} students added, ${results.failed} failed.`;
                        
                        if (results.errors.length > 0) {
                            message += '\n\nErrors:\n' + results.errors.join('\n');
                        }
                        
                        showToast(message, results.failed > 0 ? 'warning' : 'success');
                        updateSyncStatus('‚úÖ Import completed', 'synced');
                        
                        // ÈáçÁΩÆÊñá‰ª∂ËæìÂÖ•
                        fileInput.value = '';
                        document.getElementById('fileName').textContent = 'No file selected';
                    } catch (error) {
                        showToast('Import failed: ' + error.message, 'error');
                        updateSyncStatus('‚ùå Import failed', 'error');
                    }
                };
                
                reader.readAsText(file);
            } catch (error) {
                showToast('Import failed: ' + error.message, 'error');
                updateSyncStatus('‚ùå Import failed', 'error');
            }
        }

        // ‰∏ãËΩΩCSVÊ®°Êùø
        function downloadTemplate() {
            const csv = 'Name,Age,Gender,Time Slot,Enrolled Date,Total Sessions\n' +
                       '"John Doe",10,Male,"Saturday 9am-10:30am","01/09/2023",48\n' +
                       '"Jane Smith",9,Female,"Sunday 11am-12:30pm","01/09/2023",48';
            
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.setAttribute('href', url);
            a.setAttribute('download', 'student-import-template.csv');
            a.style.visibility = 'hidden';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        // ÊòæÁ§∫ÊèêÁ§∫Ê∂àÊÅØ
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            let icon = '‚úÖ';
            if (type === 'error') icon = '‚ùå';
            else if (type === 'warning') icon = '‚ö†Ô∏è';
            else if (type === 'info') icon = '‚ÑπÔ∏è';
            
            toast.innerHTML = `${icon} ${message}`;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateX(100%)';
                toast.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
                
                setTimeout(() => {
                    document.body.removeChild(toast);
                }, 300);
            }, 5000);
        }

        // ÂàùÂßãÂåñÊó•ÊúüÈÄâÊã©Âô®‰∏∫‰ªäÂ§©
        document.addEventListener('DOMContentLoaded', function() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('classDate').value = today;
            document.getElementById('studentEnrolledDate').value = today;
        });
    </script>
</body>
</html>
