<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <title>Genius Mind Academy Attendance</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    
    <!-- jsPDF for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    
    <!-- Chart.js for better visualizations -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Animate.css for smooth animations -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
    
    <style>
        /* ========== Âü∫Á°ÄÊ†∑Âºè ========== */
        :root {
            --primary: #e67e22;
            --primary-dark: #d35400;
            --secondary: #3498db;
            --success: #27ae60;
            --warning: #f39c12;
            --danger: #e74c3c;
            --info: #17a2b8;
            --light: #f8f9fa;
            --dark: #2c3e50;
            --gray: #6c757d;
            --border: #e9ecef;
            --shadow: 0 4px 6px rgba(0,0,0,0.1);
            --transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 25px 50px rgba(0,0,0,0.15);
            overflow: hidden;
            backdrop-filter: blur(10px);
            transition: var(--transition);
        }
        
        /* ========== Â§¥ÈÉ®Ê†∑Âºè ========== */
        .header {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            padding: 25px 30px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }
        
        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" opacity="0.1"><circle cx="50" cy="50" r="2" fill="white"/></svg>') repeat;
        }
        
        .header h1 {
            font-size: 2.2em;
            margin-bottom: 8px;
            color: white;
            font-weight: 700;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        
        .header p {
            font-size: 1em;
            opacity: 0.9;
            font-weight: 300;
        }
        
        .school-logo {
            position: absolute;
            top: 20px;
            left: 30px;
            width: 60px;
            height: 60px;
            background: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.2em;
            box-shadow: var(--shadow);
            overflow: hidden;
            z-index: 2;
            transition: var(--transition);
        }
        
        .school-logo:hover {
            transform: scale(1.05);
        }
        
        /* ========== ÂØºËà™Ê†∑Âºè ========== */
        .nav {
            background: var(--primary-dark);
            padding: 12px;
            display: flex;
            justify-content: center;
            gap: 6px;
            flex-wrap: wrap;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .nav button {
            background: rgba(255,255,255,0.15);
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: var(--transition);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
            display: flex;
            align-items: center;
            gap: 6px;
            white-space: nowrap;
        }
        
        .nav button:hover {
            background: rgba(255,255,255,0.25);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        /* ========== ÂÜÖÂÆπÂå∫ÂüüÊ†∑Âºè ========== */
        .content {
            padding: 25px;
            min-height: 500px;
            background: #f8f9fa;
        }
        
        .section {
            display: none;
            animation: fadeIn 0.3s ease;
        }
        
        .section.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* ========== Ë°®ÂçïÊ†∑Âºè ========== */
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            color: var(--dark);
            font-size: 0.9em;
        }
        
        .form-input {
            width: 100%;
            padding: 12px 14px;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 15px;
            transition: var(--transition);
            background: white;
            font-family: inherit;
        }
        
        .form-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(230, 126, 34, 0.1);
        }
        
        /* ========== ÊåâÈíÆÊ†∑Âºè ========== */
        .btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 12px 22px;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            gap: 8px;
            box-shadow: var(--shadow);
        }
        
        .btn:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.15);
        }
        
        .btn-secondary {
            background: var(--secondary);
        }
        
        .btn-secondary:hover {
            background: #2980b9;
        }
        
        .btn-warning {
            background: var(--warning);
        }
        
        .btn-warning:hover {
            background: #e68910;
        }
        
        .btn-danger {
            background: var(--danger);
        }
        
        .btn-danger:hover {
            background: #c0392b;
        }
        
        .btn-success {
            background: var(--success);
        }
        
        .btn-success:hover {
            background: #219a52;
        }
        
        .btn-info {
            background: var(--info);
        }
        
        .btn-info:hover {
            background: #138496;
        }
        
        /* ========== Ë°®Ê†ºÊ†∑Âºè ========== */
        .table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            box-shadow: var(--shadow);
            border-radius: 8px;
            overflow: hidden;
            background: white;
        }
        
        .table th, .table td {
            padding: 14px;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }
        
        .table th {
            background: var(--primary);
            color: white;
            font-weight: 600;
            font-size: 0.85em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .table tr:hover {
            background: rgba(230, 126, 34, 0.05);
        }
        
        /* ========== Âç°ÁâáÊ†∑Âºè ========== */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: var(--shadow);
            text-align: center;
            border-left: 4px solid var(--primary);
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }
        
        .stat-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }
        
        .stat-card .number {
            font-size: 2.5em;
            font-weight: bold;
            color: var(--primary);
            line-height: 1;
            margin: 10px 0;
        }
        
        .feature-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 25px;
        }
        
        .feature-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: var(--shadow);
            text-align: center;
            transition: var(--transition);
            border: 1px solid var(--border);
            position: relative;
            overflow: hidden;
        }
        
        .feature-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary), var(--primary-dark));
        }
        
        .feature-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 25px rgba(0,0,0,0.15);
        }
        
        .feature-card .icon {
            font-size: 2.5em;
            margin-bottom: 15px;
            display: block;
        }
        
        /* ========== Â≠¶ÁîüÂç°ÁâáÊ†∑Âºè ========== */
        .student-card-enhanced {
            background: white;
            border-radius: 10px;
            padding: 18px;
            box-shadow: var(--shadow);
            border-left: 4px solid var(--primary);
            transition: var(--transition);
            position: relative;
            cursor: pointer;
        }
        
        .student-card-enhanced:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.12);
        }
        
        /* ========== ËøõÂ∫¶Êù°Ê†∑Âºè ========== */
        .progress-bar {
            height: 6px;
            background: #e9ecef;
            border-radius: 3px;
            overflow: hidden;
            margin: 12px 0;
        }
        
        .progress-fill {
            height: 100%;
            background: var(--success);
            transition: width 0.5s ease;
            border-radius: 3px;
        }
        
        /* ========== ToastÈÄöÁü•Ê†∑Âºè ========== */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            padding: 14px 18px;
            border-radius: 8px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            border-left: 4px solid var(--success);
            z-index: 1000;
            animation: slideInRight 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
            max-width: 320px;
        }
        
        .toast.error {
            border-left-color: var(--danger);
        }
        
        .toast.warning {
            border-left-color: var(--warning);
        }
        
        .toast.info {
            border-left-color: var(--info);
        }
        
        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(100%);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        /* ========== Âä†ËΩΩÂä®Áîª ========== */
        .loading {
            display: inline-block;
            width: 18px;
            height: 18px;
            border: 2px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* ========== ÊµÆÂä®Êìç‰ΩúÊåâÈíÆ ========== */
        .fab {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            border: none;
            box-shadow: 0 6px 20px rgba(0,0,0,0.2);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            z-index: 100;
            transition: var(--transition);
        }
        
        .fab:hover {
            transform: scale(1.1);
            background: var(--primary-dark);
        }
        
        /* ========== ÊêúÁ¥¢Ê°ÜÊ†∑Âºè ========== */
        .search-box {
            position: relative;
            margin-bottom: 20px;
        }
        
        .search-box input {
            padding-left: 40px;
            border-radius: 25px;
            font-size: 14px;
        }
        
        .search-box i {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--gray);
        }
        
        /* ========== Ê†áÁ≠æÈ°µÊ†∑Âºè ========== */
        .tab-container {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--border);
            padding-bottom: 15px;
        }
        
        .tab {
            padding: 10px 18px;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            transition: var(--transition);
            font-weight: 500;
            border: 1px solid var(--border);
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            font-size: 14px;
        }
        
        .tab:hover {
            background: rgba(230, 126, 34, 0.1);
            border-color: var(--primary);
        }
        
        .tab.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }
        
        /* ========== Âç°ÁâáÁΩëÊ†ºÊ†∑Âºè ========== */
        .card-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 18px;
            margin-top: 20px;
        }
        
        /* ========== ÊâπÈáèÊìç‰ΩúÊ†∑Âºè ========== */
        .batch-actions {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .batch-info {
            margin-left: auto;
            color: var(--primary);
            font-weight: bold;
            font-size: 14px;
        }
        
        /* ========== ÊäòÂè†Èù¢ÊùøÊ†∑Âºè ========== */
        .collapse-panel {
            background: white;
            border-radius: 10px;
            margin-bottom: 15px;
            box-shadow: var(--shadow);
            overflow: hidden;
        }
        
        .collapse-header {
            padding: 16px 20px;
            background: #f8f9fa;
            border-bottom: 1px solid var(--border);
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 600;
            transition: var(--transition);
        }
        
        .collapse-header:hover {
            background: #e9ecef;
        }
        
        .collapse-content {
            padding: 20px;
            display: none;
        }
        
        .collapse-content.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }
        
        /* ========== ÂæΩÁ´†Ê†∑Âºè ========== */
        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            background: var(--primary);
            color: white;
        }
        
        .badge-success {
            background: var(--success);
        }
        
        .badge-warning {
            background: var(--warning);
        }
        
        .badge-danger {
            background: var(--danger);
        }
        
        /* ========== Á©∫Áä∂ÊÄÅÊ†∑Âºè ========== */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--gray);
        }
        
        .empty-state i {
            font-size: 48px;
            margin-bottom: 15px;
            opacity: 0.5;
        }
        
        /* ========== Ê®°ÊÄÅÊ°ÜÊ†∑Âºè ========== */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 1000;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            backdrop-filter: blur(5px);
        }
        
        .modal-content {
            background-color: white;
            border-radius: 15px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.15);
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            animation: fadeIn 0.3s ease;
        }
        
        /* ========== ÂêåÊ≠•Áä∂ÊÄÅÊ†∑Âºè ========== */
        .sync-status {
            background: #e8f4fd;
            border-radius: 8px;
            padding: 12px;
            margin: 12px 0;
            text-align: center;
            font-size: 13px;
            font-weight: 500;
            border-left: 4px solid var(--info);
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .sync-status.synced {
            background: #d4edda;
            color: #155724;
            border-left-color: var(--success);
        }
        
        .sync-status.syncing {
            background: #fff3cd;
            color: #856404;
            border-left-color: var(--warning);
        }
        
        .sync-status.error {
            background: #f8d7da;
            color: #721c24;
            border-left-color: var(--danger);
        }
        
        /* ========== Áî®Êà∑‰ø°ÊÅØÊ†∑Âºè ========== */
        .user-info {
            background: linear-gradient(135deg, var(--success), #20c997);
            color: white;
            border-radius: 8px;
            padding: 12px 20px;
            margin: 12px 0;
            text-align: center;
            box-shadow: var(--shadow);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        /* ========== Âø´ÈÄüÁªüËÆ°Ê†∑Âºè ========== */
        .quick-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin: 25px 0;
        }
        
        .quick-stat {
            background: white;
            padding: 18px;
            border-radius: 10px;
            text-align: center;
            box-shadow: var(--shadow);
            transition: var(--transition);
        }
        
        .quick-stat:hover {
            transform: translateY(-2px);
        }
        
        .quick-stat .value {
            font-size: 2em;
            font-weight: bold;
            color: var(--primary);
            line-height: 1;
            margin-bottom: 5px;
        }
        
        .quick-stat .label {
            color: var(--gray);
            font-size: 0.9em;
            font-weight: 500;
        }
        
        /* ========== Ê¨¢ËøéÈù¢ÊùøÊ†∑Âºè ========== */
        .welcome-panel {
            text-align: center;
            padding: 30px 20px;
            background: white;
            border-radius: 12px;
            box-shadow: var(--shadow);
            margin-bottom: 25px;
        }
        
        /* ========== ÊÄßËÉΩ‰ºòÂåñÊ†∑Âºè ========== */
        .performance-optimized {
            will-change: transform;
            backface-visibility: hidden;
        }
        
        /* ========== ÊöóËâ≤Ê®°ÂºèÊ†∑Âºè ========== */
        body.dark-mode {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #f0f0f0;
        }
        
        body.dark-mode .container {
            background: #2d3748;
            color: #f0f0f0;
        }
        
        body.dark-mode .header {
            background: linear-gradient(135deg, #2d3748, #4a5568);
        }
        
        body.dark-mode .nav button {
            background: rgba(255,255,255,0.1);
        }
        
        body.dark-mode .form-input {
            background: #4a5568;
            color: #f0f0f0;
            border-color: #718096;
        }
        
        body.dark-mode .table {
            background: #2d3748;
            color: #f0f0f0;
        }
        
        body.dark-mode .table th {
            background: #4a5568;
        }
        
        body.dark-mode .table tr:hover {
            background: rgba(255,255,255,0.05);
        }
        
        body.dark-mode .feature-card,
        body.dark-mode .stat-card,
        body.dark-mode .quick-stat,
        body.dark-mode .student-card-enhanced,
        body.dark-mode .collapse-panel {
            background: #2d3748;
            color: #f0f0f0;
            border-color: #4a5568;
        }
        
        body.dark-mode .collapse-header {
            background: #4a5568;
            border-color: #718096;
        }
        
        /* ========== ÁßªÂä®Á´Ø‰ºòÂåñÊ†∑Âºè ========== */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            .container {
                border-radius: 15px;
            }
            
            .header {
                padding: 20px;
            }
            
            .header h1 {
                font-size: 1.8em;
            }
            
            .school-logo {
                position: relative;
                top: 0;
                left: 0;
                width: 50px;
                height: 50px;
                margin: 0 auto 10px;
            }
            
            .nav {
                padding: 10px;
                gap: 4px;
                justify-content: flex-start;
                overflow-x: auto;
                white-space: nowrap;
                -webkit-overflow-scrolling: touch;
            }
            
            .nav button {
                padding: 8px 12px;
                font-size: 12px;
            }
            
            .content {
                padding: 18px;
            }
            
            .card-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .feature-cards {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .fab {
                bottom: 20px;
                right: 20px;
                width: 50px;
                height: 50px;
                font-size: 18px;
            }
            
            .table {
                display: block;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            .modal-content {
                max-height: 85vh;
            }
        }
        
        @media (max-width: 480px) {
            .header h1 {
                font-size: 1.5em;
            }
            
            .btn {
                padding: 10px 16px;
                font-size: 14px;
            }
            
            .stat-card {
                padding: 20px;
            }
            
            .stat-card .number {
                font-size: 2em;
            }
            
            .tab {
                padding: 8px 14px;
                font-size: 13px;
            }
        }
        
        /* ========== Âä†ËΩΩÂä®ÁîªÊ†∑Âºè ========== */
        #loadingOverlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 2000;
            justify-content: center;
            align-items: center;
            color: white;
            font-size: 18px;
        }
        
        /* ========== ÊâìÂç∞‰ºòÂåñÊ†∑Âºè ========== */
        @media print {
            .no-print, .fab, .nav {
                display: none !important;
            }
            
            body {
                background: white !important;
                color: black !important;
            }
            
            .container {
                box-shadow: none !important;
                max-width: 100% !important;
            }
        }

        /* ========== Êñ∞Â¢û‰∫∫ÊÄßÂåñÊ†∑Âºè ========== */
        
        /* Êô∫ËÉΩÂä©ÊâãÊ†∑Âºè */
        .ai-assistant {
            position: fixed;
            bottom: 100px;
            right: 30px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            z-index: 1000;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            animation: pulse 2s infinite;
        }
        
        .ai-assistant:hover {
            transform: scale(1.1) rotate(10deg);
            box-shadow: 0 12px 30px rgba(102, 126, 234, 0.6);
        }
        
        .ai-panel {
            position: fixed;
            bottom: 170px;
            right: 30px;
            width: 350px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.2);
            z-index: 1000;
            display: none;
            overflow: hidden;
            transform-origin: bottom right;
            animation: slideUp 0.3s ease;
        }
        
        @keyframes slideUp {
            from { transform: translateY(20px) scale(0.9); opacity: 0; }
            to { transform: translateY(0) scale(1); opacity: 1; }
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(102, 126, 234, 0.7); }
            70% { box-shadow: 0 0 0 15px rgba(102, 126, 234, 0); }
            100% { box-shadow: 0 0 0 0 rgba(102, 126, 234, 0); }
        }
        
        .ai-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .ai-content {
            padding: 20px;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .ai-message {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 15px;
            animation: fadeIn 0.5s ease;
        }
        
        .ai-message.user {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            margin-left: 40px;
        }
        
        .ai-message.system {
            background: linear-gradient(135deg, #f3e5f5 0%, #e1bee7 100%);
            margin-right: 40px;
        }
        
        .ai-input {
            display: flex;
            padding: 15px;
            border-top: 1px solid #eee;
            gap: 10px;
        }
        
        .ai-input input {
            flex: 1;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        
        .ai-input input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        /* Âø´Êç∑ÈîÆÊèêÁ§∫Ê†∑Âºè */
        .shortcut-hint {
            position: absolute;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 12px;
            z-index: 1001;
            pointer-events: none;
            animation: fadeInOut 3s ease-in-out;
        }
        
        @keyframes fadeInOut {
            0%, 100% { opacity: 0; transform: translateY(10px); }
            20%, 80% { opacity: 1; transform: translateY(0); }
        }
        
        /* ÊãñÊãΩÊ†∑Âºè */
        .draggable {
            cursor: grab;
            transition: transform 0.2s ease;
        }
        
        .draggable:active {
            cursor: grabbing;
            transform: scale(1.02);
        }
        
        .drop-zone {
            border: 2px dashed var(--primary);
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            background: rgba(230, 126, 34, 0.05);
            transition: all 0.3s ease;
            margin: 10px 0;
        }
        
        .drop-zone.drag-over {
            background: rgba(230, 126, 34, 0.15);
            border-color: var(--primary-dark);
        }
        
        /* ËØ≠Èü≥ËæìÂÖ•Ê†∑Âºè */
        .voice-input {
            position: relative;
            display: flex;
            align-items: center;
        }
        
        .voice-button {
            background: transparent;
            border: none;
            color: var(--primary);
            cursor: pointer;
            padding: 10px;
            transition: all 0.3s ease;
            border-radius: 50%;
        }
        
        .voice-button.listening {
            animation: pulse 1s infinite;
            background: rgba(230, 126, 34, 0.1);
        }
        
        /* Âçè‰ΩúÊåáÁ§∫Âô® */
        .collaboration-indicator {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 5px 10px;
            background: rgba(52, 152, 219, 0.1);
            border-radius: 15px;
            font-size: 12px;
            margin-left: auto;
        }
        
        .user-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--success);
            animation: blink 2s infinite;
        }
        
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        /* Êô∫ËÉΩÂª∫ËÆÆÂç°Áâá */
        .suggestion-card {
            background: white;
            border-radius: 12px;
            padding: 15px;
            margin: 10px 0;
            border-left: 4px solid var(--info);
            box-shadow: var(--shadow);
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .suggestion-card:hover {
            transform: translateX(5px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
        }
        
        .suggestion-card h4 {
            margin: 0 0 5px 0;
            color: var(--dark);
        }
        
        .suggestion-card p {
            margin: 0;
            color: var(--gray);
            font-size: 14px;
        }
        
        /* Ëá™ÁÑ∂ËØ≠Ë®ÄÊêúÁ¥¢ */
        .natural-search {
            position: relative;
        }
        
        .natural-search-examples {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }
        
        .search-example {
            background: rgba(230, 126, 34, 0.1);
            color: var(--primary);
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .search-example:hover {
            background: rgba(230, 126, 34, 0.2);
        }
        
        /* ‰∏™ÊÄßÂåñËÆæÁΩÆÈù¢Êùø */
        .settings-panel {
            position: fixed;
            top: 0;
            right: -400px;
            width: 400px;
            height: 100vh;
            background: white;
            box-shadow: -5px 0 30px rgba(0,0,0,0.1);
            z-index: 2000;
            transition: right 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            overflow-y: auto;
        }
        
        .settings-panel.open {
            right: 0;
        }
        
        .settings-header {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            padding: 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .settings-content {
            padding: 25px;
        }
        
        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid var(--border);
        }
        
        /* Â¢ûÂº∫ÁöÑÂõæË°®ÂÆπÂô® */
        .chart-container {
            position: relative;
            height: 300px;
            margin: 20px 0;
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: var(--shadow);
        }
        
        /* Âø´Êç∑Êìç‰ΩúÈù¢Êùø */
        .quick-actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
            margin: 20px 0;
        }
        
        .quick-action {
            background: white;
            border: 2px solid var(--border);
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .quick-action:hover {
            border-color: var(--primary);
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .quick-action i {
            font-size: 24px;
            color: var(--primary);
            margin-bottom: 10px;
            display: block;
        }
        
        /* Êô∫ËÉΩÊèêÈÜí */
        .smart-alert {
            position: fixed;
            top: 100px;
            right: 30px;
            width: 300px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            z-index: 1000;
            animation: slideInRight 0.5s ease;
            overflow: hidden;
            border-left: 5px solid var(--warning);
        }
        
        .alert-header {
            background: #fff3cd;
            padding: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            color: #856404;
        }
        
        .alert-content {
            padding: 15px;
        }
        
        /* ÂàáÊç¢ÂºÄÂÖ≥Ê†∑Âºè */
        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }
        
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }
        
        .slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .slider {
            background-color: var(--primary);
        }
        
        input:checked + .slider:before {
            transform: translateX(26px);
        }
        
        /* Ê∏êÂèòÊñáÊú¨ÊïàÊûú */
        .gradient-text {
            background: linear-gradient(135deg, var(--primary), #667eea);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        /* 3DÂç°ÁâáÊïàÊûú */
        .card-3d {
            transform-style: preserve-3d;
            transition: transform 0.5s ease;
        }
        
        .card-3d:hover {
            transform: rotateY(10deg) rotateX(5deg);
        }
        
        /* ÂæÆ‰∫§‰∫íÊèêÁ§∫ */
        .micro-interaction {
            position: absolute;
            pointer-events: none;
            z-index: 10000;
        }
        
        /* ÂìçÂ∫îÂºèÂ≠ó‰Ωì */
        .responsive-text {
            font-size: clamp(14px, 2vw, 18px);
        }
        
        /* ÁéªÁíÉÊÄÅÊïàÊûú */
        .glass-effect {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        /* Ëá™ÂÆö‰πâÊªöÂä®Êù° */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--primary);
            border-radius: 10px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: var(--primary-dark);
        }
        
        body.dark-mode ::-webkit-scrollbar-track {
            background: #4a5568;
        }
        
        body.dark-mode ::-webkit-scrollbar-thumb {
            background: var(--primary);
        }
        
        /* Âπ≥ÊªëËøáÊ∏° */
        * {
            scroll-behavior: smooth;
        }
        
        /* ËÅöÁÑ¶Ê†∑ÂºèÂ¢ûÂº∫ */
        :focus-visible {
            outline: 2px solid var(--primary);
            outline-offset: 2px;
            border-radius: 4px;
        }
        
        /* Êñ∞Â¢ûÂä®ÁîªÊïàÊûú */
        .animate-float {
            animation: float 3s ease-in-out infinite;
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        
        .animate-shake {
            animation: shake 0.5s ease-in-out;
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        
        /* ÁßªÂä®Á´Ø‰ºòÂåñÂ¢ûÂº∫ */
        @media (max-width: 768px) {
            .ai-panel {
                width: 90vw;
                right: 5vw;
                bottom: 150px;
            }
            
            .settings-panel {
                width: 100vw;
                right: -100vw;
            }
            
            .smart-alert {
                width: 90vw;
                right: 5vw;
            }
            
            .quick-actions {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        /* ÊöóËâ≤Ê®°Âºè‰ºòÂåñ */
        body.dark-mode .ai-panel,
        body.dark-mode .suggestion-card,
        body.dark-mode .quick-action,
        body.dark-mode .smart-alert {
            background: #2d3748;
            color: #f0f0f0;
        }
        
        body.dark-mode .ai-message {
            background: #4a5568;
        }
        
        body.dark-mode .ai-input input {
            background: #4a5568;
            color: #f0f0f0;
            border-color: #718096;
        }
        
        /* Êó†Âä®ÁîªÁ±ª */
        .no-animations * {
            animation: none !important;
            transition: none !important;
        }
    </style>
</head>
<body>
    <!-- Êô∫ËÉΩÂä©ÊâãÊåâÈíÆ -->
    <button class="ai-assistant" id="aiAssistant" onclick="toggleAIPanel()">
        <i class="fas fa-robot"></i>
    </button>
    
    <!-- AIÂä©ÊâãÈù¢Êùø -->
    <div class="ai-panel" id="aiPanel">
        <div class="ai-header">
            <i class="fas fa-robot fa-2x"></i>
            <div>
                <h3 style="margin: 0; font-size: 1.2em;">Smart Assistant</h3>
                <p style="margin: 5px 0 0 0; opacity: 0.9; font-size: 0.9em;">How can I help you today?</p>
            </div>
            <button onclick="toggleAIPanel()" style="margin-left: auto; background: none; border: none; color: white; cursor: pointer;">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="ai-content" id="aiContent">
            <div class="ai-message system">
                <strong>Assistant:</strong> Welcome! I can help you manage attendance, generate reports, or answer questions. Try asking:
                <br><br>
                <div class="suggestion-card" onclick="askAI('How many students are absent frequently?')">
                    <h4>üìä Identify frequently absent students</h4>
                    <p>Show students with attendance below 70%</p>
                </div>
                <div class="suggestion-card" onclick="askAI('Generate monthly report')">
                    <h4>üìà Generate monthly report</h4>
                    <p>Create a comprehensive monthly attendance report</p>
                </div>
                <div class="suggestion-card" onclick="askAI('What should I do next?')">
                    <h4>ü§î What should I do next?</h4>
                    <p>Get personalized recommendations</p>
                </div>
            </div>
        </div>
        <div class="ai-input">
            <input type="text" id="aiInput" placeholder="Ask me anything..." onkeypress="handleAIInput(event)">
            <button class="btn" onclick="sendAIMessage()" style="padding: 10px 15px;">
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>
    </div>
    
    <!-- ‰∏™ÊÄßÂåñËÆæÁΩÆÈù¢Êùø -->
    <div class="settings-panel" id="settingsPanel">
        <div class="settings-header">
            <h3 style="margin: 0;"><i class="fas fa-cog"></i> Personal Settings</h3>
            <button onclick="closeSettings()" style="background: none; border: none; color: white; cursor: pointer; font-size: 1.2em;">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="settings-content">
            <div class="setting-item">
                <div>
                    <strong>Quick Actions</strong>
                    <p style="margin: 5px 0 0 0; color: var(--gray); font-size: 0.9em;">Enable quick action buttons</p>
                </div>
                <label class="switch">
                    <input type="checkbox" id="quickActionsToggle" checked onchange="saveSetting('quickActions', this.checked)">
                    <span class="slider"></span>
                </label>
            </div>
            <div class="setting-item">
                <div>
                    <strong>Voice Commands</strong>
                    <p style="margin: 5px 0 0 0; color: var(--gray); font-size: 0.9em;">Enable voice input support</p>
                </div>
                <label class="switch">
                    <input type="checkbox" id="voiceCommandsToggle" onchange="saveSetting('voiceCommands', this.checked)">
                    <span class="slider"></span>
                </label>
            </div>
            <div class="setting-item">
                <div>
                    <strong>Smart Suggestions</strong>
                    <p style="margin: 5px 0 0 0; color: var(--gray); font-size: 0.9em;">Show intelligent suggestions</p>
                </div>
                <label class="switch">
                    <input type="checkbox" id="smartSuggestionsToggle" checked onchange="saveSetting('smartSuggestions', this.checked)">
                    <span class="slider"></span>
                </label>
            </div>
            <div class="setting-item">
                <div>
                    <strong>Animation Effects</strong>
                    <p style="margin: 5px 0 0 0; color: var(--gray); font-size: 0.9em;">Enable smooth animations</p>
                </div>
                <label class="switch">
                    <input type="checkbox" id="animationsToggle" checked onchange="saveSetting('animations', this.checked)">
                    <span class="slider"></span>
                </label>
            </div>
            <div class="setting-item">
                <div>
                    <strong>Default View</strong>
                    <p style="margin: 5px 0 0 0; color: var(--gray); font-size: 0.9em;">Default section on startup</p>
                </div>
                <select id="defaultViewSelect" onchange="saveSetting('defaultView', this.value)" style="padding: 5px 10px; border-radius: 5px; border: 1px solid var(--border);">
                    <option value="dashboard">Dashboard</option>
                    <option value="attendance">Attendance</option>
                    <option value="students">Students</option>
                    <option value="records">Records</option>
                </select>
            </div>
            <div style="margin-top: 30px;">
                <h4>Keyboard Shortcuts</h4>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px;">
                    <div style="background: #f8f9fa; padding: 10px; border-radius: 8px; border: 1px solid var(--border);">
                        <div style="font-weight: bold; color: var(--primary);">Ctrl + S</div>
                        <div style="font-size: 0.9em;">Save/Record</div>
                    </div>
                    <div style="background: #f8f9fa; padding: 10px; border-radius: 8px; border: 1px solid var(--border);">
                        <div style="font-weight: bold; color: var(--primary);">Ctrl + F</div>
                        <div style="font-size: 0.9em;">Search</div>
                    </div>
                    <div style="background: #f8f9fa; padding: 10px; border-radius: 8px; border: 1px solid var(--border);">
                        <div style="font-weight: bold; color: var(--primary);">Ctrl + N</div>
                        <div style="font-size: 0.9em;">New Student</div>
                    </div>
                    <div style="background: #f8f9fa; padding: 10px; border-radius: 8px; border: 1px solid var(--border);">
                        <div style="font-weight: bold; color: var(--primary);">Ctrl + P</div>
                        <div style="font-size: 0.9em;">Print/PDF</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="container performance-optimized">
        <div class="header">
            <div class="school-logo" id="schoolLogo">
                <i class="fas fa-graduation-cap"></i>
            </div>
            <h1>Genius Mind Academy</h1>
            <p>Real-time sync across all devices</p>
        </div>
        
        <!-- Firebase Login Section -->
        <div id="loginSection">
            <div class="login-panel" style="background: white; border-radius: 15px; padding: 30px; margin: 20px auto; text-align: center; box-shadow: var(--shadow); max-width: 400px;">
                <h2 style="margin-bottom: 15px; color: var(--dark);"><i class="fas fa-lock"></i> Login to Sync Data</h2>
                <p style="margin-bottom: 20px; color: var(--gray);">Sign in to automatically sync data across all your devices</p>
                
                <div class="form-group">
                    <div class="search-box">
                        <i class="fas fa-envelope"></i>
                        <input type="email" id="email" placeholder="Email address" class="form-input">
                    </div>
                </div>
                
                <div class="form-group">
                    <div class="search-box">
                        <i class="fas fa-key"></i>
                        <input type="password" id="password" placeholder="Password" class="form-input">
                    </div>
                </div>
                
                <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                    <button class="btn" onclick="login()" style="flex: 1;">
                        <i class="fas fa-sign-in-alt"></i> Login
                    </button>
                    <button class="btn btn-secondary" onclick="signup()" style="flex: 1;">
                        <i class="fas fa-user-plus"></i> Sign Up
                    </button>
                </div>
                
                <p style="margin-top: 15px; font-size: 14px; color: var(--gray);">
                    <i class="fas fa-info-circle"></i> Don't have an account? Click Sign Up to create one
                </p>
                
                <!-- Test Mode Button -->
                <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px; border: 1px solid var(--border);">
                    <p style="margin-bottom: 10px; color: var(--gray); font-size: 14px;">
                        <i class="fas fa-exclamation-triangle"></i> If having login issues, use test mode:
                    </p>
                    <button onclick="skipLoginForTesting()" style="background: var(--info); color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; width: 100%; font-size: 14px;">
                        <i class="fas fa-vial"></i> Test Mode (Skip Login)
                    </button>
                </div>
            </div>
        </div>

        <div id="appSection" style="display: none;">
            <div class="user-info">
                <span><i class="fas fa-user"></i> Welcome, <strong id="userEmail"></strong></span>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <div class="collaboration-indicator">
                        <i class="fas fa-users"></i>
                        <span>1 online</span>
                        <div class="user-dot"></div>
                    </div>
                    <button class="btn btn-warning" onclick="logout()" style="padding: 6px 12px; font-size: 13px;">
                        <i class="fas fa-sign-out-alt"></i> Logout
                    </button>
                </div>
            </div>
            
            <div class="nav">
                <button onclick="showSection('dashboard')" data-tooltip="Overview"><i class="fas fa-chart-bar"></i><span class="mobile-hide"> Dashboard</span></button>
                <button onclick="showSection('students')" data-tooltip="Manage Students"><i class="fas fa-users"></i><span class="mobile-hide"> Students</span></button>
                <button onclick="showSection('attendance')" data-tooltip="Record Attendance"><i class="fas fa-clipboard-check"></i><span class="mobile-hide"> Attendance</span></button>
                <button onclick="showSection('records')" data-tooltip="View Records"><i class="fas fa-history"></i><span class="mobile-hide"> Records</span></button>
                <button onclick="showSection('timeslots')" data-tooltip="Time Slots"><i class="fas fa-clock"></i><span class="mobile-hide"> Time Slots</span></button>
                <button onclick="showSection('tools')" data-tooltip="System Tools"><i class="fas fa-tools"></i><span class="mobile-hide"> Tools</span></button>
                <button onclick="showSection('exports')" data-tooltip="Export Data"><i class="fas fa-download"></i><span class="mobile-hide"> Export</span></button>
                <button onclick="toggleDarkMode()" data-tooltip="Toggle Dark Mode">
                    <i class="fas fa-moon"></i>
                </button>
                <button onclick="openSettings()" data-tooltip="Personal Settings">
                    <i class="fas fa-user-cog"></i>
                </button>
            </div>
            
            <div class="content">
                <!-- Sync Status Display -->
                <div class="sync-status" id="syncStatus">
                    <i class="fas fa-sync-alt fa-spin"></i>
                    <span>Connecting to database...</span>
                </div>

                <!-- Dashboard -->
                <div id="dashboard" class="section active">
                    <div class="welcome-panel">
                        <h2 class="gradient-text">Welcome back! <span id="timeGreeting">Good morning</span></h2>
                        <p style="margin: 10px 0 20px;">Your data is automatically synced across all devices in real-time</p>
                        
                        <!-- Êñ∞Â¢ûÂø´Êç∑Êìç‰ΩúÈù¢Êùø -->
                        <div class="quick-actions" id="quickActionsPanel">
                            <div class="quick-action" onclick="quickRecordAttendance()">
                                <i class="fas fa-clipboard-check"></i>
                                <div>Quick Record</div>
                            </div>
                            <div class="quick-action" onclick="showSection('students'); addStudentFromSuggestion()">
                                <i class="fas fa-user-plus"></i>
                                <div>Add Student</div>
                            </div>
                            <div class="quick-action" onclick="showSection('exports'); generateQuickReport()">
                                <i class="fas fa-chart-pie"></i>
                                <div>Quick Report</div>
                            </div>
                            <div class="quick-action" onclick="showSection('tools'); runSystemHealthCheck()">
                                <i class="fas fa-heartbeat"></i>
                                <div>Health Check</div>
                            </div>
                        </div>
                        
                        <div class="quick-stats">
                            <div class="quick-stat card-3d">
                                <div class="value" id="totalStudents">0</div>
                                <div class="label">Total Students</div>
                            </div>
                            <div class="quick-stat card-3d">
                                <div class="value" id="sessionsRecorded">0</div>
                                <div class="label">Sessions Recorded</div>
                            </div>
                            <div class="quick-stat card-3d">
                                <div class="value" id="avgAttendance">0%</div>
                                <div class="label">Average Attendance</div>
                            </div>
                            <div class="quick-stat card-3d">
                                <div class="value" id="timeSlotsCountDashboard">0</div>
                                <div class="label">Time Slots</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Êñ∞Â¢ûÂõæË°®Â±ïÁ§∫ -->
                    <div class="stats-grid">
                        <div class="stat-card">
                            <h3>Attendance Trend</h3>
                            <div class="chart-container">
                                <canvas id="attendanceTrendChart"></canvas>
                            </div>
                        </div>
                        <div class="stat-card">
                            <h3>Student Distribution</h3>
                            <div class="chart-container">
                                <canvas id="studentDistributionChart"></canvas>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Êô∫ËÉΩÊèêÈÜíÂå∫Âüü -->
                    <div id="smartAlertsContainer" style="margin-top: 25px;"></div>
                    
                    <div class="feature-cards">
                        <div class="feature-card">
                            <div class="icon"><i class="fas fa-clipboard-check"></i></div>
                            <h3>Record Attendance</h3>
                            <p>Mark attendance for specific time slots and dates with our intuitive interface.</p>
                            <button class="btn" onclick="showSection('attendance')">
                                <i class="fas fa-play-circle"></i> Record Now
                            </button>
                        </div>
                        <div class="feature-card">
                            <div class="icon"><i class="fas fa-users"></i></div>
                            <h3>Manage Students</h3>
                            <p>Add students with detailed information and assign them to appropriate time slots.</p>
                            <button class="btn" onclick="showSection('students')">
                                <i class="fas fa-cog"></i> Manage Students
                            </button>
                        </div>
                        <div class="feature-card">
                            <div class="icon"><i class="fas fa-clock"></i></div>
                            <h3>Time Slots</h3>
                            <p>View students grouped by their class time slots for better organization.</p>
                            <button class="btn" onclick="showSection('timeslots')">
                                <i class="fas fa-eye"></i> View Time Slots
                            </button>
                        </div>
                        <div class="feature-card">
                            <div class="icon"><i class="fas fa-tools"></i></div>
                            <h3>System Tools</h3>
                            <p>Fix data issues, clean duplicates, and optimize system performance.</p>
                            <button class="btn" onclick="showSection('tools')">
                                <i class="fas fa-wrench"></i> Open Tools
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Student Management -->
                <div id="students" class="section">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2><i class="fas fa-users"></i> Student Management</h2>
                        <button class="btn" onclick="showAddStudentForm()">
                            <i class="fas fa-plus"></i> Add Student
                        </button>
                    </div>
                    
                    <!-- Ê∑ªÂä†ÊãñÊãΩÂå∫ÂüüËØ¥Êòé -->
                    <div class="drop-zone" id="timeSlotDropZone" ondragover="handleDragOver(event)" ondrop="handleDrop(event)" ondragleave="handleDragLeave(event)">
                        <i class="fas fa-hand-pointer fa-2x" style="margin-bottom: 10px; color: var(--primary);"></i>
                        <h3>Drag & Drop Students</h3>
                        <p>Drag students here to change their time slots</p>
                        <div id="dropPreview" style="display: none; margin-top: 15px; padding: 10px; background: rgba(230, 126, 34, 0.1); border-radius: 8px;"></div>
                    </div>
                    
                    <!-- Batch Operations -->
                    <div class="collapse-panel">
                        <div class="collapse-header" onclick="toggleCollapse('batchActions')">
                            <span><i class="fas fa-layer-group"></i> Batch Operations</span>
                            <i class="fas fa-chevron-down"></i>
                        </div>
                        <div class="collapse-content" id="batchActions">
                            <div class="batch-actions">
                                <button class="btn btn-secondary" onclick="selectAllStudents()">
                                    <i class="fas fa-check-square"></i> Select All
                                </button>
                                <button class="btn btn-secondary" onclick="deselectAllStudents()">
                                    <i class="fas fa-square"></i> Deselect All
                                </button>
                                <button class="btn btn-info" onclick="openDateSelectionForBatch()">
                                    <i class="fas fa-calendar-plus"></i> Batch Add Dates
                                </button>
                                <button class="btn btn-success" onclick="generateBatchPDFReport()">
                                    <i class="fas fa-file-pdf"></i> Batch PDF
                                </button>
                                <div class="batch-info">
                                    <span id="selectedCount">Selected: 0 students</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Ëá™ÁÑ∂ËØ≠Ë®ÄÊêúÁ¥¢ -->
                    <div class="form-group search-box natural-search">
                        <label class="form-label"><i class="fas fa-search"></i> Search Students</label>
                        <div class="voice-input">
                            <input type="text" id="searchStudents" class="form-input" placeholder="Search by name, age, gender, or time slot...">
                            <button class="voice-button" onclick="startVoiceInputFor('searchStudents')">
                                <i class="fas fa-microphone"></i>
                            </button>
                        </div>
                        <div class="natural-search-examples">
                            <span class="search-example" onclick="processNaturalQuery('students with low attendance')">low attendance</span>
                            <span class="search-example" onclick="processNaturalQuery('males in Saturday class')">Saturday males</span>
                            <span class="search-example" onclick="processNaturalQuery('students aged 12-14')">aged 12-14</span>
                        </div>
                    </div>
                    
                    <!-- Add Student Form (Initially Hidden) -->
                    <div id="addStudentForm" class="collapse-panel" style="display: none;">
                        <div class="collapse-header" onclick="toggleCollapse('addStudentContent')">
                            <span><i class="fas fa-user-plus"></i> Add New Student</span>
                            <i class="fas fa-chevron-down"></i>
                        </div>
                        <div class="collapse-content active" id="addStudentContent">
                            <div class="form-group">
                                <label class="form-label">Student Name</label>
                                <div class="voice-input">
                                    <input type="text" id="studentName" class="form-input" placeholder="Enter student name">
                                    <button class="voice-button" onclick="startVoiceInputFor('studentName')">
                                        <i class="fas fa-microphone"></i>
                                    </button>
                                </div>
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                <div class="form-group">
                                    <label class="form-label">Age</label>
                                    <input type="number" id="studentAge" class="form-input" placeholder="Age" min="5" max="30">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Gender</label>
                                    <select id="studentGender" class="form-input">
                                        <option value="">Select Gender</option>
                                        <option value="Male">Male</option>
                                        <option value="Female">Female</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Time Slot</label>
                                <select id="studentTimeSlot" class="form-input">
                                    <option value="">Select Time Slot</option>
                                </select>
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                <div class="form-group">
                                    <label class="form-label">Enrolled Date</label>
                                    <input type="date" id="studentEnrolledDate" class="form-input">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Total Sessions</label>
                                    <input type="number" id="studentTotalSessions" class="form-input" value="48" min="1" max="200">
                                </div>
                            </div>
                            <div class="batch-actions">
                                <button class="btn btn-success" onclick="addStudent()">
                                    <i class="fas fa-save"></i> Save Student
                                </button>
                                <button class="btn btn-secondary" onclick="hideAddStudentForm()">
                                    <i class="fas fa-times"></i> Cancel
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Edit Student Form -->
                    <div id="editStudentForm" class="collapse-panel" style="display: none;">
                        <div class="collapse-header">
                            <span><i class="fas fa-edit"></i> Edit Student</span>
                            <button class="btn btn-secondary" onclick="cancelEdit()" style="padding: 4px 8px; font-size: 12px;">
                                <i class="fas fa-times"></i> Cancel
                            </button>
                        </div>
                        <div class="collapse-content active">
                            <div class="form-group">
                                <label class="form-label">Student Name</label>
                                <div class="voice-input">
                                    <input type="text" id="editStudentName" class="form-input" placeholder="Enter student name">
                                    <button class="voice-button" onclick="startVoiceInputFor('editStudentName')">
                                        <i class="fas fa-microphone"></i>
                                    </button>
                                </div>
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                <div class="form-group">
                                    <label class="form-label">Age</label>
                                    <input type="number" id="editStudentAge" class="form-input" placeholder="Age" min="5" max="30">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Gender</label>
                                    <select id="editStudentGender" class="form-input">
                                        <option value="">Select Gender</option>
                                        <option value="Male">Male</option>
                                        <option value="Female">Female</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Time Slot</label>
                                <select id="editStudentTimeSlot" class="form-input">
                                    <option value="">Select Time Slot</option>
                                </select>
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                <div class="form-group">
                                    <label class="form-label">Enrolled Date</label>
                                    <input type="date" id="editStudentEnrolledDate" class="form-input">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Total Sessions</label>
                                    <input type="number" id="editStudentTotalSessions" class="form-input" min="1" max="200">
                                </div>
                            </div>
                            <input type="hidden" id="editStudentId">
                            <div class="batch-actions">
                                <button class="btn" onclick="updateStudent()">
                                    <i class="fas fa-save"></i> Update Student
                                </button>
                                <button class="btn btn-danger" onclick="deleteStudent(document.getElementById('editStudentId').value)">
                                    <i class="fas fa-trash"></i> Delete Student
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Student List Tabs -->
                    <div class="tab-container" id="timeSlotTabs"></div>
                    <div id="timeSlotContents"></div>
                </div>
                
                <!-- Record Attendance -->
                <div id="attendance" class="section">
                    <h2><i class="fas fa-clipboard-check"></i> Record Attendance</h2>
                    <div class="card-grid">
                        <div class="feature-card">
                            <div class="form-group">
                                <label class="form-label"><i class="fas fa-clock"></i> Select Time Slot</label>
                                <select id="timeSlotSelect" class="form-input" onchange="updateStudentsCheckboxes()">
                                    <option value="">Select Time Slot</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label"><i class="fas fa-calendar"></i> Date</label>
                                <input type="date" id="classDate" class="form-input">
                            </div>
                            <div class="form-group">
                                <label class="form-label"><i class="fas fa-book"></i> Session Topic (Optional)</label>
                                <div class="voice-input">
                                    <input type="text" id="sessionTopic" class="form-input" placeholder="Enter session topic">
                                    <button class="voice-button" onclick="startVoiceInputFor('sessionTopic')">
                                        <i class="fas fa-microphone"></i>
                                    </button>
                                </div>
                            </div>
                            <button class="btn btn-success" onclick="recordAttendance()" style="width: 100%;">
                                <i class="fas fa-check-circle"></i> Record Attendance
                            </button>
                            <p style="margin-top: 10px; font-size: 12px; color: var(--gray); text-align: center;">
                                <i class="fas fa-keyboard"></i> Press <strong>Q</strong> for quick record
                            </p>
                        </div>
                        
                        <div class="feature-card" style="grid-column: span 2;">
                            <label class="form-label"><i class="fas fa-user-check"></i> Select Present Students</label>
                            <div class="checkbox-group" id="studentsCheckboxes" style="max-height: 400px; overflow-y: auto; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                                <p class="empty-state">
                                    <i class="fas fa-users"></i><br>
                                    Please select a time slot to see students
                                </p>
                            </div>
                            <div class="batch-actions" style="margin-top: 15px;">
                                <button class="btn btn-secondary" onclick="selectAllCheckboxes()">
                                    <i class="fas fa-check-square"></i> Select All
                                </button>
                                <button class="btn btn-secondary" onclick="deselectAllCheckboxes()">
                                    <i class="fas fa-square"></i> Deselect All
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Attendance Records -->
                <div id="records" class="section">
                    <h2><i class="fas fa-history"></i> Attendance Records</h2>
                    
                    <div class="tab-container">
                        <div class="tab active" onclick="showRecordTab('classRecords')">
                            <i class="fas fa-calendar-alt"></i> Class Records
                        </div>
                        <div class="tab" onclick="showRecordTab('studentRecords')">
                            <i class="fas fa-user-graduate"></i> Student Summary
                        </div>
                    </div>
                    
                    <!-- Class Attendance Records -->
                    <div id="classRecords" class="tab-content active">
                        <div class="feature-card">
                            <div class="form-group">
                                <label class="form-label">Filter by Time Slot</label>
                                <select id="classFilterTimeSlot" class="form-input" onchange="updateClassAttendanceRecords()">
                                    <option value="all">All Time Slots</option>
                                </select>
                            </div>
                            
                            <div style="overflow-x: auto;">
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th>Date</th>
                                            <th>Time Slot</th>
                                            <th>Topic</th>
                                            <th>Present</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="classAttendanceRecords"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Student Attendance Summary -->
                    <div id="studentRecords" class="tab-content" style="display: none;">
                        <div class="feature-card">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                                <div class="form-group">
                                    <label class="form-label">Filter by Time Slot</label>
                                    <select id="studentFilterTimeSlot" class="form-input" onchange="updateStudentAttendanceSummary()">
                                        <option value="all">All Time Slots</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Filter by Student</label>
                                    <select id="studentFilterStudent" class="form-input" onchange="updateStudentAttendanceSummary()">
                                        <option value="all">All Students</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div style="overflow-x: auto;">
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th>Name</th>
                                            <th>Age</th>
                                            <th>Gender</th>
                                            <th>Time Slot</th>
                                            <th>Attended</th>
                                            <th>Total</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="studentAttendanceSummary"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Time Slots -->
                <div id="timeslots" class="section">
                    <h2><i class="fas fa-clock"></i> Time Slots</h2>
                    <p>Students grouped by their class time slots.</p>
                    <div id="timeSlotsContainer"></div>
                </div>

                <!-- Tools Section -->
                <div id="tools" class="section">
                    <h2><i class="fas fa-tools"></i> System Tools</h2>
                    <p>Use these tools to fix data issues and optimize system performance.</p>
                    
                    <div class="card-grid">
                        <div class="feature-card">
                            <h3><i class="fas fa-exclamation-triangle"></i> System Health</h3>
                            <p>Run a comprehensive check of system data integrity and performance.</p>
                            <button class="btn btn-info" onclick="runSystemHealthCheck()">
                                <i class="fas fa-heartbeat"></i> Run Health Check
                            </button>
                            <div id="healthCheckResult" style="margin-top: 15px; font-size: 14px;"></div>
                        </div>
                        
                        <div class="feature-card">
                            <h3><i class="fas fa-copy"></i> Fix Duplicate Attendance</h3>
                            <p>Scan and remove duplicate attendance dates for all students.</p>
                            <button class="btn btn-warning" onclick="fixDuplicateAttendance()">
                                <i class="fas fa-search"></i> Scan & Fix
                            </button>
                            <p style="margin-top: 10px; font-size: 13px; color: var(--gray);">
                                Last checked: <span id="lastDuplicateCheck">Never</span>
                            </p>
                        </div>
                        
                        <div class="feature-card">
                            <h3><i class="fas fa-calculator"></i> Recalculate Attendance</h3>
                            <p>Recalculate attendance counts based on actual attendance records.</p>
                            <button class="btn" onclick="recalculateAllAttendance()">
                                <i class="fas fa-redo"></i> Recalculate
                            </button>
                        </div>
                        
                        <div class="feature-card">
                            <h3><i class="fas fa-broom"></i> Clean Orphaned Data</h3>
                            <p>Remove attendance records that have no corresponding students.</p>
                            <button class="btn btn-secondary" onclick="cleanOrphanedData()">
                                <i class="fas fa-trash-alt"></i> Clean Data
                            </button>
                        </div>
                        
                        <div class="feature-card">
                            <h3><i class="fas fa-globe"></i> Fix Timezone Issues</h3>
                            <p>Fix dates that appear one day off due to timezone differences.</p>
                            <button class="btn btn-warning" onclick="DateFixer.fixAllDates()">
                                <i class="fas fa-clock"></i> Fix Timezone
                            </button>
                            <p style="margin-top: 10px; font-size: 13px; color: var(--gray);">
                                Timezone offset: <span id="timezoneOffset">0</span> minutes
                            </p>
                        </div>
                        
                        <div class="feature-card">
                            <h3><i class="fas fa-database"></i> Backup & Restore</h3>
                            <p>Create a backup of all data or restore from a previous backup.</p>
                            <div class="batch-actions" style="margin-top: 10px;">
                                <button class="btn btn-info" onclick="backupData()">
                                    <i class="fas fa-download"></i> Backup
                                </button>
                                <button class="btn btn-secondary" onclick="restoreData()">
                                    <i class="fas fa-upload"></i> Restore
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Data Export -->
                <div id="exports" class="section">
                    <h2><i class="fas fa-download"></i> Data Export</h2>
                    <div class="feature-card">
                        <h3>Export Options</h3>
                        <p>Export your data in various formats for reporting and analysis.</p>
                        
                        <div class="batch-actions" style="margin-top: 20px;">
                            <button class="btn" onclick="exportToCSV()">
                                <i class="fas fa-file-csv"></i> Export to CSV
                            </button>
                            <button class="btn" onclick="exportToJSON()">
                                <i class="fas fa-file-code"></i> Export to JSON
                            </button>
                            <button class="btn btn-success" onclick="printReport()">
                                <i class="fas fa-print"></i> Print Report
                            </button>
                            <button class="btn btn-info" onclick="generateQuickReport()">
                                <i class="fas fa-chart-line"></i> Quick Report
                            </button>
                        </div>
                        
                        <div id="exportResult" style="margin-top: 20px;"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ÊµÆÂä®Êìç‰ΩúÊåâÈíÆ -->
    <button class="fab" id="fabButton" onclick="quickRecordAttendance()">
        <i class="fas fa-plus"></i>
    </button>

    <!-- Student Details Modal -->
    <div id="studentDetailsModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding: 20px 20px 0;">
                <h3 style="margin: 0; font-size: 1.3em; color: var(--dark);">
                    <i class="fas fa-user-graduate"></i> Student Details
                </h3>
                <button class="btn" onclick="closeStudentDetails()" style="padding: 8px 12px; background: var(--gray);">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div style="padding: 0 20px 20px;">
                <div id="studentDetailsContent">
                    <!-- Content will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Date Selection Calendar Modal -->
    <div id="dateSelectionModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div style="padding: 20px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3 id="dateSelectionTitle" style="margin: 0;">Select Attendance Dates</h3>
                    <button class="btn" onclick="closeDateSelectionModal()" style="padding: 8px 12px; background: var(--gray);">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <div id="calendarContainer">
                    <!-- Calendar will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <!-- ËØ≠Èü≥ËæìÂÖ•ÁïåÈù¢ -->
    <div id="voiceInputOverlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 3000; justify-content: center; align-items: center;">
        <div style="background: white; padding: 40px; border-radius: 20px; text-align: center; max-width: 400px;">
            <div class="animate-float" style="font-size: 48px; color: var(--primary); margin-bottom: 20px;">
                <i class="fas fa-microphone"></i>
            </div>
            <h3 style="margin-bottom: 10px;">Listening...</h3>
            <p id="voiceInputText" style="margin-bottom: 20px; font-style: italic;">Speak now</p>
            <button class="btn btn-danger" onclick="stopVoiceInput()">
                <i class="fas fa-stop"></i> Stop Listening
            </button>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 2000; justify-content: center; align-items: center; color: white; font-size: 18px;">
        <div style="text-align: center;">
            <div class="loading" style="width: 40px; height: 40px; border-width: 4px; margin: 0 auto 15px;"></div>
            <div id="loadingMessage">Loading...</div>
        </div>
    </div>

    <!-- Êô∫ËÉΩÊèêÈÜíÈÄöÁü•ÂÆπÂô® -->
    <div id="smartAlertContainer" style="position: fixed; top: 100px; right: 30px; z-index: 1000;"></div>

    <script>
        // ========== ÊÄßËÉΩ‰ºòÂåñÂáΩÊï∞ ==========
        // Èò≤ÊäñÂáΩÊï∞
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }
        
        // ËäÇÊµÅÂáΩÊï∞
        function throttle(func, limit) {
            let inThrottle;
            return function(...args) {
                if (!inThrottle) {
                    func.apply(this, args);
                    inThrottle = true;
                    setTimeout(() => inThrottle = false, limit);
                }
            };
        }
        
        // DOMÁºìÂ≠ò
        const domCache = {};
        
        // ÊòæÁ§∫Âä†ËΩΩÂä®Áîª
        function showLoading(message = 'Loading...') {
            const overlay = document.getElementById('loadingOverlay');
            const messageEl = document.getElementById('loadingMessage');
            messageEl.textContent = message;
            overlay.style.display = 'flex';
        }
        
        // ÈöêËóèÂä†ËΩΩÂä®Áîª
        function hideLoading() {
            const overlay = document.getElementById('loadingOverlay');
            overlay.style.display = 'none';
        }
        
        // ÂàáÊç¢ÊöóËâ≤Ê®°Âºè
        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            localStorage.setItem('darkMode', document.body.classList.contains('dark-mode'));
        }
        
        // ========== Firebase ÈÖçÁΩÆ ==========
        const firebaseConfig = {
            apiKey: "AIzaSyB-enIolDzqs9sVcbB2Rxu7o86L5q7Kd7E",
            authDomain: "memoschool-kuching.firebaseapp.com",
            projectId: "memoschool-kuching",
            storageBucket: "memoschool-kuching.firebasestorage.app",
            messagingSenderId: "815724557443",
            appId: "1:815724557443:web:4033c1d71ef7e339fa97b6",
            measurementId: "G-KM0MJ80MN9"
        };

        // ÂàùÂßãÂåñ Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        // ========== ÂÖ®Â±ÄÂèòÈáè ==========
        const DEFAULT_TIME_SLOTS = [
            "Friday 2pm-3:30pm",
            "Saturday 9am-10:30am", 
            "Saturday 11am-12:30pm",
            "Saturday 2pm-4pm",
            "Sunday 9am-10:30am",
            "Sunday 11am-12:30pm",
            "Sunday 4pm-5:30pm"
        ];

        let currentSearchTerm = '';
        let currentSelectedStudentId = '';
        let selectedDates = new Set();
        let currentCalendarDate = new Date();
        let dateSelectionMode = '';
        let dateSelectionStudentId = '';
        let dateSelectionStudentIds = [];

        // ========== Á≥ªÁªüÁ±ª ==========
        class MemoschoolAttendanceSystem {
            constructor() {
                this.students = new Map();
                this.attendanceRecords = [];
                this.timeSlots = [];
                this.userId = null;
                this.isOnline = false;
            }
            
            async initialize(userId) {
                this.userId = userId;
                await this.loadFromFirestore();
                this.startRealtimeSync();
            }
            
            async loadFromFirestore() {
                if (!this.userId) return;
                
                try {
                    updateSyncStatus('üîÑ Loading data from cloud...', 'syncing');
                    
                    // Load students data
                    const studentsSnapshot = await db.collection('users').doc(this.userId)
                        .collection('students').get();
                    
                    this.students.clear();
                    studentsSnapshot.forEach(doc => {
                        this.students.set(doc.id, doc.data());
                    });
                    
                    // Load attendance records
                    const attendanceSnapshot = await db.collection('users').doc(this.userId)
                        .collection('attendance').get();
                    
                    this.attendanceRecords = [];
                    attendanceSnapshot.forEach(doc => {
                        this.attendanceRecords.push(doc.data());
                    });
                    
                    // Load time slots
                    const timeSlotsSnapshot = await db.collection('users').doc(this.userId)
                        .collection('timeSlots').get();
                    
                    this.timeSlots = [];
                    if (timeSlotsSnapshot.empty) {
                        // If no time slots, create default ones
                        await this.initializeDefaultTimeSlots();
                    } else {
                        timeSlotsSnapshot.forEach(doc => {
                            this.timeSlots.push(doc.data());
                        });
                        // Sort immediately after loading
                        this.sortTimeSlots();
                    }
                    
                    updateSyncStatus('‚úÖ Data loaded from cloud', 'synced');
                    this.isOnline = true;
                    updateUI();
                    
                } catch (error) {
                    console.error('Error loading from Firestore:', error);
                    updateSyncStatus('‚ùå Error loading data', 'error');
                }
            }
            
            // Time slot sorting method
            sortTimeSlots() {
                this.timeSlots.sort((a, b) => {
                    return this.getTimeSlotOrder(a.name) - this.getTimeSlotOrder(b.name);
                });
            }
            
            // Get time slot order value
            getTimeSlotOrder(timeSlotName) {
                // Define day order
                const dayOrder = {
                    'Monday': 1,
                    'Tuesday': 2,
                    'Wednesday': 3,
                    'Thursday': 4,
                    'Friday': 5,
                    'Saturday': 6,
                    'Sunday': 7
                };
                
                // Extract day of week
                const dayMatch = timeSlotName.match(/(Monday|Tuesday|Wednesday|Thursday|Friday|Saturday|Sunday)/i);
                const day = dayMatch ? dayMatch[0] : '';
                
                // Extract start time
                const timeMatch = timeSlotName.match(/(\d{1,2}(?::\d{2})?(?:am|pm))/i);
                let time = timeMatch ? timeMatch[0] : '';
                
                // Convert time to 24-hour format for sorting
                let timeValue = 0;
                if (time) {
                    // Process time format
                    time = time.toLowerCase();
                    let [hour, minute = '0'] = time.replace(/[ap]m/, '').split(':');
                    hour = parseInt(hour);
                    minute = parseInt(minute);
                    
                    if (time.includes('pm') && hour !== 12) {
                        hour += 12;
                    }
                    if (time.includes('am') && hour === 12) {
                        hour = 0;
                    }
                    
                    timeValue = hour * 60 + minute;
                }
                
                // Calculate sort value: day * 10000 + time (minutes)
                return (dayOrder[day] || 99) * 10000 + timeValue;
            }
            
            // Format date to local string
            formatLocalDate(date) {
                if (!date || !(date instanceof Date) || isNaN(date.getTime())) {
                    const today = new Date();
                    const year = today.getFullYear();
                    const month = String(today.getMonth() + 1).padStart(2, '0');
                    const day = String(today.getDate()).padStart(2, '0');
                    return `${year}-${month}-${day}`;
                }
                
                // Use local time, not UTC
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            }
            
            // Convert various inputs to local date string
            getLocalDateString(dateInput) {
                // Handle various date input formats
                if (!dateInput) {
                    return this.formatLocalDate(new Date());
                }
                
                if (dateInput instanceof Date) {
                    return this.formatLocalDate(dateInput);
                }
                
                // If string, try to parse
                if (typeof dateInput === 'string') {
                    // If YYYY-MM-DD format, return directly
                    if (/^\d{4}-\d{2}-\d{2}$/.test(dateInput)) {
                        return dateInput;
                    }
                    
                    // If DD/MM/YYYY format, convert
                    if (/^\d{2}\/\d{2}\/\d{4}$/.test(dateInput)) {
                        const [day, month, year] = dateInput.split('/');
                        return `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
                    }
                    
                    // Try to parse other formats
                    const date = new Date(dateInput);
                    if (!isNaN(date.getTime())) {
                        return this.formatLocalDate(date);
                    }
                }
                
                // If can't parse, return today
                return this.formatLocalDate(new Date());
            }
            
            // Format stored date string (YYYY-MM-DD) to DD/MM/YYYY for display
            formatDateForDisplay(dateString) {
                if (!dateString) return 'N/A';
                
                // Ensure date is local time
                const localDateStr = this.getLocalDateString(dateString);
                const [year, month, day] = localDateStr.split('-');
                
                return `${day}/${month}/${year}`;
            }
            
            // Compatibility with existing formatDate method
            formatDate(dateString) {
                return this.formatDateForDisplay(dateString);
            }
            
            // Parse DD/MM/YYYY format date to YYYY-MM-DD
            parseDate(dateString) {
                return this.getLocalDateString(dateString);
            }
            
            async initializeDefaultTimeSlots() {
                for (const timeSlot of DEFAULT_TIME_SLOTS) {
                    const timeSlotId = timeSlot.replace(/\s+/g, '-').toLowerCase();
                    const timeSlotData = {
                        id: timeSlotId,
                        name: timeSlot,
                        isDefault: true,
                        createdAt: new Date().toISOString()
                    };
                    
                    await db.collection('users').doc(this.userId).collection('timeSlots')
                        .doc(timeSlotId).set(timeSlotData);
                    
                    this.timeSlots.push(timeSlotData);
                }
                // Sort after initialization
                this.sortTimeSlots();
            }
            
            startRealtimeSync() {
                if (!this.userId) return;
                
                // Real-time listener for students data
                db.collection('users').doc(this.userId).collection('students')
                    .onSnapshot((snapshot) => {
                        snapshot.docChanges().forEach((change) => {
                            if (change.type === 'added' || change.type === 'modified') {
                                this.students.set(change.doc.id, change.doc.data());
                            } else if (change.type === 'removed') {
                                this.students.delete(change.doc.id);
                            }
                        });
                        updateUI();
                        updateSyncStatus('‚úÖ Real-time sync active', 'synced');
                    });
                
                // Real-time listener for attendance records
                db.collection('users').doc(this.userId).collection('attendance')
                    .onSnapshot((snapshot) => {
                        this.attendanceRecords = snapshot.docs.map(doc => doc.data());
                        updateUI();
                        updateSyncStatus('‚úÖ Real-time sync active', 'synced');
                    });
                
                // Real-time listener for time slots
                db.collection('users').doc(this.userId).collection('timeSlots')
                    .onSnapshot((snapshot) => {
                        this.timeSlots = [];
                        snapshot.forEach(doc => {
                            this.timeSlots.push(doc.data());
                        });
                        // Sort after each update
                        this.sortTimeSlots();
                        updateUI();
                        updateSyncStatus('‚úÖ Real-time sync active', 'synced');
                    });
            }
            
            async addStudent(name, age, gender, timeSlot, enrolledDate, totalSessions = 48) {
                if (!name || !timeSlot) {
                    throw new Error('Student name and time slot are required');
                }
                
                const studentId = `${name.replace(/\s+/g, '')}-${timeSlot.replace(/\s+/g, '')}-${Date.now()}`;
                const student = {
                    id: studentId,
                    name,
                    age: age || '',
                    gender: gender || '',
                    timeSlot,
                    enrolledDate: this.getLocalDateString(enrolledDate) || this.getLocalDateString(new Date()),
                    totalSessions: parseInt(totalSessions) || 48,
                    attendanceCount: 0,
                    attendanceDates: [],
                    createdAt: new Date().toISOString()
                };
                
                if (this.isOnline) {
                    await db.collection('users').doc(this.userId).collection('students')
                        .doc(studentId).set(student);
                } else {
                    this.students.set(studentId, student);
                }
                
                return student;
            }

            async updateStudent(studentId, updatedData) {
                const student = this.students.get(studentId);
                if (!student) {
                    throw new Error('Student not found');
                }
                
                const updatedStudent = {
                    ...student,
                    ...updatedData
                };
                
                if (this.isOnline) {
                    await db.collection('users').doc(this.userId).collection('students')
                        .doc(studentId).update(updatedData);
                } else {
                    this.students.set(studentId, updatedStudent);
                }
                
                return updatedStudent;
            }
            
            async recordAttendance(timeSlot, date, topic, presentStudentIds) {
                if (!timeSlot || !date) {
                    throw new Error('Time slot and date are required');
                }
                
                // Use local date string
                const localDate = this.getLocalDateString(date);
                const recordId = `${timeSlot}-${localDate}`.replace(/[^a-zA-Z0-9]/g, '-');
                
                // Check if attendance for this day has already been recorded
                const existingRecord = this.attendanceRecords.find(record => 
                    record.timeSlot === timeSlot && record.date === localDate
                );
                
                if (existingRecord) {
                    throw new Error(`Attendance for ${timeSlot} on ${this.formatDate(localDate)} already recorded`);
                }
                
                const record = {
                    id: recordId,
                    timeSlot,
                    date: localDate,
                    topic: topic || '',
                    presentStudents: presentStudentIds,
                    recordedAt: new Date().toISOString()
                };
                
                // Update student attendance data with duplicate prevention
                for (const studentId of presentStudentIds) {
                    const student = this.students.get(studentId);
                    if (student && localDate >= student.enrolledDate) {
                        
                        // Check if attendance for this day has already been recorded
                        const alreadyRecorded = student.attendanceDates && 
                                              student.attendanceDates.includes(localDate);
                        
                        if (!alreadyRecorded) {
                            // Initialize array if it doesn't exist
                            if (!student.attendanceDates) {
                                student.attendanceDates = [];
                            }
                            
                            // Add date and remove duplicates
                            student.attendanceDates.push(localDate);
                            
                            // Remove duplicates
                            const uniqueDates = [...new Set(student.attendanceDates)];
                            student.attendanceDates = uniqueDates;
                            student.attendanceCount = uniqueDates.length;
                            
                            if (this.isOnline) {
                                await db.collection('users').doc(this.userId).collection('students')
                                    .doc(studentId).update({
                                        attendanceDates: uniqueDates,
                                        attendanceCount: uniqueDates.length
                                    });
                            }
                        }
                    }
                }
                
                // Save attendance record
                if (this.isOnline) {
                    await db.collection('users').doc(this.userId).collection('attendance')
                        .doc(recordId).set(record);
                } else {
                    this.attendanceRecords.push(record);
                }
                
                return record;
            }
            
            getStudentAttendance(studentId) {
                const student = this.students.get(studentId);
                if (!student) return null;
                
                // Ensure attendance data exists
                const attendanceDates = student.attendanceDates || [];
                
                // Remove duplicates if any
                const uniqueDates = [...new Set(attendanceDates)];
                
                // Only count attendance after enrollment date
                const validAttendanceDates = uniqueDates.filter(date => 
                    date >= student.enrolledDate
                );
                
                // Fix: Automatically clean duplicates and update database
                if (uniqueDates.length !== attendanceDates.length) {
                    student.attendanceDates = uniqueDates;
                    student.attendanceCount = uniqueDates.length;
                    
                    // Async update to database
                    if (this.isOnline) {
                        db.collection('users').doc(system.userId).collection('students')
                            .doc(studentId).update({
                                attendanceDates: uniqueDates,
                                attendanceCount: uniqueDates.length
                            }).catch(console.error);
                    }
                }
                
                // Fix: Use validAttendanceDates instead of uniqueDates for actual attendance
                const validAttendanceCount = validAttendanceDates.length;
                
                // Use student's custom total sessions, default to 48
                const totalSessions = student.totalSessions || 48;
                
                // Fix: Ensure attendanceCount matches actual attendance dates
                if (student.attendanceCount !== validAttendanceCount) {
                    student.attendanceCount = validAttendanceCount;
                    
                    // Async update to database
                    if (this.isOnline) {
                        db.collection('users').doc(this.userId).collection('students')
                            .doc(studentId).update({
                                attendanceCount: validAttendanceCount
                            }).catch(console.error);
                    }
                }
                
                return {
                    ...student,
                    attendanceCount: validAttendanceCount,
                    totalSessions: totalSessions,
                    recentAttendance: validAttendanceDates.slice(-5)
                };
            }
            
            getStudentsByTimeSlot(timeSlot, searchTerm = '') {
                const students = [];
                for (const student of this.students.values()) {
                    if (timeSlot === 'all' || student.timeSlot === timeSlot) {
                        const studentWithAttendance = this.getStudentAttendance(student.id);
                        
                        // Include student if no search term or if matches search
                        if (!searchTerm || this.doesStudentMatchSearch(studentWithAttendance, searchTerm)) {
                            students.push(studentWithAttendance);
                        }
                    }
                }
                return students;
            }

            // Add search matching method
            doesStudentMatchSearch(student, searchTerm) {
                if (!searchTerm) return true;
                
                const term = searchTerm.toLowerCase();
                return (
                    student.name.toLowerCase().includes(term) ||
                    (student.age && student.age.toString().includes(term)) ||
                    (student.gender && student.gender.toLowerCase().includes(term)) ||
                    (student.timeSlot && student.timeSlot.toLowerCase().includes(term)) ||
                    (student.enrolledDate && student.enrolledDate.toLowerCase().includes(term))
                );
            }
            
            getAllAttendance() {
                const result = [];
                for (const student of this.students.values()) {
                    result.push(this.getStudentAttendance(student.id));
                }
                return result;
            }
            
            getSummary() {
                const totalStudents = this.students.size;
                let totalAttendance = 0;
                let totalPossibleSessions = 0;
                
                for (const student of this.students.values()) {
                    const studentAttendance = this.getStudentAttendance(student.id);
                    totalAttendance += studentAttendance.attendanceCount;
                    totalPossibleSessions += studentAttendance.totalSessions;
                }
                
                const avgAttendanceRate = totalStudents > 0 && totalPossibleSessions > 0 ? 
                    (totalAttendance / totalPossibleSessions * 100).toFixed(1) : 0;
                
                return {
                    totalStudents,
                    totalSessions: this.attendanceRecords.length,
                    totalAttendance,
                    totalPossibleSessions,
                    averageAttendanceRate: avgAttendanceRate,
                    timeSlots: this.timeSlots.length
                };
            }

            exportToCSV() {
                let csv = 'Name,Age,Gender,Enrolled Date,Time Slot,Sessions Attended,Total Sessions,Attendance Dates\n';
                for (const student of this.students.values()) {
                    const info = this.getStudentAttendance(student.id);
                    const formattedDate = this.formatDateForDisplay(student.enrolledDate);
                    const attendanceDates = student.attendanceDates ? student.attendanceDates.map(date => this.formatDateForDisplay(date)).join('; ') : '';
                    csv += `"${student.name}",${student.age},${student.gender},"${formattedDate}","${student.timeSlot}",${info.attendanceCount},${info.totalSessions},"${attendanceDates}"\n`;
                }
                return csv;
            }

            exportToJSON() {
                const data = {
                    system: {
                        school: "Genius Mind Academy",
                        timeSlots: this.timeSlots
                    },
                    students: Array.from(this.students.values()),
                    attendanceRecords: this.attendanceRecords
                };
                return JSON.stringify(data, null, 2);
            }
            
            // Time slot management methods
            async addTimeSlot(name) {
                if (!name) {
                    throw new Error('Time slot name is required');
                }
                
                const timeSlotId = name.replace(/\s+/g, '-').toLowerCase();
                const timeSlot = {
                    id: timeSlotId,
                    name: name,
                    isDefault: false,
                    createdAt: new Date().toISOString()
                };
                
                if (this.isOnline) {
                    await db.collection('users').doc(this.userId).collection('timeSlots')
                        .doc(timeSlotId).set(timeSlot);
                } else {
                    this.timeSlots.push(timeSlot);
                    this.sortTimeSlots();
                }
                
                return timeSlot;
            }
            
            async deleteTimeSlot(timeSlotId) {
                // Check if any students are using this time slot
                const studentsInTimeSlot = Array.from(this.students.values()).filter(
                    student => student.timeSlot === this.getTimeSlotNameById(timeSlotId)
                );
                
                if (studentsInTimeSlot.length > 0) {
                    throw new Error(`Cannot delete time slot. ${studentsInTimeSlot.length} student(s) are assigned to this time slot.`);
                }
                
                if (this.isOnline) {
                    await db.collection('users').doc(this.userId).collection('timeSlots')
                        .doc(timeSlotId).delete();
                } else {
                    this.timeSlots = this.timeSlots.filter(slot => slot.id !== timeSlotId);
                }
                
                return true;
            }
            
            getTimeSlotNameById(timeSlotId) {
                const timeSlot = this.timeSlots.find(slot => slot.id === timeSlotId);
                return timeSlot ? timeSlot.name : '';
            }
            
            // Fix duplicate attendance dates for all students
            async fixDuplicateAttendance() {
                let fixedCount = 0;
                
                for (const [studentId, student] of this.students.entries()) {
                    if (!student.attendanceDates || student.attendanceDates.length === 0) {
                        continue;
                    }
                    
                    // Remove duplicates
                    const uniqueDates = [...new Set(student.attendanceDates)];
                    
                    // If duplicates were found
                    if (uniqueDates.length !== student.attendanceDates.length) {
                        // Update student data
                        student.attendanceDates = uniqueDates;
                        student.attendanceCount = uniqueDates.length;
                        
                        // Update database
                        if (this.isOnline) {
                            try {
                                await db.collection('users').doc(this.userId).collection('students')
                                    .doc(studentId).update({
                                        attendanceDates: uniqueDates,
                                        attendanceCount: uniqueDates.length
                                    });
                                fixedCount++;
                            } catch (error) {
                                console.error(`Error fixing student ${student.name}:`, error);
                            }
                        }
                    }
                }
                
                return fixedCount;
            }
            
            // Recalculate attendance based on actual records
            async recalculateAllAttendance() {
                let recalculatedCount = 0;
                
                // Create a map of attendance by student
                const attendanceByStudent = new Map();
                
                // Group attendance by student
                for (const record of this.attendanceRecords) {
                    for (const studentId of record.presentStudents) {
                        if (!attendanceByStudent.has(studentId)) {
                            attendanceByStudent.set(studentId, new Set());
                        }
                        attendanceByStudent.get(studentId).add(record.date);
                    }
                }
                
                // Update each student
                for (const [studentId, student] of this.students.entries()) {
                    const attendedDates = attendanceByStudent.get(studentId) || new Set();
                    const uniqueDates = [...attendedDates];
                    
                    // Update student data
                    student.attendanceDates = uniqueDates;
                    student.attendanceCount = uniqueDates.length;
                    
                    // Update database
                    if (this.isOnline) {
                        try {
                            await db.collection('users').doc(this.userId).collection('students')
                                .doc(studentId).update({
                                    attendanceDates: uniqueDates,
                                    attendanceCount: uniqueDates.length
                                });
                            recalculatedCount++;
                        } catch (error) {
                            console.error(`Error recalculating student ${student.name}:`, error);
                        }
                    }
                }
                
                return recalculatedCount;
            }
            
            // Clean orphaned data
            async cleanOrphanedData() {
                let cleanedCount = 0;
                
                // Find and remove attendance records with no corresponding students
                for (let i = this.attendanceRecords.length - 1; i >= 0; i--) {
                    const record = this.attendanceRecords[i];
                    let hasValidStudents = false;
                    
                    for (const studentId of record.presentStudents) {
                        if (this.students.has(studentId)) {
                            hasValidStudents = true;
                            break;
                        }
                    }
                    
                    // If no valid students, remove the record
                    if (!hasValidStudents) {
                        if (this.isOnline) {
                            await db.collection('users').doc(this.userId).collection('attendance')
                                .doc(record.id).delete();
                        }
                        
                        this.attendanceRecords.splice(i, 1);
                        cleanedCount++;
                    }
                }
                
                return cleanedCount;
            }
        }

        // ÂàõÂª∫Á≥ªÁªüÂÆû‰æã
        const system = new MemoschoolAttendanceSystem();
        
        // ========== Êó•Êúü‰øÆÂ§çÂ∑•ÂÖ∑Á±ª ==========
        class DateFixer {
            static fixAllDates() {
                console.log('üîß ÂºÄÂßã‰øÆÂ§çÊâÄÊúâÊó•ÊúüÊó∂Âå∫ÈóÆÈ¢ò...');
                
                let fixedCount = 0;
                
                // ‰øÆÂ§çÂ≠¶ÁîüÂá∫Âã§Êó•Êúü
                for (const [studentId, student] of system.students.entries()) {
                    if (student.attendanceDates && student.attendanceDates.length > 0) {
                        const fixedDates = student.attendanceDates.map(date => 
                            system.getLocalDateString(date)
                        );
                        
                        // Ê£ÄÊü•ÊòØÂê¶ÊúâÂèòÂåñ
                        if (JSON.stringify(fixedDates) !== JSON.stringify(student.attendanceDates)) {
                            student.attendanceDates = fixedDates;
                            fixedCount++;
                            
                            // Êõ¥Êñ∞Êï∞ÊçÆÂ∫ì
                            if (system.isOnline) {
                                db.collection('users').doc(system.userId).collection('students')
                                    .doc(studentId).update({
                                        attendanceDates: fixedDates
                                    }).catch(console.error);
                            }
                        }
                    }
                }
                
                // ‰øÆÂ§çËÄÉÂã§ËÆ∞ÂΩïÊó•Êúü
                for (const record of system.attendanceRecords) {
                    const fixedDate = system.getLocalDateString(record.date);
                    if (fixedDate !== record.date) {
                        record.date = fixedDate;
                        fixedCount++;
                        
                        // Êõ¥Êñ∞Êï∞ÊçÆÂ∫ì
                        if (system.isOnline) {
                            const recordId = record.id;
                            db.collection('users').doc(system.userId).collection('attendance')
                                .doc(recordId).update({
                                    date: fixedDate
                                }).catch(console.error);
                        }
                    }
                }
                
                console.log(`‚úÖ ‰øÆÂ§ç‰∫Ü ${fixedCount} ‰∏™Êó•ÊúüÊó∂Âå∫ÈóÆÈ¢ò`);
                showToast(`‰øÆÂ§ç‰∫Ü ${fixedCount} ‰∏™Êó•ÊúüÊó∂Âå∫ÈóÆÈ¢ò`, 'success');
                
                // Âà∑Êñ∞UI
                updateUI();
            }
        }
        
        // ========== Êñ∞Â¢ûÊô∫ËÉΩÂäüËÉΩÁ±ª ==========
        
        // Êô∫ËÉΩÂä©ÊâãÁ±ª
        class SmartAssistant {
            constructor() {
                this.conversation = [];
                this.isOpen = false;
            }
            
            async processQuery(query) {
                this.addMessage(query, 'user');
                
                // Ê†πÊçÆÊü•ËØ¢ÂÜÖÂÆπÊô∫ËÉΩÂõûÂ§ç
                let response = '';
                
                if (query.toLowerCase().includes('absent') || query.toLowerCase().includes('frequently')) {
                    response = await this.analyzeFrequentAbsences();
                } else if (query.toLowerCase().includes('report') || query.toLowerCase().includes('monthly')) {
                    response = await this.generateReportSuggestion();
                } else if (query.toLowerCase().includes('help') || query.toLowerCase().includes('what should i do')) {
                    response = await this.provideSuggestions();
                } else if (query.toLowerCase().includes('student') || query.toLowerCase().includes('add')) {
                    response = this.addStudentGuidance();
                } else if (query.toLowerCase().includes('attendance') || query.toLowerCase().includes('record')) {
                    response = this.attendanceGuidance();
                } else {
                    response = this.generalResponse(query);
                }
                
                this.addMessage(response, 'system');
                return response;
            }
            
            async analyzeFrequentAbsences() {
                const threshold = 70; // ‰Ωé‰∫é70%Âá∫Âã§Áéá
                let lowAttendance = [];
                
                for (const student of system.students.values()) {
                    const attendance = system.getStudentAttendance(student.id);
                    const rate = (attendance.attendanceCount / attendance.totalSessions) * 100;
                    if (rate < threshold) {
                        lowAttendance.push({
                            name: student.name,
                            rate: rate.toFixed(1),
                            id: student.id
                        });
                    }
                }
                
                if (lowAttendance.length === 0) {
                    return "Great! All students have attendance rates above 70%. üéâ";
                }
                
                let response = `I found ${lowAttendance.length} student(s) with attendance below ${threshold}%:\n\n`;
                lowAttendance.forEach((student, index) => {
                    response += `${index + 1}. ${student.name} - ${student.rate}% attendance\n`;
                });
                
                response += "\nConsider reaching out to these students or their parents.";
                return response;
            }
            
            async generateReportSuggestion() {
                const summary = system.getSummary();
                const today = new Date();
                const month = today.toLocaleString('default', { month: 'long' });
                
                return `I recommend generating a ${month} report. Here's what I found:\n\n` +
                       `‚Ä¢ Total Students: ${summary.totalStudents}\n` +
                       `‚Ä¢ Average Attendance: ${summary.averageAttendanceRate}%\n` +
                       `‚Ä¢ Sessions Recorded: ${summary.totalSessions}\n\n` +
                       `Would you like me to generate a PDF report?`;
            }
            
            provideSuggestions() {
                const time = new Date().getHours();
                let suggestions = [];
                
                if (time < 12) {
                    suggestions = [
                        "Record attendance for morning classes",
                        "Check yesterday's attendance records",
                        "Add any new students who joined recently"
                    ];
                } else if (time < 17) {
                    suggestions = [
                        "Record afternoon class attendance",
                        "Generate daily attendance summary",
                        "Update student information if needed"
                    ];
                } else {
                    suggestions = [
                        "Prepare attendance report for tomorrow",
                        "Review low attendance students",
                        "Backup today's data"
                    ];
                }
                
                let response = "Based on the time, here's what I suggest:\n\n";
                suggestions.forEach((suggestion, index) => {
                    response += `${index + 1}. ${suggestion}\n`;
                });
                
                return response;
            }
            
            addStudentGuidance() {
                return "To add a new student:\n\n" +
                       "1. Go to Students section\n" +
                       "2. Click 'Add Student'\n" +
                       "3. Fill in the student details\n" +
                       "4. Select appropriate time slot\n" +
                       "5. Click 'Save Student'\n\n" +
                       "Pro tip: You can use voice input to add students faster!";
            }
            
            attendanceGuidance() {
                return "To record attendance:\n\n" +
                       "1. Go to Attendance section\n" +
                       "2. Select time slot and date\n" +
                       "3. Check present students\n" +
                       "4. Add session topic (optional)\n" +
                       "5. Click 'Record Attendance'\n\n" +
                       "Shortcut: Press 'Q' for quick attendance mode!";
            }
            
            generalResponse(query) {
                const responses = [
                    "I understand you're asking about: " + query + ". How can I help you with this?",
                    "That's an interesting question. Let me think about how I can assist you with that.",
                    "I can help you with student management, attendance recording, or generating reports. What specific help do you need?",
                    "I'm here to make your work easier. Could you clarify what you'd like me to do?"
                ];
                
                return responses[Math.floor(Math.random() * responses.length)];
            }
            
            addMessage(text, sender) {
                const message = {
                    text,
                    sender,
                    timestamp: new Date().toISOString()
                };
                
                this.conversation.push(message);
                this.displayMessage(message);
            }
            
            displayMessage(message) {
                const content = document.getElementById('aiContent');
                const messageDiv = document.createElement('div');
                messageDiv.className = `ai-message ${message.sender}`;
                
                const senderName = message.sender === 'user' ? 'You' : 'Assistant';
                messageDiv.innerHTML = `<strong>${senderName}:</strong> ${message.text.replace(/\n/g, '<br>')}`;
                
                content.appendChild(messageDiv);
                content.scrollTop = content.scrollHeight;
            }
        }
        
        // Êô∫ËÉΩÊèêÈÜíÁ≥ªÁªü
        class SmartAlerts {
            constructor() {
                this.alerts = [];
                this.checkInterval = null;
            }
            
            startMonitoring() {
                // ÊØè5ÂàÜÈíüÊ£ÄÊü•‰∏ÄÊ¨°
                this.checkInterval = setInterval(() => {
                    this.checkForAlerts();
                }, 5 * 60 * 1000);
                
                // ÂàùÂßãÊ£ÄÊü•
                this.checkForAlerts();
            }
            
            async checkForAlerts() {
                this.alerts = [];
                
                // Ê£ÄÊü•‰ΩéÂá∫Âã§ÁéáÂ≠¶Áîü
                const lowAttendance = this.checkLowAttendance();
                if (lowAttendance.length > 0) {
                    this.alerts.push({
                        type: 'warning',
                        title: 'Low Attendance Alert',
                        message: `${lowAttendance.length} student(s) have attendance below 70%`,
                        action: () => showStudentAttendanceDetails(lowAttendance.map(s => s.id))
                    });
                }
                
                // Ê£ÄÊü•‰ªäÊó•Êú™ËÆ∞ÂΩïÂá∫Âã§
                const unrecorded = await this.checkUnrecordedAttendance();
                if (unrecorded.length > 0) {
                    this.alerts.push({
                        type: 'info',
                        title: 'Unrecorded Classes',
                        message: `${unrecorded.length} time slot(s) haven't had attendance recorded today`,
                        action: () => {
                            showSection('attendance');
                            document.getElementById('timeSlotSelect').value = unrecorded[0];
                            updateStudentsCheckboxes();
                        }
                    });
                }
                
                // Ê£ÄÊü•Âç≥Â∞ÜÊª°ËØæÁöÑÂ≠¶Áîü
                const nearlyComplete = this.checkNearlyComplete();
                if (nearlyComplete.length > 0) {
                    this.alerts.push({
                        type: 'success',
                        title: 'Course Completion',
                        message: `${nearlyComplete.length} student(s) are nearing course completion`,
                        action: () => showSection('students')
                    });
                }
                
                // ÊòæÁ§∫ÊèêÈÜí
                this.displayAlerts();
            }
            
            checkLowAttendance(threshold = 70) {
                const lowAttendance = [];
                
                for (const student of system.students.values()) {
                    const attendance = system.getStudentAttendance(student.id);
                    const rate = (attendance.attendanceCount / attendance.totalSessions) * 100;
                    if (rate < threshold) {
                        lowAttendance.push({
                            id: student.id,
                            name: student.name,
                            rate: rate.toFixed(1)
                        });
                    }
                }
                
                return lowAttendance;
            }
            
            async checkUnrecordedAttendance() {
                const today = system.getLocalDateString(new Date());
                const unrecorded = [];
                
                // Ê£ÄÊü•ÊØè‰∏™Êó∂Èó¥ÊßΩ‰ªäÂ§©ÊòØÂê¶Â∑≤ËÆ∞ÂΩï
                for (const timeSlot of system.timeSlots) {
                    const hasRecord = system.attendanceRecords.some(record => 
                        record.timeSlot === timeSlot.name && record.date === today
                    );
                    
                    if (!hasRecord) {
                        // Ê£ÄÊü•ËØ•Êó∂Èó¥ÊßΩÊòØÂê¶ÊúâÂ≠¶Áîü
                        const students = system.getStudentsByTimeSlot(timeSlot.name);
                        if (students.length > 0) {
                            unrecorded.push(timeSlot.name);
                        }
                    }
                }
                
                return unrecorded;
            }
            
            checkNearlyComplete(threshold = 90) {
                const nearlyComplete = [];
                
                for (const student of system.students.values()) {
                    const attendance = system.getStudentAttendance(student.id);
                    const progress = (attendance.attendanceCount / attendance.totalSessions) * 100;
                    if (progress >= threshold && progress < 100) {
                        nearlyComplete.push({
                            id: student.id,
                            name: student.name,
                            progress: progress.toFixed(1)
                        });
                    }
                }
                
                return nearlyComplete;
            }
            
            displayAlerts() {
                const container = document.getElementById('smartAlertsContainer');
                if (!container) return;
                
                container.innerHTML = '';
                
                if (this.alerts.length === 0) {
                    container.innerHTML = `
                        <div class="feature-card">
                            <div style="text-align: center; padding: 20px;">
                                <i class="fas fa-check-circle" style="font-size: 48px; color: var(--success); margin-bottom: 15px;"></i>
                                <h3>All Good!</h3>
                                <p>No alerts at the moment. Everything is running smoothly.</p>
                            </div>
                        </div>
                    `;
                    return;
                }
                
                const alertHtml = this.alerts.map((alert, index) => `
                    <div class="suggestion-card" onclick="${alert.action ? 'smartAlerts.alerts[' + index + '].action()' : ''}" style="border-left-color: var(--${alert.type});">
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                            <i class="fas fa-${this.getAlertIcon(alert.type)}" style="color: var(--${alert.type});"></i>
                            <h4 style="margin: 0;">${alert.title}</h4>
                        </div>
                        <p style="margin: 0;">${alert.message}</p>
                        ${alert.action ? '<p style="margin: 8px 0 0 0; font-size: 12px; color: var(--primary);"><i class="fas fa-hand-pointer"></i> Click to take action</p>' : ''}
                    </div>
                `).join('');
                
                container.innerHTML = `
                    <div class="feature-card">
                        <h3><i class="fas fa-bell"></i> Smart Alerts</h3>
                        ${alertHtml}
                    </div>
                `;
            }
            
            getAlertIcon(type) {
                const icons = {
                    warning: 'exclamation-triangle',
                    info: 'info-circle',
                    success: 'check-circle',
                    danger: 'exclamation-circle'
                };
                return icons[type] || 'info-circle';
            }
            
            showQuickAlert(message, type = 'info', duration = 5000) {
                const container = document.getElementById('smartAlertContainer');
                const alertId = 'alert-' + Date.now();
                
                const alertHtml = `
                    <div class="smart-alert" id="${alertId}">
                        <div class="alert-header" style="background: ${this.getAlertColor(type)};">
                            <i class="fas fa-${this.getAlertIcon(type)}"></i>
                            <strong>${type.charAt(0).toUpperCase() + type.slice(1)}</strong>
                        </div>
                        <div class="alert-content">
                            ${message}
                        </div>
                    </div>
                `;
                
                container.innerHTML += alertHtml;
                
                // Ëá™Âä®ÁßªÈô§
                setTimeout(() => {
                    const alert = document.getElementById(alertId);
                    if (alert) {
                        alert.style.animation = 'slideInRight 0.5s ease reverse';
                        setTimeout(() => alert.remove(), 500);
                    }
                }, duration);
            }
            
            getAlertColor(type) {
                const colors = {
                    warning: '#fff3cd',
                    info: '#d1ecf1',
                    success: '#d4edda',
                    danger: '#f8d7da'
                };
                return colors[type] || '#d1ecf1';
            }
        }
        
        // Â¢ûÂº∫ÁöÑÂõæË°®ÁÆ°ÁêÜÂô®
        class EnhancedCharts {
            constructor() {
                this.charts = {};
            }
            
            renderAttendanceTrend() {
                const ctx = document.getElementById('attendanceTrendChart');
                if (!ctx) return;
                
                // Ëé∑ÂèñÊúÄËøë7Â§©ÁöÑÂá∫Âã§Êï∞ÊçÆ
                const last7Days = this.getLast7Days();
                const attendanceByDay = this.calculateAttendanceByDay(last7Days);
                
                if (this.charts.attendanceTrend) {
                    this.charts.attendanceTrend.destroy();
                }
                
                this.charts.attendanceTrend = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: last7Days.map(date => {
                            const d = new Date(date);
                            return `${d.getDate()}/${d.getMonth() + 1}`;
                        }),
                        datasets: [{
                            label: 'Daily Attendance',
                            data: attendanceByDay,
                            borderColor: 'rgba(230, 126, 34, 1)',
                            backgroundColor: 'rgba(230, 126, 34, 0.1)',
                            tension: 0.4,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return `Attendance: ${context.parsed.y} students`;
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Number of Students'
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: 'Date'
                                }
                            }
                        }
                    }
                });
            }
            
            renderStudentDistribution() {
                const ctx = document.getElementById('studentDistributionChart');
                if (!ctx) return;
                
                // ÊåâÊó∂Èó¥ÊßΩÁªüËÆ°Â≠¶ÁîüÂàÜÂ∏É
                const distribution = {};
                system.timeSlots.forEach(slot => {
                    const students = system.getStudentsByTimeSlot(slot.name);
                    distribution[slot.name] = students.length;
                });
                
                // È¢úËâ≤ÁîüÊàê
                const colors = this.generateColors(Object.keys(distribution).length);
                
                if (this.charts.studentDistribution) {
                    this.charts.studentDistribution.destroy();
                }
                
                this.charts.studentDistribution = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: Object.keys(distribution),
                        datasets: [{
                            data: Object.values(distribution),
                            backgroundColor: colors,
                            borderWidth: 2,
                            borderColor: 'white'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'right',
                                labels: {
                                    boxWidth: 12,
                                    padding: 15
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const percentage = Math.round((context.parsed / total) * 100);
                                        return `${context.label}: ${context.parsed} students (${percentage}%)`;
                                    }
                                }
                            }
                        }
                    }
                });
            }
            
            getLast7Days() {
                const days = [];
                for (let i = 6; i >= 0; i--) {
                    const date = new Date();
                    date.setDate(date.getDate() - i);
                    days.push(system.getLocalDateString(date));
                }
                return days;
            }
            
            calculateAttendanceByDay(days) {
                return days.map(day => {
                    const records = system.attendanceRecords.filter(record => record.date === day);
                    return records.reduce((total, record) => total + (record.presentStudents?.length || 0), 0);
                });
            }
            
            generateColors(count) {
                const colors = [];
                const hueStep = 360 / count;
                
                for (let i = 0; i < count; i++) {
                    const hue = (i * hueStep) % 360;
                    colors.push(`hsla(${hue}, 70%, 60%, 0.8)`);
                }
                
                return colors;
            }
            
            updateAllCharts() {
                this.renderAttendanceTrend();
                this.renderStudentDistribution();
            }
        }
        
        // ÊãñÊãΩÁÆ°ÁêÜÂô®
        class DragDropManager {
            constructor() {
                this.draggedStudent = null;
                this.setupEventListeners();
            }
            
            setupEventListeners() {
                document.addEventListener('dragstart', (e) => {
                    if (e.target.classList.contains('draggable-student')) {
                        this.draggedStudent = e.target.dataset.studentId;
                        e.dataTransfer.setData('text/plain', e.target.dataset.studentId);
                        e.target.classList.add('dragging');
                    }
                });
                
                document.addEventListener('dragend', (e) => {
                    if (e.target.classList.contains('draggable-student')) {
                        e.target.classList.remove('dragging');
                        this.draggedStudent = null;
                    }
                });
            }
            
            handleDragOver(e) {
                e.preventDefault();
                if (this.draggedStudent) {
                    e.target.closest('.drop-zone')?.classList.add('drag-over');
                }
            }
            
            handleDragLeave(e) {
                e.target.closest('.drop-zone')?.classList.remove('drag-over');
            }
            
            async handleDrop(e) {
                e.preventDefault();
                const dropZone = e.target.closest('.drop-zone');
                if (dropZone && this.draggedStudent) {
                    dropZone.classList.remove('drag-over');
                    
                    const student = system.students.get(this.draggedStudent);
                    if (!student) return;
                    
                    // ÊòæÁ§∫Êó∂Èó¥ÊßΩÈÄâÊã©
                    const timeSlot = await this.showTimeSlotSelection(student);
                    if (timeSlot) {
                        await this.changeStudentTimeSlot(this.draggedStudent, timeSlot);
                        showToast(`Moved ${student.name} to ${timeSlot}`, 'success');
                        updateUI();
                    }
                }
            }
            
            async showTimeSlotSelection(student) {
                return new Promise((resolve) => {
                    const modal = document.createElement('div');
                    modal.className = 'modal';
                    modal.style.display = 'flex';
                    modal.innerHTML = `
                        <div class="modal-content" style="max-width: 400px;">
                            <div style="padding: 20px;">
                                <h3 style="margin-bottom: 20px;">Move ${student.name}</h3>
                                <p style="margin-bottom: 15px; color: var(--gray);">Select new time slot:</p>
                                <select id="timeSlotMoveSelect" class="form-input" style="margin-bottom: 20px;">
                                    ${system.timeSlots.map(slot => 
                                        `<option value="${slot.name}" ${slot.name === student.timeSlot ? 'selected' : ''}>${slot.name}</option>`
                                    ).join('')}
                                </select>
                                <div style="display: flex; gap: 10px;">
                                    <button class="btn" onclick="this.closest('.modal').remove(); resolve(null)" style="flex: 1;">Cancel</button>
                                    <button class="btn btn-success" onclick="
                                        const select = document.getElementById('timeSlotMoveSelect');
                                        this.closest('.modal').remove();
                                        resolve(select.value);
                                    " style="flex: 1;">Move</button>
                                </div>
                            </div>
                        </div>
                    `;
                    document.body.appendChild(modal);
                });
            }
            
            async changeStudentTimeSlot(studentId, newTimeSlot) {
                try {
                    const student = system.students.get(studentId);
                    if (!student) return;
                    
                    student.timeSlot = newTimeSlot;
                    
                    if (system.isOnline) {
                        await db.collection('users').doc(system.userId).collection('students')
                            .doc(studentId).update({
                                timeSlot: newTimeSlot
                            });
                    }
                    
                    return true;
                } catch (error) {
                    console.error('Error changing time slot:', error);
                    return false;
                }
            }
            
            makeDraggable(element, studentId) {
                element.classList.add('draggable', 'draggable-student');
                element.setAttribute('draggable', 'true');
                element.dataset.studentId = studentId;
                element.setAttribute('title', 'Drag to move to different time slot');
            }
        }
        
        // ËØ≠Èü≥ËæìÂÖ•ÁÆ°ÁêÜÂô®
        class VoiceInputManager {
            constructor() {
                this.recognition = null;
                this.isListening = false;
                this.setupSpeechRecognition();
            }
            
            setupSpeechRecognition() {
                if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                    this.recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
                    this.recognition.continuous = false;
                    this.recognition.interimResults = true;
                    this.recognition.lang = 'en-US';
                    
                    this.recognition.onstart = () => {
                        this.isListening = true;
                        this.showVoiceInterface();
                    };
                    
                    this.recognition.onresult = (event) => {
                        const transcript = Array.from(event.results)
                            .map(result => result[0])
                            .map(result => result.transcript)
                            .join('');
                        
                        document.getElementById('voiceInputText').textContent = transcript;
                        
                        // Â¶ÇÊûúÊúâÊúÄÁªàÁªìÊûú
                        if (event.results[0].isFinal) {
                            this.processVoiceCommand(transcript);
                            this.stopListening();
                        }
                    };
                    
                    this.recognition.onerror = (event) => {
                        console.log('Speech recognition error', event.error);
                        this.stopListening();
                    };
                    
                    this.recognition.onend = () => {
                        this.isListening = false;
                        this.hideVoiceInterface();
                    };
                }
            }
            
            startListening() {
                if (this.recognition && !this.isListening) {
                    try {
                        this.recognition.start();
                    } catch (error) {
                        console.log('Speech recognition start error:', error);
                    }
                }
            }
            
            stopListening() {
                if (this.recognition && this.isListening) {
                    this.recognition.stop();
                }
            }
            
            showVoiceInterface() {
                document.getElementById('voiceInputOverlay').style.display = 'flex';
            }
            
            hideVoiceInterface() {
                document.getElementById('voiceInputOverlay').style.display = 'none';
            }
            
            processVoiceCommand(transcript) {
                const command = transcript.toLowerCase();
                
                // ÂàÜÊûêÂëΩ‰ª§
                if (command.includes('record attendance') || command.includes('take attendance')) {
                    this.handleRecordAttendance(command);
                } else if (command.includes('add student') || command.includes('new student')) {
                    this.handleAddStudent(command);
                } else if (command.includes('search') || command.includes('find')) {
                    this.handleSearch(command);
                } else if (command.includes('generate report') || command.includes('create report')) {
                    this.handleGenerateReport(command);
                } else if (command.includes('show') || command.includes('view')) {
                    this.handleShowView(command);
                } else {
                    showToast(`I heard: "${transcript}"`, 'info');
                }
            }
            
            handleRecordAttendance(command) {
                // ÊèêÂèñÊó∂Èó¥ÊßΩ‰ø°ÊÅØ
                const timeSlots = system.timeSlots.map(s => s.name);
                const matchedTimeSlot = timeSlots.find(slot => 
                    command.includes(slot.toLowerCase())
                );
                
                if (matchedTimeSlot) {
                    showSection('attendance');
                    document.getElementById('timeSlotSelect').value = matchedTimeSlot;
                    updateStudentsCheckboxes();
                    
                    // Ê£ÄÊü•ÊòØÂê¶ÊèêÂà∞Êó•Êúü
                    if (command.includes('today')) {
                        const today = system.getLocalDateString(new Date());
                        document.getElementById('classDate').value = today;
                    } else if (command.includes('yesterday')) {
                        const yesterday = new Date();
                        yesterday.setDate(yesterday.getDate() - 1);
                        document.getElementById('classDate').value = system.getLocalDateString(yesterday);
                    }
                    
                    showToast(`Ready to record attendance for ${matchedTimeSlot}`, 'success');
                } else {
                    showToast('Please specify a time slot', 'info');
                }
            }
            
            handleAddStudent(command) {
                showSection('students');
                showAddStudentForm();
                
                // Â∞ùËØïÊèêÂèñÂ≠¶Áîü‰ø°ÊÅØ
                const nameMatch = command.match(/named (\w+ \w+)|called (\w+ \w+)/i);
                if (nameMatch) {
                    const name = nameMatch[1] || nameMatch[2];
                    document.getElementById('studentName').value = name;
                }
                
                showToast('Add student form opened. Please complete the details.', 'info');
            }
            
            handleSearch(command) {
                const searchTerm = command.replace(/search|find|for/i, '').trim();
                if (searchTerm) {
                    document.getElementById('searchStudents').value = searchTerm;
                    currentSearchTerm = searchTerm;
                    updateTimeSlotTabs();
                    showToast(`Searching for: ${searchTerm}`, 'info');
                }
            }
            
            handleGenerateReport(command) {
                showSection('exports');
                showToast('Report section opened. Select your report type.', 'info');
            }
            
            handleShowView(command) {
                if (command.includes('dashboard')) {
                    showSection('dashboard');
                } else if (command.includes('student')) {
                    showSection('students');
                } else if (command.includes('attendance')) {
                    showSection('attendance');
                } else if (command.includes('record')) {
                    showSection('records');
                }
            }
        }
        
        // Âø´Êç∑ÈîÆÁÆ°ÁêÜÂô®
        class ShortcutManager {
            constructor() {
                this.shortcuts = new Map();
                this.setupShortcuts();
            }
            
            setupShortcuts() {
                // Ê∑ªÂä†Âø´Êç∑ÈîÆ
                this.addShortcut('ctrl+s', (e) => {
                    e.preventDefault();
                    this.handleSaveShortcut();
                });
                
                this.addShortcut('ctrl+f', (e) => {
                    e.preventDefault();
                    this.handleSearchShortcut();
                });
                
                this.addShortcut('ctrl+n', (e) => {
                    e.preventDefault();
                    this.handleNewStudentShortcut();
                });
                
                this.addShortcut('ctrl+p', (e) => {
                    e.preventDefault();
                    this.handlePrintShortcut();
                });
                
                this.addShortcut('q', (e) => {
                    if (!e.ctrlKey && !e.altKey && !e.metaKey) {
                        this.handleQuickAttendance();
                    }
                });
                
                this.addShortcut('?', (e) => {
                    if (e.shiftKey) {
                        this.showShortcutHelp();
                    }
                });
                
                // ÁõëÂê¨ÈîÆÁõò‰∫ã‰ª∂
                document.addEventListener('keydown', (e) => {
                    this.handleKeyPress(e);
                });
            }
            
            addShortcut(combo, callback) {
                this.shortcuts.set(combo, callback);
            }
            
            handleKeyPress(e) {
                const key = e.key.toLowerCase();
                let combo = '';
                
                if (e.ctrlKey) combo += 'ctrl+';
                if (e.shiftKey) combo += 'shift+';
                if (e.altKey) combo += 'alt+';
                if (e.metaKey) combo += 'cmd+';
                
                combo += key;
                
                const handler = this.shortcuts.get(combo);
                if (handler) {
                    handler(e);
                }
            }
            
            handleSaveShortcut() {
                const activeSection = document.querySelector('.section.active').id;
                switch(activeSection) {
                    case 'attendance':
                        recordAttendance();
                        break;
                    case 'students':
                        if (document.getElementById('addStudentForm').style.display !== 'none') {
                            addStudent();
                        } else if (document.getElementById('editStudentForm').style.display !== 'none') {
                            updateStudent();
                        }
                        break;
                    default:
                        showToast('Press Ctrl+S to save in forms', 'info');
                }
            }
            
            handleSearchShortcut() {
                const searchInput = document.getElementById('searchStudents') || 
                                   document.querySelector('.search-box input');
                if (searchInput) {
                    searchInput.focus();
                    searchInput.select();
                    showShortcutHint(searchInput, 'Start typing to search...');
                }
            }
            
            handleNewStudentShortcut() {
                if (document.getElementById('students').classList.contains('active')) {
                    showAddStudentForm();
                } else {
                    showSection('students');
                    setTimeout(() => showAddStudentForm(), 300);
                }
                showToast('Quick add student activated', 'info');
            }
            
            handlePrintShortcut() {
                generateQuickReport();
            }
            
            handleQuickAttendance() {
                if (document.getElementById('attendance').classList.contains('active')) {
                    recordAttendance();
                } else {
                    quickRecordAttendance();
                }
            }
            
            showShortcutHelp() {
                const shortcuts = [
                    { key: 'Ctrl + S', desc: 'Save/Record attendance' },
                    { key: 'Ctrl + F', desc: 'Search' },
                    { key: 'Ctrl + N', desc: 'New student' },
                    { key: 'Ctrl + P', desc: 'Print/Generate report' },
                    { key: 'Q', desc: 'Quick attendance' },
                    { key: '?', desc: 'Show this help' }
                ];
                
                let html = '<div class="ai-message system"><strong>Keyboard Shortcuts:</strong><br><br>';
                shortcuts.forEach(shortcut => {
                    html += `<div style="margin-bottom: 8px;"><code style="background: #f0f0f0; padding: 3px 6px; border-radius: 4px;">${shortcut.key}</code> - ${shortcut.desc}</div>`;
                });
                html += '</div>';
                
                smartAssistant.addMessage(html.replace(/<br>/g, '\n'), 'system');
                if (!document.getElementById('aiPanel').style.display || document.getElementById('aiPanel').style.display === 'none') {
                    toggleAIPanel();
                }
            }
        }
        
        // Ëá™ÁÑ∂ËØ≠Ë®ÄÊêúÁ¥¢
        class NaturalLanguageSearch {
            constructor() {
                this.setupSearchExamples();
            }
            
            setupSearchExamples() {
                const examples = [
                    "students with low attendance",
                    "males in Saturday class",
                    "enrolled after 2024",
                    "students with less than 20 sessions",
                    "females aged 12-14"
                ];
                
                const container = document.createElement('div');
                container.className = 'natural-search-examples';
                examples.forEach(example => {
                    const span = document.createElement('span');
                    span.className = 'search-example';
                    span.textContent = example;
                    span.onclick = () => this.processNaturalQuery(example);
                    container.appendChild(span);
                });
                
                const searchBox = document.querySelector('.search-box');
                if (searchBox) {
                    searchBox.appendChild(container);
                }
            }
            
            processNaturalQuery(query) {
                document.getElementById('searchStudents').value = query;
                currentSearchTerm = query;
                
                // Ëß£ÊûêËá™ÁÑ∂ËØ≠Ë®ÄÊü•ËØ¢
                const conditions = this.parseQuery(query);
                this.highlightSearchResults(conditions);
                
                updateTimeSlotTabs();
            }
            
            parseQuery(query) {
                const conditions = [];
                query = query.toLowerCase();
                
                // Ëß£ÊûêÂπ¥ÈæÑËåÉÂõ¥
                const ageMatch = query.match(/(\d+)\s*-\s*(\d+)\s*years?/i) || 
                                query.match(/aged?\s*(\d+)\s*-\s*(\d+)/i) ||
                                query.match(/(\d+)\s*to\s*(\d+)\s*years?/i);
                if (ageMatch) {
                    conditions.push({
                        type: 'age',
                        min: parseInt(ageMatch[1]),
                        max: parseInt(ageMatch[2])
                    });
                }
                
                // Ëß£ÊûêÊÄßÂà´
                if (query.includes('male') || query.includes('boy')) {
                    conditions.push({ type: 'gender', value: 'Male' });
                } else if (query.includes('female') || query.includes('girl')) {
                    conditions.push({ type: 'gender', value: 'Female' });
                }
                
                // Ëß£ÊûêÊó∂Èó¥ÊßΩ
                system.timeSlots.forEach(slot => {
                    if (query.includes(slot.name.toLowerCase())) {
                        conditions.push({ type: 'timeSlot', value: slot.name });
                    }
                });
                
                // Ëß£ÊûêÂá∫Âã§ÊÉÖÂÜµ
                if (query.includes('low attendance') || query.includes('frequently absent')) {
                    conditions.push({ type: 'lowAttendance', threshold: 70 });
                }
                
                // Ëß£ÊûêÊ≥®ÂÜåÊó•Êúü
                if (query.includes('enrolled after')) {
                    const yearMatch = query.match(/enrolled after\s*(\d{4})/i);
                    if (yearMatch) {
                        conditions.push({ type: 'enrolledAfter', year: yearMatch[1] });
                    }
                }
                
                return conditions;
            }
            
            highlightSearchResults(conditions) {
                // Âú®ÂÆûÈôÖÂ∫îÁî®‰∏≠ÔºåËøôÈáåÂèØ‰ª•È´ò‰∫ÆÊòæÁ§∫ÂåπÈÖçÁöÑÁªìÊûú
                console.log('Search conditions:', conditions);
                // Êõ¥Êñ∞ÊêúÁ¥¢ÁªìÊûúÊòæÁ§∫ÂåπÈÖçÁöÑÊù°‰ª∂
                const searchInfo = document.querySelector('.search-info');
                if (searchInfo) {
                    searchInfo.innerHTML = `Searching with conditions: <code>${JSON.stringify(conditions)}</code>`;
                }
            }
        }
        
        // ========== ÂàõÂª∫ÂÆû‰æã ==========
        const smartAssistant = new SmartAssistant();
        const smartAlerts = new SmartAlerts();
        const enhancedCharts = new EnhancedCharts();
        const dragDropManager = new DragDropManager();
        const voiceInputManager = new VoiceInputManager();
        let shortcutManager;
        let naturalSearch;
        
        // ========== ÂàùÂßãÂåñÂ¢ûÂº∫ÂäüËÉΩ ==========
        function initEnhancedFeatures() {
            // ÂàùÂßãÂåñÁÆ°ÁêÜÂô®
            shortcutManager = new ShortcutManager();
            naturalSearch = new NaturalLanguageSearch();
            
            // Êõ¥Êñ∞ÈóÆÂÄôËØ≠
            updateGreeting();
            
            // ÂºÄÂßãÊô∫ËÉΩÊèêÈÜíÁõëÊéß
            smartAlerts.startMonitoring();
            
            // Âä†ËΩΩÁî®Êà∑ËÆæÁΩÆ
            loadUserSettings();
            
            // Ê∑ªÂä†ËØ≠Èü≥ËæìÂÖ•ÊåâÈíÆÂà∞Ë°®Âçï
            addVoiceInputButtons();
            
            // ÂàùÂßãÂåñÂõæË°®
            enhancedCharts.updateAllCharts();
            
            // ËÆæÁΩÆÊãñÊãΩÂ≠¶ÁîüÂç°Áâá
            setupDraggableStudents();
            
            console.log('Enhanced features initialized');
        }
        
        // ========== Êñ∞Â¢ûÂ∑•ÂÖ∑ÂáΩÊï∞ ==========
        
        function updateGreeting() {
            const hour = new Date().getHours();
            let greeting = '';
            
            if (hour < 12) greeting = 'Good morning';
            else if (hour < 18) greeting = 'Good afternoon';
            else greeting = 'Good evening';
            
            document.getElementById('timeGreeting').textContent = greeting;
        }
        
        function toggleAIPanel() {
            const panel = document.getElementById('aiPanel');
            const isOpen = panel.style.display === 'block';
            
            if (isOpen) {
                panel.style.animation = 'slideUp 0.3s ease reverse';
                setTimeout(() => {
                    panel.style.display = 'none';
                }, 300);
            } else {
                panel.style.display = 'block';
                panel.style.animation = 'slideUp 0.3s ease';
                document.getElementById('aiInput').focus();
            }
        }
        
        function askAI(question) {
            document.getElementById('aiInput').value = question;
            sendAIMessage();
        }
        
        async function sendAIMessage() {
            const input = document.getElementById('aiInput');
            const question = input.value.trim();
            
            if (!question) return;
            
            input.value = '';
            await smartAssistant.processQuery(question);
        }
        
        function handleAIInput(event) {
            if (event.key === 'Enter') {
                sendAIMessage();
            }
        }
        
        function openSettings() {
            document.getElementById('settingsPanel').classList.add('open');
        }
        
        function closeSettings() {
            document.getElementById('settingsPanel').classList.remove('open');
        }
        
        function saveSetting(key, value) {
            localStorage.setItem(`gma_${key}`, value);
            applySetting(key, value);
        }
        
        function loadUserSettings() {
            const settings = [
                'quickActions',
                'voiceCommands', 
                'smartSuggestions',
                'animations',
                'defaultView'
            ];
            
            settings.forEach(setting => {
                const value = localStorage.getItem(`gma_${setting}`);
                if (value !== null) {
                    const element = document.getElementById(`${setting}Toggle`) || 
                                   document.getElementById(`${setting}Select`);
                    if (element) {
                        if (element.type === 'checkbox') {
                            element.checked = value === 'true';
                        } else {
                            element.value = value;
                        }
                        applySetting(setting, value);
                    }
                }
            });
        }
        
        function applySetting(key, value) {
            switch(key) {
                case 'quickActions':
                    document.getElementById('quickActionsPanel').style.display = 
                        value === 'true' ? 'grid' : 'none';
                    break;
                case 'animations':
                    if (value === 'false') {
                        document.body.classList.add('no-animations');
                    } else {
                        document.body.classList.remove('no-animations');
                    }
                    break;
                case 'defaultView':
                    // Âú®‰∏ãÊ¨°Âä†ËΩΩÊó∂Â∫îÁî®
                    break;
            }
        }
        
        function generateQuickReport() {
            showSection('exports');
            showToast('Generating quick report...', 'info');
            
            // Ê®°ÊãüÊä•ÂëäÁîüÊàê
            setTimeout(() => {
                exportToPDF();
            }, 1000);
        }
        
        function exportToPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            const summary = system.getSummary();
            const today = new Date();
            
            doc.setFontSize(24);
            doc.text("Genius Mind Academy", 105, 20, null, null, 'center');
            doc.setFontSize(16);
            doc.text("Quick Attendance Report", 105, 30, null, null, 'center');
            doc.setFontSize(12);
            doc.text(`Generated on ${today.toLocaleDateString()}`, 105, 40, null, null, 'center');
            
            let y = 60;
            doc.setFontSize(14);
            doc.text("Summary Statistics", 20, y);
            y += 10;
            
            doc.setFontSize(12);
            const stats = [
                `Total Students: ${summary.totalStudents}`,
                `Sessions Recorded: ${summary.totalSessions}`,
                `Average Attendance: ${summary.averageAttendanceRate}%`,
                `Time Slots: ${summary.timeSlots}`
            ];
            
            stats.forEach(stat => {
                doc.text(stat, 25, y);
                y += 8;
            });
            
            y += 10;
            doc.setFontSize(14);
            doc.text("Recent Activity", 20, y);
            y += 10;
            
            // Ê∑ªÂä†ÊúÄËøë5Êù°ËÆ∞ÂΩï
            const recentRecords = [...system.attendanceRecords]
                .sort((a, b) => new Date(b.date) - new Date(a.date))
                .slice(0, 5);
            
            doc.setFontSize(10);
            recentRecords.forEach(record => {
                if (y > 270) {
                    doc.addPage();
                    y = 20;
                }
                
                const formattedDate = system.formatDateForDisplay(record.date);
                doc.text(`${formattedDate} - ${record.timeSlot}: ${record.presentStudents.length} students`, 25, y);
                y += 6;
            });
            
            doc.save(`quick_report_${today.getTime()}.pdf`);
            showToast('Quick report generated!', 'success');
        }
        
        function showShortcutHint(element, message) {
            const hint = document.createElement('div');
            hint.className = 'shortcut-hint';
            hint.textContent = message;
            
            const rect = element.getBoundingClientRect();
            hint.style.left = rect.left + 'px';
            hint.style.top = (rect.top - 30) + 'px';
            
            document.body.appendChild(hint);
            
            setTimeout(() => {
                hint.remove();
            }, 3000);
        }
        
        function addVoiceInputButtons() {
            // ‰∏∫ÂÖ≥ÈîÆËæìÂÖ•Ê°ÜÊ∑ªÂä†ËØ≠Èü≥ËæìÂÖ•ÊåâÈíÆ
            const inputs = [
                'studentName',
                'searchStudents',
                'sessionTopic',
                'aiInput'
            ];
            
            inputs.forEach(inputId => {
                const input = document.getElementById(inputId);
                if (input) {
                    const container = document.createElement('div');
                    container.className = 'voice-input';
                    
                    input.parentNode.insertBefore(container, input);
                    container.appendChild(input);
                    
                    const button = document.createElement('button');
                    button.className = 'voice-button';
                    button.innerHTML = '<i class="fas fa-microphone"></i>';
                    button.onclick = () => startVoiceInputFor(inputId);
                    container.appendChild(button);
                }
            });
        }
        
        function startVoiceInputFor(inputId) {
            if (voiceInputManager.recognition) {
                voiceInputManager.startListening();
                
                // ËÆæÁΩÆËæìÂÖ•ÁõÆÊ†á
                voiceInputManager.recognition.onresult = (event) => {
                    const transcript = event.results[0][0].transcript;
                    const input = document.getElementById(inputId);
                    if (input) {
                        input.value = transcript;
                        input.dispatchEvent(new Event('input'));
                    }
                };
            } else {
                showToast('Voice recognition not supported in this browser', 'error');
            }
        }
        
        function stopVoiceInput() {
            voiceInputManager.stopListening();
        }
        
        function setupDraggableStudents() {
            // Âª∂ËøüÊâßË°å‰ª•Á°Æ‰øùDOMÂ∑≤Âä†ËΩΩ
            setTimeout(() => {
                const studentCards = document.querySelectorAll('.student-card-enhanced');
                studentCards.forEach(card => {
                    const studentId = card.querySelector('.student-select-checkbox')?.value;
                    if (studentId) {
                        dragDropManager.makeDraggable(card, studentId);
                    }
                });
            }, 1000);
        }
        
        function showStudentAttendanceDetails(studentIds) {
            // ÊòæÁ§∫ÈÄâ‰∏≠Â≠¶ÁîüÁöÑÂá∫Âã§ËØ¶ÊÉÖ
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'flex';
            
            let content = '<div class="modal-content" style="max-width: 600px;">';
            content += '<div style="padding: 20px;">';
            content += '<h3 style="margin-bottom: 20px;">Student Attendance Details</h3>';
            
            studentIds.forEach(studentId => {
                const student = system.students.get(studentId);
                if (student) {
                    const attendance = system.getStudentAttendance(studentId);
                    const rate = (attendance.attendanceCount / attendance.totalSessions * 100).toFixed(1);
                    
                    content += `
                        <div class="student-card-enhanced" style="margin-bottom: 15px;">
                            <strong>${student.name}</strong><br>
                            Attendance: ${attendance.attendanceCount}/${attendance.totalSessions} (${rate}%)<br>
                            Time Slot: ${student.timeSlot}
                        </div>
                    `;
                }
            });
            
            content += '<button class="btn" onclick="this.closest(\'.modal\').remove()" style="margin-top: 20px;">Close</button>';
            content += '</div></div>';
            
            modal.innerHTML = content;
            document.body.appendChild(modal);
        }
        
        function addStudentFromSuggestion() {
            // Êô∫ËÉΩÂ°´ÂÖÖÂ≠¶Áîü‰ø°ÊÅØ
            document.getElementById('studentName').focus();
            
            // Ê†πÊçÆÂΩìÂâçÊó∂Èó¥ÊßΩÈÄâÊã©Êèê‰æõÂª∫ËÆÆ
            const currentHour = new Date().getHours();
            let suggestedTimeSlot = '';
            
            if (currentHour < 12) {
                suggestedTimeSlot = system.timeSlots.find(s => s.name.includes('morning'))?.name || 
                                   system.timeSlots.find(s => s.name.includes('9am'))?.name ||
                                   system.timeSlots[0]?.name;
            } else if (currentHour < 17) {
                suggestedTimeSlot = system.timeSlots.find(s => s.name.includes('afternoon'))?.name ||
                                   system.timeSlots.find(s => s.name.includes('2pm'))?.name ||
                                   system.timeSlots[1]?.name;
            } else {
                suggestedTimeSlot = system.timeSlots.find(s => s.name.includes('evening'))?.name ||
                                   system.timeSlots.find(s => s.name.includes('4pm'))?.name ||
                                   system.timeSlots[system.timeSlots.length - 1]?.name;
            }
            
            if (suggestedTimeSlot) {
                document.getElementById('studentTimeSlot').value = suggestedTimeSlot;
            }
            
            showToast('Smart suggestions applied. Fill in the remaining details.', 'info');
        }
        
        function processNaturalQuery(query) {
            if (naturalSearch) {
                naturalSearch.processNaturalQuery(query);
            }
        }
        
        function handleDragOver(e) {
            if (dragDropManager) dragDropManager.handleDragOver(e);
        }
        
        function handleDragLeave(e) {
            if (dragDropManager) dragDropManager.handleDragLeave(e);
        }
        
        function handleDrop(e) {
            if (dragDropManager) dragDropManager.handleDrop(e);
        }
        
        // ========== ÂàùÂßãÂåñÂáΩÊï∞ ==========
        function init() {
            // ÂàùÂßãÂåñDOMÁºìÂ≠ò
            domCache.syncStatus = document.getElementById('syncStatus');
            domCache.userEmail = document.getElementById('userEmail');
            domCache.loginSection = document.getElementById('loginSection');
            domCache.appSection = document.getElementById('appSection');
            domCache.fabButton = document.getElementById('fabButton');
            
            // ËÆæÁΩÆÈªòËÆ§Êó•Êúü
            const today = new Date();
            const todayStr = system.getLocalDateString(today);
            
            document.getElementById('classDate').value = todayStr;
            document.getElementById('studentEnrolledDate').value = todayStr;
            
            // Ê∑ªÂä†ÊêúÁ¥¢Èò≤Êäñ
            const searchInput = document.getElementById('searchStudents');
            if (searchInput) {
                const debouncedSearch = debounce(function(e) {
                    currentSearchTerm = e.target.value.trim();
                    updateTimeSlotTabs();
                }, 300);
                searchInput.addEventListener('input', debouncedSearch);
            }
            
            // ÁõëÂê¨ÊªöÂä®‰∫ã‰ª∂ÔºåÊòæÁ§∫/ÈöêËóèFAB
            window.addEventListener('scroll', throttle(() => {
                const fab = domCache.fabButton;
                if (window.scrollY > 300) {
                    fab.style.display = 'flex';
                } else {
                    fab.style.display = 'none';
                }
            }, 200));
            
            // Ê£ÄÊü•ÊöóËâ≤Ê®°ÂºèÂÅèÂ•Ω
            if (localStorage.getItem('darkMode') === 'true' || 
                (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.body.classList.add('dark-mode');
            }
            
            // Ê£ÄÊü•ÁΩëÁªúÁä∂ÊÄÅ
            window.addEventListener('online', updateOnlineStatus);
            window.addEventListener('offline', updateOnlineStatus);
            updateOnlineStatus();
            
            console.log('Á≥ªÁªüÂàùÂßãÂåñÂÆåÊàê');
        }
        
        // ========== ÁΩëÁªúÁä∂ÊÄÅÂáΩÊï∞ ==========
        function updateOnlineStatus() {
            const status = navigator.onLine ? 'online' : 'offline';
            const icon = status === 'online' ? 'fa-wifi' : 'fa-wifi-slash';
            const message = status === 'online' ? 'Online' : 'Offline - Working locally';
            
            if (domCache.syncStatus) {
                domCache.syncStatus.innerHTML = `<i class="fas ${icon}"></i> ${message}`;
                domCache.syncStatus.className = `sync-status ${status}`;
            }
            
            if (!navigator.onLine) {
                showToast('You are offline. Changes will sync when you reconnect.', 'warning');
            }
        }
        
        // ========== ÂêåÊ≠•Áä∂ÊÄÅÊõ¥Êñ∞ ==========
        function updateSyncStatus(message, type = 'syncing') {
            const statusElement = document.getElementById('syncStatus');
            statusElement.textContent = message;
            statusElement.className = `sync-status ${type}`;
        }
        
        // ========== UIÊõ¥Êñ∞ÂáΩÊï∞ ==========
        function updateUI() {
            updateDashboard();
            updateTimeSlotSelects();
            updateTimeSlotTabs();
            updateStudentsCheckboxes();
            updateClassAttendanceRecords();
            updateStudentAttendanceSummary();
            updateTimeSlots();
            updateFilterStudent();
            updateSelectedCount();
            
            // Êõ¥Êñ∞Êó∂Âå∫‰ø°ÊÅØ
            updateTimezoneInfo();
            
            // Â¢ûÂº∫ÂäüËÉΩÊõ¥Êñ∞
            if (document.getElementById('dashboard').classList.contains('active')) {
                enhancedCharts.updateAllCharts();
                smartAlerts.checkForAlerts();
            }
            
            // Êõ¥Êñ∞ÊãñÊãΩÂäüËÉΩ
            setupDraggableStudents();
            
            // Êõ¥Êñ∞ÈóÆÂÄôËØ≠
            updateGreeting();
        }
        
        function showSection(sectionId) {
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            document.getElementById(sectionId).classList.add('active');
            
            // ‰øùÂ≠òÊúÄÂêéËÆøÈóÆÁöÑÂå∫Âüü
            localStorage.setItem('gma_lastSection', sectionId);
            
            // Êõ¥Êñ∞ËØ•Âå∫ÂüüÁöÑÂ¢ûÂº∫ÂäüËÉΩ
            switch(sectionId) {
                case 'dashboard':
                    enhancedCharts.updateAllCharts();
                    break;
                case 'students':
                    setupDraggableStudents();
                    break;
            }
        }
        
        function updateDashboard() {
            const summary = system.getSummary();
            
            document.getElementById('totalStudents').textContent = summary.totalStudents;
            document.getElementById('sessionsRecorded').textContent = summary.totalSessions;
            document.getElementById('avgAttendance').textContent = summary.averageAttendanceRate + '%';
            document.getElementById('timeSlotsCountDashboard').textContent = summary.timeSlots;
            
            // Detailed stats
            document.getElementById('totalStudentsDetailed').textContent = summary.totalStudents;
            document.getElementById('sessionsRecordedDetailed').textContent = summary.totalSessions;
            document.getElementById('avgAttendanceDetailed').textContent = summary.averageAttendanceRate + '%';
            document.getElementById('timeSlotsCountDetailed').textContent = summary.timeSlots;
        }
        
        // ========== Êó∂Èó¥ÊßΩÁõ∏ÂÖ≥ÂáΩÊï∞ ==========
        function updateTimeSlotSelects() {
            // Update all time slot dropdowns
            const selectors = [
                'studentTimeSlot',
                'editStudentTimeSlot', 
                'timeSlotSelect',
                'classFilterTimeSlot',
                'studentFilterTimeSlot'
            ];
            
            selectors.forEach(selector => {
                const select = document.getElementById(selector);
                if (!select) return;
                
                // Clear existing options
                select.innerHTML = selector.includes('Filter') ? '<option value="all">All Time Slots</option>' : '<option value="">Select Time Slot</option>';
                
                // Add time slots
                system.timeSlots.forEach(timeSlot => {
                    const option = document.createElement('option');
                    option.value = timeSlot.name;
                    option.textContent = timeSlot.name;
                    select.appendChild(option);
                });
            });
        }
        
        function updateTimeSlotTabs() {
            const tabsContainer = document.getElementById('timeSlotTabs');
            const contentsContainer = document.getElementById('timeSlotContents');
            
            if (!tabsContainer || !contentsContainer) return;
            
            tabsContainer.innerHTML = '';
            contentsContainer.innerHTML = '';
            
            // Add "All Students" tab
            const allTab = document.createElement('div');
            allTab.className = `tab active`;
            allTab.textContent = 'All Students';
            allTab.dataset.timeSlot = 'all';
            allTab.addEventListener('click', function() {
                document.querySelectorAll('.tab').forEach(t => {
                    t.classList.remove('active');
                });
                this.classList.add('active');
                document.querySelectorAll('.tab-content').forEach(c => {
                    c.classList.remove('active');
                });
                document.getElementById('content-all').classList.add('active');
            });
            tabsContainer.appendChild(allTab);
            
            let firstTab = true;
            
            // Create tabs for each time slot
            for (const timeSlot of system.timeSlots) {
                // Create tab
                const tab = document.createElement('div');
                tab.className = `tab ${firstTab ? '' : ''}`;
                tab.textContent = timeSlot.name;
                tab.dataset.timeSlot = timeSlot.name;
                tab.addEventListener('click', function() {
                    // Remove active class from all tabs
                    document.querySelectorAll('.tab').forEach(t => {
                        t.classList.remove('active');
                    });
                    // Add active class to clicked tab
                    this.classList.add('active');
                    
                    // Hide all content
                    document.querySelectorAll('.tab-content').forEach(c => {
                        c.classList.remove('active');
                    });
                    // Show corresponding content
                    document.getElementById(`content-${timeSlot.id}`).classList.add('active');
                });
                
                tabsContainer.appendChild(tab);
                
                // Create content
                const content = document.createElement('div');
                content.id = `content-${timeSlot.id}`;
                content.className = `tab-content ${firstTab ? '' : ''}`;
                
                const students = system.getStudentsByTimeSlot(timeSlot.name, currentSearchTerm);
                
                if (students.length === 0) {
                    content.innerHTML = `<div class="empty-state">
                        <i class="fas fa-users"></i>
                        <p style="font-size: 1.2em; margin-bottom: 10px;">No students found</p>
                        <p>${currentSearchTerm ? 'No students match your search criteria' : 'Add students to this time slot to see them here'}</p>
                    </div>`;
                } else {
                    const studentGrid = createStudentGrid(students);
                    content.appendChild(studentGrid);
                }
                
                contentsContainer.appendChild(content);
                firstTab = false;
            }
            
            // Create "All Students" content
            const allContent = document.createElement('div');
            allContent.id = 'content-all';
            allContent.className = 'tab-content active';
            
            const allStudents = system.getStudentsByTimeSlot('all', currentSearchTerm);
            
            if (allStudents.length === 0) {
                allContent.innerHTML = `<div class="empty-state">
                    <i class="fas fa-users"></i>
                    <p style="font-size: 1.2em; margin-bottom: 10px;">No students found</p>
                    <p>${currentSearchTerm ? 'No students match your search criteria' : 'Add students to the system to see them here'}</p>
                </div>`;
            } else {
                const studentGrid = createStudentGrid(allStudents);
                allContent.appendChild(studentGrid);
            }
            
            contentsContainer.appendChild(allContent);
        }
        
        // ========== Â≠¶ÁîüÁÆ°ÁêÜÂáΩÊï∞ ==========
        function createStudentGrid(students) {
            const grid = document.createElement('div');
            grid.className = 'card-grid';
            
            // Add search results statistics
            const infoDiv = document.createElement('div');
            infoDiv.className = 'search-info';
            infoDiv.style.gridColumn = '1 / -1';
            infoDiv.innerHTML = `<strong>${students.length}</strong> student(s) found ${currentSearchTerm ? `matching "<em>${currentSearchTerm}</em>"` : ''}`;
            grid.appendChild(infoDiv);
            
            students.forEach(student => {
                const card = document.createElement('div');
                card.className = 'student-card-enhanced';
                
                // Determine progress bar color based on attendance rate
                let progressClass = 'progress-fill';
                let badgeClass = 'badge';
                
                // ËÆ°ÁÆóÂá∫Â∏≠ÁéáÁî®‰∫éËøõÂ∫¶Êù°È¢úËâ≤
                const attendanceRate = (student.attendanceCount / student.totalSessions * 100);
                if (attendanceRate < 60) {
                    progressClass += ' low';
                    badgeClass += ' badge-danger';
                } else if (attendanceRate < 80) {
                    progressClass += ' medium';
                    badgeClass += ' badge-warning';
                } else {
                    badgeClass += ' badge-success';
                }
                
                // Use new date formatting function
                const enrolledDate = system.formatDateForDisplay(student.enrolledDate);
                
                // Calculate remaining sessions
                const remainingSessions = student.totalSessions - student.attendanceCount;
                
                // ËÆ°ÁÆóËøõÂ∫¶Êù°ÂÆΩÂ∫¶
                const progressWidth = Math.min((student.attendanceCount / student.totalSessions) * 100, 100);
                
                card.innerHTML = `
                    <div style="position: absolute; top: 15px; right: 15px;">
                        <input type="checkbox" class="student-select-checkbox" value="${student.id}" onclick="event.stopPropagation(); updateSelectedCount();">
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px;">
                        <div>
                            <div style="font-size: 1.2em; font-weight: bold; color: var(--dark); margin: 0;">${student.name}</div>
                            <div style="color: var(--gray); font-size: 0.9em; margin: 5px 0;">${student.age || 'N/A'} years, ${student.gender || 'N/A'}</div>
                            <div style="color: var(--gray); font-size: 0.9em; margin: 5px 0;">Enrolled: ${enrolledDate}</div>
                            <div style="color: var(--gray); font-size: 0.9em; margin: 5px 0;">Remaining Sessions: ${remainingSessions}</div>
                        </div>
                        <div class="${badgeClass}">${student.attendanceCount}/${student.totalSessions}</div>
                    </div>
                    <div style="color: var(--gray); font-size: 0.9em; margin-bottom: 10px;">${student.timeSlot}</div>
                    <div class="progress-container">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 0.9em; font-weight: 500;">
                            <span>Sessions</span>
                            <span>${student.attendanceCount}/${student.totalSessions}</span>
                        </div>
                        <div class="progress-bar">
                            <div class="${progressClass}" style="width: ${progressWidth}%"></div>
                        </div>
                    </div>
                    <div style="display: flex; gap: 8px; margin-top: 15px;">
                        <button class="btn btn-info" onclick="event.stopPropagation(); editStudent('${student.id}')" style="padding: 8px 12px; font-size: 12px; flex: 1;">Edit</button>
                        <button class="btn btn-info" onclick="event.stopPropagation(); generateStudentPDF('${student.id}')" style="padding: 8px 12px; font-size: 12px; flex: 1;">PDF</button>
                        <button class="btn btn-danger" onclick="event.stopPropagation(); deleteStudent('${student.id}')" style="padding: 8px 12px; font-size: 12px; flex: 1;">Delete</button>
                    </div>
                `;
                
                // Add click event to view details
                card.addEventListener('click', function(e) {
                    // If checkbox is clicked, don't trigger detail view
                    if (e.target.type === 'checkbox') return;
                    viewStudentDetails(student.id);
                });
                
                grid.appendChild(card);
            });
            
            return grid;
        }
        
        function showAddStudentForm() {
            document.getElementById('addStudentForm').style.display = 'block';
            document.getElementById('addStudentContent').classList.add('active');
            document.getElementById('studentName').focus();
        }
        
        function hideAddStudentForm() {
            document.getElementById('addStudentForm').style.display = 'none';
        }
        
        async function addStudent() {
            const name = document.getElementById('studentName').value.trim();
            const age = document.getElementById('studentAge').value;
            const gender = document.getElementById('studentGender').value;
            const timeSlot = document.getElementById('studentTimeSlot').value;
            const enrolledDate = document.getElementById('studentEnrolledDate').value;
            const totalSessions = document.getElementById('studentTotalSessions').value || 48;
            
            if (!name || !timeSlot) {
                showToast('Please enter at least student name and select a time slot', 'error');
                return;
            }
            
            // If no enrollment date selected, default to today
            const finalEnrolledDate = system.getLocalDateString(enrolledDate);
            
            try {
                await system.addStudent(name, age, gender, timeSlot, finalEnrolledDate, totalSessions);
                document.getElementById('studentName').value = '';
                document.getElementById('studentAge').value = '';
                document.getElementById('studentGender').value = '';
                document.getElementById('studentTimeSlot').value = '';
                document.getElementById('studentEnrolledDate').value = '';
                document.getElementById('studentTotalSessions').value = '48';
                showToast('Student added successfully!', 'success');
                hideAddStudentForm();
            } catch (error) {
                showToast('Error: ' + error.message, 'error');
            }
        }
        
        function editStudent(studentId) {
            const student = system.students.get(studentId);
            if (!student) {
                showToast('Student not found!', 'error');
                return;
            }
            
            // Fill edit form
            document.getElementById('editStudentName').value = student.name;
            document.getElementById('editStudentAge').value = student.age || '';
            document.getElementById('editStudentGender').value = student.gender || '';
            document.getElementById('editStudentTimeSlot').value = student.timeSlot;
            document.getElementById('editStudentEnrolledDate').value = student.enrolledDate || system.getLocalDateString(new Date());
            document.getElementById('editStudentTotalSessions').value = student.totalSessions || 48;
            document.getElementById('editStudentId').value = studentId;
            
            // Show edit form, hide add form
            document.getElementById('editStudentForm').style.display = 'block';
            
            // Scroll to edit form
            document.getElementById('editStudentForm').scrollIntoView({ behavior: 'smooth' });
        }
        
        async function updateStudent() {
            const studentId = document.getElementById('editStudentId').value;
            const name = document.getElementById('editStudentName').value.trim();
            const age = document.getElementById('editStudentAge').value;
            const gender = document.getElementById('editStudentGender').value;
            const timeSlot = document.getElementById('editStudentTimeSlot').value;
            const enrolledDate = document.getElementById('editStudentEnrolledDate').value;
            const totalSessions = document.getElementById('editStudentTotalSessions').value || 48;
            
            if (!name || !timeSlot) {
                showToast('Please enter at least student name and select a time slot', 'error');
                return;
            }
            
            try {
                const updatedData = {
                    name,
                    age: age || '',
                    gender: gender || '',
                    timeSlot,
                    enrolledDate: system.getLocalDateString(enrolledDate),
                    totalSessions: parseInt(totalSessions) || 48
                };
                
                await system.updateStudent(studentId, updatedData);
                
                // Hide edit form
                document.getElementById('editStudentForm').style.display = 'none';
                
                showToast('Student updated successfully!', 'success');
                
            } catch (error) {
                showToast('Error updating student: ' + error.message, 'error');
            }
        }
        
        function cancelEdit() {
            document.getElementById('editStudentForm').style.display = 'none';
            // Clear form
            document.getElementById('editStudentName').value = '';
            document.getElementById('editStudentAge').value = '';
            document.getElementById('editStudentGender').value = '';
            document.getElementById('editStudentTimeSlot').value = '';
            document.getElementById('editStudentEnrolledDate').value = '';
            document.getElementById('editStudentTotalSessions').value = '48';
            document.getElementById('editStudentId').value = '';
            showToast('Edit cancelled', 'info');
        }
        
        async function deleteStudent(studentId) {
            if (confirm('Are you sure you want to delete this student?')) {
                try {
                    if (system.isOnline) {
                        await db.collection('users').doc(system.userId).collection('students')
                            .doc(studentId).delete();
                    } else {
                        system.students.delete(studentId);
                        updateUI();
                    }
                    showToast('Student deleted successfully', 'success');
                } catch (error) {
                    showToast('Error deleting student: ' + error.message, 'error');
                }
            }
        }
        
        // ========== Âá∫Âã§ËÆ∞ÂΩïÂáΩÊï∞ ==========
        function updateStudentsCheckboxes() {
            const timeSlot = document.getElementById('timeSlotSelect').value;
            const container = document.getElementById('studentsCheckboxes');
            
            if (!timeSlot) {
                container.innerHTML = '<p class="empty-state"><i class="fas fa-users"></i><br>Please select a time slot to see students</p>';
                return;
            }
            
            container.innerHTML = '';
            const students = system.getStudentsByTimeSlot(timeSlot);
            
            if (students.length === 0) {
                container.innerHTML = `<p class="empty-state"><i class="fas fa-users"></i><br>No students found for ${timeSlot}</p>`;
                return;
            }
            
            for (const student of students) {
                const label = document.createElement('label');
                label.style.cssText = 'display: block; padding: 12px; margin: 8px 0; border-radius: 8px; transition: background 0.2s; cursor: pointer;';
                label.innerHTML = `
                    <input type="checkbox" value="${student.id}" style="margin-right: 10px;">
                    ${student.name} (${student.age || 'N/A'}, ${student.gender || 'N/A'})
                `;
                container.appendChild(label);
            }
        }
        
        function selectAllCheckboxes() {
            const checkboxes = document.querySelectorAll('#studentsCheckboxes input[type="checkbox"]');
            checkboxes.forEach(cb => cb.checked = true);
        }
        
        function deselectAllCheckboxes() {
            const checkboxes = document.querySelectorAll('#studentsCheckboxes input[type="checkbox"]');
            checkboxes.forEach(cb => cb.checked = false);
        }
        
        async function recordAttendance() {
            console.log("üöÄ Starting attendance recording..."); 
        
            // Get input fields
            const dateInput = document.getElementById('classDate');
            const timeSlotInput = document.getElementById('timeSlotSelect'); 
            const topicInput = document.getElementById('sessionTopic');
        
            // Safety check
            if (!dateInput || !timeSlotInput) {
                alert("‚ùå System error: Missing required input fields");
                return;
            }
        
            let date = dateInput.value;
            const timeSlot = timeSlotInput.value;
            const topic = topicInput.value || '';
            
            // Â¶ÇÊûúÊó•Êúü‰∏∫Á©∫Ôºå‰ΩøÁî®‰ªäÂ§©
            if (!date) {
                date = system.getLocalDateString(new Date());
                dateInput.value = date;
            }
            
            // Á°Æ‰øùÊó•ÊúüÊ†ºÂºèÊ≠£Á°ÆÔºàÊú¨Âú∞Êó•ÊúüÔºâ
            date = system.getLocalDateString(date);
            
            // Get checked students
            const selectedCheckboxes = document.querySelectorAll('#studentsCheckboxes input:checked');
            const selectedStudentIds = Array.from(selectedCheckboxes).map(cb => cb.value);
        
            // Basic validation
            if (!date || !timeSlot) {
                showToast('Please select date and time slot', 'error');
                return;
            }
        
            if (selectedStudentIds.length === 0) {
                showToast('Please select at least one student', 'error');
                return;
            }
        
            // Lock button
            const btn = document.querySelector('button[onclick*="recordAttendance"]');
            const originalBtnText = btn ? btn.innerHTML : 'Record Attendance';
            if (btn) {
                btn.disabled = true;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Recording...';
            }
        
            try {
                // Create record ID
                const recordId = `${timeSlot.replace(/\s+/g, '-')}-${date}`.replace(/[^a-zA-Z0-9\-]/g, '');
                
                // Check if record already exists in system
                const existingRecord = system.attendanceRecords.find(record => 
                    record.timeSlot === timeSlot && record.date === date
                );
                
                if (existingRecord) {
                    if (confirm(`Attendance for ${timeSlot} on ${system.formatDateForDisplay(date)} already exists. Update it?`)) {
                        // ‰øÆÂ§çÔºöÊõ¥Êñ∞Áé∞ÊúâËÆ∞ÂΩïÊó∂ÔºåÂè™Ê∑ªÂä†Êñ∞ÁöÑÂ≠¶ÁîüÔºå‰∏çÈáçÂ§çÊ∑ªÂä†Â∑≤Â≠òÂú®ÁöÑÂ≠¶Áîü
                        const existingStudents = new Set(existingRecord.presentStudents);
                        const newStudents = selectedStudentIds.filter(id => !existingStudents.has(id));
                        
                        if (newStudents.length === 0) {
                            showToast('All selected students are already marked present', 'info');
                            if (btn) {
                                btn.disabled = false;
                                btn.innerHTML = originalBtnText;
                            }
                            return;
                        }
                        
                        const updatedPresentStudents = [...existingRecord.presentStudents, ...newStudents];
                        
                        if (system.isOnline) {
                            await db.collection('users').doc(system.userId).collection('attendance')
                                .doc(recordId).update({
                                    presentStudents: updatedPresentStudents,
                                    topic: topic || existingRecord.topic
                                });
                        } else {
                            existingRecord.presentStudents = updatedPresentStudents;
                            existingRecord.topic = topic || existingRecord.topic;
                        }
                        
                        // ‰øÆÂ§çÔºöÂè™Êõ¥Êñ∞Êñ∞Ê∑ªÂä†ÁöÑÂ≠¶ÁîüÂá∫Âã§Êï∞ÊçÆ
                        for (const studentId of newStudents) {
                            const student = system.students.get(studentId);
                            if (student && student.enrolledDate <= date) {
                                if (!student.attendanceDates) student.attendanceDates = [];
                                if (!student.attendanceDates.includes(date)) {
                                    student.attendanceDates.push(date);
                                    
                                    // Remove duplicates
                                    const uniqueDates = [...new Set(student.attendanceDates)];
                                    student.attendanceDates = uniqueDates;
                                    student.attendanceCount = uniqueDates.length;
                                    
                                    if (system.isOnline) {
                                        await db.collection('users').doc(system.userId).collection('students')
                                            .doc(studentId).update({
                                                attendanceDates: uniqueDates,
                                                attendanceCount: uniqueDates.length,
                                                lastAttended: date
                                            });
                                    }
                                }
                            }
                        }
                        
                        showToast(`‚úÖ Updated attendance for ${timeSlot} on ${system.formatDateForDisplay(date)} (${newStudents.length} new students)`, 'success');
                    } else {
                        showToast('Operation cancelled', 'info');
                        if (btn) {
                            btn.disabled = false;
                            btn.innerHTML = originalBtnText;
                        }
                        return;
                    }
                } else {
                    // Create new record
                    const record = {
                        id: recordId,
                        timeSlot: timeSlot,
                        date: date,
                        topic: topic,
                        presentStudents: selectedStudentIds,
                        recordedAt: new Date().toISOString()
                    };
                    
                    if (system.isOnline) {
                        await db.collection('users').doc(system.userId).collection('attendance')
                            .doc(recordId).set(record);
                    } else {
                        system.attendanceRecords.push(record);
                    }
                    
                    // ‰øÆÂ§çÔºöÊõ¥Êñ∞Â≠¶ÁîüÂá∫Âã§Êï∞ÊçÆÔºåÁ°Æ‰øùÊ≤°ÊúâÈáçÂ§ç
                    for (const studentId of selectedStudentIds) {
                        const student = system.students.get(studentId);
                        if (student && student.enrolledDate <= date) {
                            if (!student.attendanceDates) student.attendanceDates = [];
                            
                            // ‰øÆÂ§çÔºöÊ£ÄÊü•ËØ•Êó•ÊúüÊòØÂê¶Â∑≤Â≠òÂú®
                            if (!student.attendanceDates.includes(date)) {
                                student.attendanceDates.push(date);
                                
                                // Remove duplicates
                                const uniqueDates = [...new Set(student.attendanceDates)];
                                student.attendanceDates = uniqueDates;
                                student.attendanceCount = uniqueDates.length;
                                
                                if (system.isOnline) {
                                    await db.collection('users').doc(system.userId).collection('students')
                                        .doc(studentId).update({
                                            attendanceDates: uniqueDates,
                                            attendanceCount: uniqueDates.length,
                                            lastAttended: date
                                        });
                                }
                            }
                        }
                    }
                    
                    showToast(`‚úÖ Attendance recorded for ${selectedStudentIds.length} student(s)`, 'success');
                }
        
                // Refresh interface
                updateClassAttendanceRecords();
                updateStudentAttendanceSummary();
                updateUI();
        
                // Clear checkboxes
                selectedCheckboxes.forEach(cb => cb.checked = false);
                document.getElementById('sessionTopic').value = '';
        
            } catch (error) {
                console.error("Error:", error);
                showToast('Error: ' + error.message, 'error');
            } finally {
                if (btn) {
                    btn.disabled = false;
                    btn.innerHTML = originalBtnText;
                }
            }
        }
        
        // ========== ËÆ∞ÂΩïÊü•ÁúãÂáΩÊï∞ ==========
        function updateClassAttendanceRecords() {
            const tbody = document.getElementById('classAttendanceRecords');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            const timeSlotFilter = document.getElementById('classFilterTimeSlot').value;
            
            // Copy and sort attendance records (by date descending)
            const sortedRecords = [...system.attendanceRecords].sort((a, b) => 
                new Date(b.date) - new Date(a.date)
            );
            
            sortedRecords.forEach(record => {
                // Apply time slot filter
                if (timeSlotFilter !== 'all' && record.timeSlot !== timeSlotFilter) {
                    return;
                }
                
                const row = document.createElement('tr');
                
                // Format date
                const formattedDate = system.formatDateForDisplay(record.date);
                
                // Get present student names
                const presentStudentNames = record.presentStudents.map(studentId => {
                    const student = system.students.get(studentId);
                    return student ? student.name : 'Unknown Student';
                }).join(', ');
                
                row.innerHTML = `
                    <td>${formattedDate}</td>
                    <td>${record.timeSlot}</td>
                    <td>${record.topic || 'No topic'}</td>
                    <td>${presentStudentNames}</td>
                    <td>
                        <button class="btn btn-info" onclick="viewClassAttendanceDetails('${record.id}')" style="padding: 6px 12px; font-size: 12px;">View</button>
                        <button class="btn btn-danger" onclick="deleteClassAttendanceRecord('${record.id}')" style="padding: 6px 12px; font-size: 12px;">Delete</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
            
            if (sortedRecords.length === 0 || tbody.children.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 20px; color: var(--gray);">No attendance records found</td></tr>';
            }
        }
        
        function updateStudentAttendanceSummary() {
            const tbody = document.getElementById('studentAttendanceSummary');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            const timeSlotFilter = document.getElementById('studentFilterTimeSlot').value;
            const studentFilter = document.getElementById('studentFilterStudent').value;
            const allAttendance = system.getAllAttendance();
            
            allAttendance.forEach(student => {
                // Apply filters if needed
                if (timeSlotFilter !== 'all' && student.timeSlot !== timeSlotFilter) {
                    return;
                }
                
                if (studentFilter !== 'all' && student.id !== studentFilter) {
                    return;
                }
                
                const row = document.createElement('tr');
                
                // Use new date formatting function
                const enrolledDate = system.formatDateForDisplay(student.enrolledDate);
                
                // Calculate remaining sessions
                const remainingSessions = student.totalSessions - student.attendanceCount;
                
                row.innerHTML = `
                    <td>${student.name}</td>
                    <td>${student.age || 'N/A'}</td>
                    <td>${student.gender || 'N/A'}</td>
                    <td>${student.timeSlot}</td>
                    <td>${student.attendanceCount}</td>
                    <td>${student.totalSessions}</td>
                    <td>
                        <button class="btn btn-info" onclick="viewStudentDetails('${student.id}')" style="padding: 6px 12px; font-size: 12px;">View Details</button>
                        <button class="btn btn-info" onclick="generateStudentPDF('${student.id}')" style="padding: 6px 12px; font-size: 12px; margin-top: 5px;">PDF</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
            
            if (allAttendance.length === 0 || tbody.children.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 20px; color: var(--gray);">No students found</td></tr>';
            }
        }
        
        function updateFilterStudent() {
            const studentFilterSelect = document.getElementById('studentFilterStudent');
            if (!studentFilterSelect) return;
            
            const allOption = studentFilterSelect.querySelector('option[value="all"]');
            studentFilterSelect.innerHTML = '';
            studentFilterSelect.appendChild(allOption);
            
            for (const student of system.students.values()) {
                const option = document.createElement('option');
                option.value = student.id;
                option.textContent = `${student.name} (${student.timeSlot})`;
                studentFilterSelect.appendChild(option);
            }
        }
        
        function showRecordTab(tabId) {
            // ÈöêËóèÊâÄÊúâÊ†áÁ≠æÂÜÖÂÆπ
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.style.display = 'none';
            });
            
            // ÁßªÈô§ÊâÄÊúâÊ†áÁ≠æÁöÑÊøÄÊ¥ªÁä∂ÊÄÅ
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // ÊòæÁ§∫ÈÄâ‰∏≠ÁöÑÊ†áÁ≠æÂÜÖÂÆπ
            document.getElementById(tabId).style.display = 'block';
            
            // ÊøÄÊ¥ªÈÄâ‰∏≠ÁöÑÊ†áÁ≠æ
            event.target.classList.add('active');
            
            // Ê†πÊçÆÊ†áÁ≠æÊõ¥Êñ∞ÂÜÖÂÆπ
            if (tabId === 'classRecords') {
                updateClassAttendanceRecords();
            } else if (tabId === 'studentRecords') {
                updateStudentAttendanceSummary();
            }
        }
        
        // ========== Êó∂Èó¥ÊßΩÊòæÁ§∫ÂáΩÊï∞ ==========
        function updateTimeSlots() {
            const container = document.getElementById('timeSlotsContainer');
            if (!container) return;
            
            container.innerHTML = '';
            
            // System has already sorted time slots, use directly
            for (const timeSlot of system.timeSlots) {
                const students = system.getStudentsByTimeSlot(timeSlot.name);
                
                const timeSlotCard = document.createElement('div');
                timeSlotCard.className = 'feature-card';
                
                const header = document.createElement('div');
                header.style.cssText = 'display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;';
                
                const title = document.createElement('div');
                title.style.cssText = 'font-size: 1.3em; font-weight: bold; color: var(--dark);';
                title.textContent = timeSlot.name;
                
                const count = document.createElement('div');
                count.className = 'badge';
                count.textContent = `${students.length} student${students.length !== 1 ? 's' : ''}`;
                
                header.appendChild(title);
                header.appendChild(count);
                
                const studentsContainer = document.createElement('div');
                studentsContainer.className = 'card-grid';
                
                if (students.length === 0) {
                    studentsContainer.innerHTML = '<p class="empty-state">No students in this time slot</p>';
                } else {
                    students.forEach(student => {
                        const studentCard = document.createElement('div');
                        studentCard.className = 'student-card-enhanced';
                        
                        // Use new date formatting function
                        const enrolledDate = system.formatDateForDisplay(student.enrolledDate);
                        
                        // Calculate remaining sessions
                        const remainingSessions = student.totalSessions - student.attendanceCount;
                        
                        studentCard.innerHTML = `
                            <strong>${student.name}</strong><br>
                            ${student.age || 'N/A'} years, ${student.gender || 'N/A'}<br>
                            Enrolled: ${enrolledDate}<br>
                            Total Sessions: ${student.totalSessions}<br>
                            Sessions Attended: ${student.attendanceCount}<br>
                            Remaining Sessions: ${remainingSessions}
                        `;
                        studentsContainer.appendChild(studentCard);
                    });
                }
                
                timeSlotCard.appendChild(header);
                timeSlotCard.appendChild(studentsContainer);
                container.appendChild(timeSlotCard);
            }
        }
        
        // ========== ÊâπÈáèÊìç‰ΩúÂáΩÊï∞ ==========
        function updateSelectedCount() {
            const checkboxes = document.querySelectorAll('.student-select-checkbox:checked');
            const countElement = document.getElementById('selectedCount');
            if (countElement) {
                countElement.textContent = `Selected: ${checkboxes.length} student(s)`;
            }
        }
        
        function selectAllStudents() {
            const checkboxes = document.querySelectorAll('.student-select-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.checked = true;
            });
            updateSelectedCount();
            showToast(`Selected all ${checkboxes.length} students`, 'info');
        }
        
        function deselectAllStudents() {
            const checkboxes = document.querySelectorAll('.student-select-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.checked = false;
            });
            updateSelectedCount();
            showToast('Deselected all', 'info');
        }
        
        // ========== ÊäòÂè†Èù¢ÊùøÂáΩÊï∞ ==========
        function toggleCollapse(id) {
            const content = document.getElementById(id);
            const header = content.parentElement.querySelector('.collapse-header');
            const icon = header.querySelector('.fa-chevron-down');
            
            content.classList.toggle('active');
            icon.classList.toggle('fa-chevron-down');
            icon.classList.toggle('fa-chevron-up');
        }
        
        // ========== Â≠¶ÁîüËØ¶ÊÉÖÂáΩÊï∞ ==========
        function viewStudentDetails(studentId) {
            const student = system.students.get(studentId);
            if (!student) {
                showToast('Student not found!', 'error');
                return;
            }
            
            currentSelectedStudentId = studentId;
            
            // Get student attendance information
            const attendanceInfo = system.getStudentAttendance(studentId);
            
            // Calculate remaining sessions
            const remainingSessions = student.totalSessions - attendanceInfo.attendanceCount;
            
            // Get last attended date
            const lastAttended = student.attendanceDates && student.attendanceDates.length > 0 
                ? system.formatDateForDisplay(student.attendanceDates[student.attendanceDates.length - 1])
                : 'Never attended';
            
            // Create modal content
            const content = document.getElementById('studentDetailsContent');
            content.innerHTML = `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 25px;">
                    <div>
                        <h4 style="color: var(--dark); margin-bottom: 10px;">üë§ Personal Information</h4>
                        <p><strong>Name:</strong> ${student.name}</p>
                        <p><strong>Age:</strong> ${student.age || "N/A"}</p>
                        <p><strong>Gender:</strong> ${student.gender || "N/A"}</p>
                        <p><strong>Time Slot:</strong> ${student.timeSlot}</p>
                        <p><strong>Enrolled Date:</strong> ${system.formatDateForDisplay(student.enrolledDate)}</p>
                        <p><strong>Total Sessions:</strong> ${student.totalSessions}</p>
                    </div>
                    <div>
                        <h4 style="color: var(--dark); margin-bottom: 10px;">üìä Attendance Summary</h4>
                        <p><strong>Sessions Attended:</strong> ${attendanceInfo.attendanceCount}</p>
                        <p><strong>Remaining Sessions:</strong> ${remainingSessions}</p>
                        <p><strong>Last Attended:</strong> ${lastAttended}</p>
                    </div>
                </div>
                
                <div style="margin-top: 20px;">
                    <h4 style="color: var(--dark); margin-bottom: 15px;">üìÖ All Attendance Dates (${attendanceInfo.attendanceCount} dates)</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 8px; margin-top: 10px;">
                        ${student.attendanceDates && student.attendanceDates.length > 0 ? 
                            [...student.attendanceDates].sort().map(date => `
                                <div style="background: #f0f9ff; border: 1px solid #cfe2ff; border-radius: 6px; padding: 8px; text-align: center; font-size: 12px; color: #0d6efd;">
                                    ${system.formatDateForDisplay(date)}
                                </div>
                            `).join('') : 
                            '<p style="color: var(--gray);">No attendance records found</p>'
                        }
                    </div>
                </div>
                
                <div style="display: flex; flex-direction: column; gap: 10px; margin-top: 25px;">
                    <button class="btn btn-info" onclick="editCurrentStudent()">
                        <i class="fas fa-edit"></i> Edit Student
                    </button>
                    <button class="btn btn-success" onclick="openDateSelectionForSingleStudent()">
                        <i class="fas fa-calendar-plus"></i> Add Attendance Dates
                    </button>
                    <button class="btn" onclick="generateStudentPDF('${studentId}')">
                        <i class="fas fa-file-pdf"></i> Download PDF Report
                    </button>
                    <button class="btn btn-secondary" onclick="closeStudentDetails()">Close</button>
                </div>
            `;
            
            // Show modal
            document.getElementById('studentDetailsModal').style.display = 'flex';
        }
        
        function closeStudentDetails() {
            document.getElementById('studentDetailsModal').style.display = 'none';
            currentSelectedStudentId = '';
        }
        
        function editCurrentStudent() {
            if (currentSelectedStudentId) {
                editStudent(currentSelectedStudentId);
                closeStudentDetails();
            }
        }
        
        // ========== Êó•ÂéÜÂäüËÉΩÂáΩÊï∞ ==========
        function openDateSelectionForSingleStudent() {
            if (!currentSelectedStudentId) {
                showToast('Please select a student first', 'error');
                return;
            }
            
            const student = system.students.get(currentSelectedStudentId);
            if (!student) {
                showToast('Student information not found', 'error');
                return;
            }
            
            dateSelectionMode = 'single';
            dateSelectionStudentId = currentSelectedStudentId;
            selectedDates.clear();
            
            // Pre-select student's existing attendance dates
            if (student.attendanceDates && student.attendanceDates.length > 0) {
                student.attendanceDates.forEach(date => {
                    selectedDates.add(date);
                });
            }
            
            document.getElementById('dateSelectionTitle').textContent = `Select Attendance Dates for ${student.name}`;
            document.getElementById('dateSelectionModal').style.display = 'flex';
            
            renderCalendar();
        }
        
        function openDateSelectionForBatch() {
            const selectedCheckboxes = document.querySelectorAll('.student-select-checkbox:checked');
            if (selectedCheckboxes.length === 0) {
                showToast('Please select at least one student first', 'error');
                return;
            }
            
            dateSelectionMode = 'batch';
            dateSelectionStudentIds = Array.from(selectedCheckboxes).map(cb => cb.value);
            selectedDates.clear();
            
            document.getElementById('dateSelectionTitle').textContent = `Select Attendance Dates for ${dateSelectionStudentIds.length} students`;
            document.getElementById('dateSelectionModal').style.display = 'flex';
            
            renderCalendar();
        }
        
        function closeDateSelectionModal() {
            document.getElementById('dateSelectionModal').style.display = 'none';
            selectedDates.clear();
            dateSelectionMode = '';
            dateSelectionStudentId = '';
            dateSelectionStudentIds = [];
        }
        
        function renderCalendar() {
            const container = document.getElementById('calendarContainer');
            container.innerHTML = '';
            
            const year = currentCalendarDate.getFullYear();
            const month = currentCalendarDate.getMonth();
            
            // Create calendar header with month navigation
            const header = document.createElement('div');
            header.style.cssText = 'display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;';
            
            const monthNav = document.createElement('div');
            monthNav.style.cssText = 'display: flex; align-items: center; gap: 15px;';
            
            const prevBtn = document.createElement('button');
            prevBtn.className = 'btn btn-secondary';
            prevBtn.innerHTML = '<i class="fas fa-chevron-left"></i>';
            prevBtn.onclick = () => {
                currentCalendarDate.setMonth(currentCalendarDate.getMonth() - 1);
                renderCalendar();
            };
            
            const nextBtn = document.createElement('button');
            nextBtn.className = 'btn btn-secondary';
            nextBtn.innerHTML = '<i class="fas fa-chevron-right"></i>';
            nextBtn.onclick = () => {
                currentCalendarDate.setMonth(currentCalendarDate.getMonth() + 1);
                renderCalendar();
            };
            
            const monthLabel = document.createElement('span');
            monthLabel.style.cssText = 'font-weight: bold; font-size: 1.2em;';
            const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
            monthLabel.textContent = `${monthNames[month]} ${year}`;
            
            monthNav.appendChild(prevBtn);
            monthNav.appendChild(monthLabel);
            monthNav.appendChild(nextBtn);
            
            header.appendChild(monthNav);
            
            // Create calendar grid
            const grid = document.createElement('div');
            grid.style.cssText = 'display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; margin-bottom: 20px;';
            
            // Add day headers
            const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            days.forEach(day => {
                const dayElement = document.createElement('div');
                dayElement.style.cssText = 'text-align: center; font-weight: bold; color: var(--gray); padding: 8px; font-size: 0.9em;';
                dayElement.textContent = day;
                grid.appendChild(dayElement);
            });
            
            // Get first and last day of month
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            
            // Calculate which day of week the first day is (0 = Sunday, 1 = Monday, ...)
            const firstDayIndex = firstDay.getDay();
            
            // Add empty cells (previous month dates)
            for (let i = 0; i < firstDayIndex; i++) {
                const emptyDay = document.createElement('div');
                emptyDay.style.cssText = 'aspect-ratio: 1; display: flex; align-items: center; justify-content: center; border-radius: 8px; color: #ccc;';
                grid.appendChild(emptyDay);
            }
            
            // Add dates for current month
            const today = new Date();
            const todayStr = system.getLocalDateString(today);
            
            for (let day = 1; day <= lastDay.getDate(); day++) {
                const date = new Date(year, month, day);
                const dateStr = system.getLocalDateString(date);
                
                const dayElement = document.createElement('div');
                dayElement.style.cssText = 'aspect-ratio: 1; display: flex; align-items: center; justify-content: center; border-radius: 8px; cursor: pointer; transition: all 0.2s ease; border: 2px solid transparent; font-size: 0.9em;';
                dayElement.textContent = day;
                dayElement.dataset.date = dateStr;
                
                // If today
                if (dateStr === todayStr) {
                    dayElement.style.borderColor = 'var(--primary)';
                    dayElement.style.color = 'var(--primary)';
                }
                
                // If already selected
                if (selectedDates.has(dateStr)) {
                    dayElement.style.backgroundColor = 'var(--primary)';
                    dayElement.style.color = 'white';
                }
                
                // Click event
                dayElement.addEventListener('click', () => {
                    if (selectedDates.has(dateStr)) {
                        selectedDates.delete(dateStr);
                        dayElement.style.backgroundColor = '';
                        dayElement.style.color = '';
                    } else {
                        selectedDates.add(dateStr);
                        dayElement.style.backgroundColor = 'var(--primary)';
                        dayElement.style.color = 'white';
                    }
                    updateSelectedDatesList();
                });
                
                grid.appendChild(dayElement);
            }
            
            // Create selected dates summary
            const summary = document.createElement('div');
            summary.style.cssText = 'margin-top: 15px; padding: 15px; background-color: #f8f9fa; border-radius: 8px; border-left: 4px solid var(--info);';
            
            const summaryTitle = document.createElement('p');
            summaryTitle.innerHTML = `<strong>Selected Dates:</strong> <span id="selectedDatesCount">0</span> days`;
            
            const datesList = document.createElement('div');
            datesList.id = 'selectedDatesList';
            datesList.style.cssText = 'margin-top: 10px; max-height: 100px; overflow-y: auto;';
            
            summary.appendChild(summaryTitle);
            summary.appendChild(datesList);
            
            // Create action buttons
            const actions = document.createElement('div');
            actions.style.cssText = 'margin-top: 20px; display: flex; gap: 10px; justify-content: flex-end;';
            
            const cancelBtn = document.createElement('button');
            cancelBtn.className = 'btn btn-secondary';
            cancelBtn.textContent = 'Cancel';
            cancelBtn.onclick = closeDateSelectionModal;
            
            const saveBtn = document.createElement('button');
            saveBtn.className = 'btn btn-success';
            saveBtn.textContent = 'Save Selection';
            saveBtn.onclick = saveSelectedDates;
            
            actions.appendChild(cancelBtn);
            actions.appendChild(saveBtn);
            
            // Assemble calendar
            container.appendChild(header);
            container.appendChild(grid);
            container.appendChild(summary);
            container.appendChild(actions);
            
            // Update selected dates list
            updateSelectedDatesList();
        }
        
        function updateSelectedDatesList() {
            const countElement = document.getElementById('selectedDatesCount');
            const listElement = document.getElementById('selectedDatesList');
            
            if (countElement) {
                countElement.textContent = selectedDates.size;
            }
            
            if (listElement) {
                if (selectedDates.size === 0) {
                    listElement.innerHTML = '<p style="color: var(--gray); font-style: italic;">No dates selected</p>';
                } else {
                    const datesArray = Array.from(selectedDates).sort();
                    listElement.innerHTML = datesArray.map(date => {
                        const formattedDate = system.formatDateForDisplay(date);
                        return `<div style="padding: 4px 8px; background: #e8f4fd; margin: 2px 0; border-radius: 4px;">${formattedDate}</div>`;
                    }).join('');
                }
            }
        }
        
        async function saveSelectedDates() {
            if (selectedDates.size === 0) {
                showToast('Please select at least one date', 'error');
                return;
            }
            
            try {
                let result;
                
                if (dateSelectionMode === 'single') {
                    const processedCount = await saveDatesForSingleStudent();
                    result = `Successfully added ${processedCount} attendance date(s)`;
                } else if (dateSelectionMode === 'batch') {
                    const batchResult = await saveDatesForBatchStudents();
                    result = `Successfully processed ${batchResult.processedStudents} students across ${selectedDates.size} date(s)`;
                }
                
                closeDateSelectionModal();
                showToast(result, 'success');
                
                // Refresh interface
                updateUI();
                
            } catch (error) {
                console.error('Error saving dates:', error);
                showToast('Save failed: ' + error.message, 'error');
            }
        }
        
        async function saveDatesForSingleStudent() {
            const student = system.students.get(dateSelectionStudentId);
            if (!student) {
                throw new Error('Student does not exist');
            }
            
            const timeSlot = student.timeSlot;
            let processedCount = 0;
            
            // Create attendance records for each selected date
            for (const dateStr of selectedDates) {
                // Check if after enrollment date
                if (dateStr < student.enrolledDate) {
                    console.log(`Skip date ${dateStr}, before enrollment date ${student.enrolledDate}`);
                    continue;
                }
                
                // Check if student already has attendance for this date
                const alreadyAttended = student.attendanceDates && 
                                      student.attendanceDates.includes(dateStr);
                
                if (!alreadyAttended) {
                    // Create attendance record
                    const recordId = `${timeSlot.replace(/\s+/g, '-')}-${dateStr}`.replace(/[^a-zA-Z0-9\-]/g, '');
                    const recordRef = db.collection('users').doc(system.userId).collection('attendance').doc(recordId);
                    
                    try {
                        const doc = await recordRef.get();
                        
                        if (doc.exists) {
                            // If record exists, add student to presentStudents array
                            await recordRef.update({
                                presentStudents: firebase.firestore.FieldValue.arrayUnion(dateSelectionStudentId)
                            });
                        } else {
                            // Create new record
                            await recordRef.set({
                                id: recordId,
                                timeSlot: timeSlot,
                                date: dateStr,
                                topic: 'Batch Added',
                                presentStudents: [dateSelectionStudentId],
                                recordedAt: new Date().toISOString()
                            });
                        }
                        
                        // Update student attendance data
                        if (!student.attendanceDates) student.attendanceDates = [];
                        student.attendanceDates.push(dateStr);
                        
                        // Remove duplicates
                        const uniqueDates = [...new Set(student.attendanceDates)];
                        student.attendanceDates = uniqueDates;
                        student.attendanceCount = uniqueDates.length;
                        
                        if (system.isOnline) {
                            await db.collection('users').doc(system.userId).collection('students')
                                .doc(dateSelectionStudentId).update({
                                    attendanceDates: uniqueDates,
                                    attendanceCount: uniqueDates.length,
                                    lastAttended: dateStr
                                });
                        }
                        
                        processedCount++;
                        
                    } catch (error) {
                        console.error('Error processing date:', dateStr, error);
                    }
                }
            }
            
            return processedCount;
        }
        
        async function saveDatesForBatchStudents() {
            const batch = db.batch();
            const studentUpdates = [];
            const attendanceRecords = new Map(); // Group records by date and time slot
            
            // Prepare student updates
            for (const studentId of dateSelectionStudentIds) {
                const student = system.students.get(studentId);
                if (!student) continue;
                
                for (const dateStr of selectedDates) {
                    // Check if after enrollment date
                    if (dateStr < student.enrolledDate) {
                        continue;
                    }
                    
                    // Check if student already has attendance for this date
                    const alreadyAttended = student.attendanceDates && 
                                          student.attendanceDates.includes(dateStr);
                    
                    if (!alreadyAttended) {
                        // Record attendance to be added
                        const key = `${student.timeSlot}-${dateStr}`;
                        if (!attendanceRecords.has(key)) {
                            attendanceRecords.set(key, {
                                timeSlot: student.timeSlot,
                                date: dateStr,
                                studentIds: []
                            });
                        }
                        attendanceRecords.get(key).studentIds.push(studentId);
                        
                        // Record student updates
                        studentUpdates.push({
                            studentId: studentId,
                            date: dateStr
                        });
                    }
                }
            }
            
            // Create/update attendance records
            for (const [key, recordData] of attendanceRecords) {
                const recordId = `${recordData.timeSlot.replace(/\s+/g, '-')}-${recordData.date}`.replace(/[^a-zA-Z0-9\-]/g, '');
                const recordRef = db.collection('users').doc(system.userId).collection('attendance').doc(recordId);
                
                // Check if record exists
                const doc = await recordRef.get();
                
                if (doc.exists) {
                    // Update existing record
                    batch.update(recordRef, {
                        presentStudents: firebase.firestore.FieldValue.arrayUnion(...recordData.studentIds)
                    });
                } else {
                    // Create new record
                    batch.set(recordRef, {
                        id: recordId,
                        timeSlot: recordData.timeSlot,
                        date: recordData.date,
                        topic: 'Batch Added',
                        presentStudents: recordData.studentIds,
                        recordedAt: new Date().toISOString()
                    });
                }
            }
            
            // Update student data
            for (const update of studentUpdates) {
                const student = system.students.get(update.studentId);
                if (student) {
                    const studentRef = db.collection('users').doc(system.userId).collection('students').doc(update.studentId);
                    
                    // Get current data to calculate new array
                    const studentDoc = await studentRef.get();
                    const currentData = studentDoc.data();
                    const currentDates = currentData.attendanceDates || [];
                    
                    if (!currentDates.includes(update.date)) {
                        batch.update(studentRef, {
                            attendanceDates: firebase.firestore.FieldValue.arrayUnion(update.date),
                            attendanceCount: firebase.firestore.FieldValue.increment(1),
                            lastAttended: update.date
                        });
                    }
                }
            }
            
            // Commit all changes
            await batch.commit();
            
            return {
                processedDates: selectedDates.size,
                processedStudents: dateSelectionStudentIds.length,
                attendanceRecordsCreated: attendanceRecords.size
            };
        }
        
        // ========== Â∑•ÂÖ∑ÂáΩÊï∞ ==========
        async function fixDuplicateAttendance() {
            if (!confirm('This will scan all students and remove duplicate attendance dates. Continue?')) {
                return;
            }
            
            try {
                updateSyncStatus('üîß Scanning for duplicate attendance...', 'syncing');
                
                const fixedCount = await system.fixDuplicateAttendance();
                
                // Update last checked time
                const now = new Date();
                document.getElementById('lastDuplicateCheck').textContent = now.toLocaleString();
                
                updateSyncStatus('‚úÖ System synchronized', 'synced');
                showToast(`Fixed duplicate attendance for ${fixedCount} student(s)`, 'success');
                
                // Refresh UI
                updateUI();
                
            } catch (error) {
                console.error('Error fixing duplicates:', error);
                showToast('Error fixing duplicates: ' + error.message, 'error');
                updateSyncStatus('‚ùå Error fixing duplicates', 'error');
            }
        }
        
        async function recalculateAllAttendance() {
            if (!confirm('Recalculate attendance for all students based on actual records? This may take a moment.')) {
                return;
            }
            
            try {
                updateSyncStatus('üìä Recalculating attendance...', 'syncing');
                
                const recalculatedCount = await system.recalculateAllAttendance();
                
                updateSyncStatus('‚úÖ System synchronized', 'synced');
                showToast(`Recalculated attendance for ${recalculatedCount} student(s)`, 'success');
                
                // Refresh UI
                updateUI();
                
            } catch (error) {
                console.error('Error recalculating attendance:', error);
                showToast('Error recalculating attendance: ' + error.message, 'error');
                updateSyncStatus('‚ùå Error recalculating attendance', 'error');
            }
        }
        
        async function cleanOrphanedData() {
            if (!confirm('Clean orphaned attendance records (records with no corresponding students)?')) {
                return;
            }
            
            try {
                updateSyncStatus('üßπ Cleaning orphaned data...', 'syncing');
                
                const cleanedCount = await system.cleanOrphanedData();
                
                updateSyncStatus('‚úÖ System synchronized', 'synced');
                showToast(`Cleaned ${cleanedCount} orphaned attendance records`, 'success');
                
                // Refresh UI
                updateUI();
                
            } catch (error) {
                console.error('Error cleaning orphaned data:', error);
                showToast('Error cleaning data: ' + error.message, 'error');
                updateSyncStatus('‚ùå Error cleaning data', 'error');
            }
        }
        
        async function runSystemHealthCheck() {
            const resultElement = document.getElementById('healthCheckResult');
            resultElement.innerHTML = '<div class="loading"></div> Running health check...';
            
            try {
                let issues = [];
                
                // Check 1: Duplicate attendance dates
                let duplicateCount = 0;
                for (const student of system.students.values()) {
                    if (student.attendanceDates) {
                        const uniqueDates = [...new Set(student.attendanceDates)];
                        if (uniqueDates.length !== student.attendanceDates.length) {
                            duplicateCount++;
                        }
                    }
                }
                
                if (duplicateCount > 0) {
                    issues.push(`Found ${duplicateCount} student(s) with duplicate attendance dates`);
                }
                
                // Check 2: Orphaned attendance records
                let orphanedCount = 0;
                for (const record of system.attendanceRecords) {
                    let hasValidStudents = false;
                    for (const studentId of record.presentStudents) {
                        if (system.students.has(studentId)) {
                            hasValidStudents = true;
                            break;
                        }
                    }
                    if (!hasValidStudents) {
                        orphanedCount++;
                    }
                }
                
                if (orphanedCount > 0) {
                    issues.push(`Found ${orphanedCount} orphaned attendance records`);
                }
                
                // Check 3: Students without time slots
                let noTimeSlotCount = 0;
                for (const student of system.students.values()) {
                    if (!student.timeSlot || student.timeSlot.trim() === '') {
                        noTimeSlotCount++;
                    }
                }
                
                if (noTimeSlotCount > 0) {
                    issues.push(`Found ${noTimeSlotCount} student(s) without time slot assignment`);
                }
                
                // Display results
                if (issues.length === 0) {
                    resultElement.innerHTML = '<div style="color: var(--success);">‚úÖ System health is good. No issues found.</div>';
                } else {
                    let html = '<div style="color: var(--warning);">‚ö†Ô∏è Found ' + issues.length + ' issue(s):</div><ul style="margin-top: 10px;">';
                    issues.forEach(issue => {
                        html += `<li style="margin-bottom: 5px;">${issue}</li>`;
                    });
                    html += '</ul>';
                    resultElement.innerHTML = html;
                }
                
            } catch (error) {
                console.error('Error running health check:', error);
                resultElement.innerHTML = '<div style="color: var(--danger);">‚ùå Error running health check: ' + error.message + '</div>';
            }
        }
        
        // ========== Â§á‰ªΩÂíåÊÅ¢Â§çÂáΩÊï∞ ==========
        function backupData() {
            const data = {
                students: Array.from(system.students.values()),
                attendanceRecords: system.attendanceRecords,
                timeSlots: system.timeSlots,
                backupDate: new Date().toISOString()
            };
            
            const json = JSON.stringify(data, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `memoschool_backup_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showToast('Backup created successfully', 'success');
        }
        
        function restoreData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            
            input.onchange = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                if (!confirm('This will replace all current data. Continue?')) {
                    return;
                }
                
                showLoading('Restoring data...');
                
                try {
                    const text = await file.text();
                    const data = JSON.parse(text);
                    
                    // È™åËØÅÊï∞ÊçÆÊ†ºÂºè
                    if (!data.students || !data.attendanceRecords) {
                        throw new Error('Invalid backup file format');
                    }
                    
                    // ÊÅ¢Â§çÊï∞ÊçÆ
                    system.students.clear();
                    data.students.forEach(student => {
                        system.students.set(student.id, student);
                    });
                    
                    system.attendanceRecords = data.attendanceRecords || [];
                    system.timeSlots = data.timeSlots || [];
                    
                    // Êõ¥Êñ∞UI
                    updateUI();
                    
                    showToast('Data restored successfully', 'success');
                } catch (error) {
                    showToast('Error restoring data: ' + error.message, 'error');
                } finally {
                    hideLoading();
                }
            };
            
            input.click();
        }
        
        // ========== ÂØºÂá∫ÂáΩÊï∞ ==========
        function exportToCSV() {
            const csv = system.exportToCSV();
            downloadFile(csv, 'genius_mind_academy_attendance.csv', 'text/csv');
            showToast('CSV exported successfully!', 'success');
        }

        function exportToJSON() {
            const json = system.exportToJSON();
            downloadFile(json, 'genius_mind_academy_data.json', 'application/json');
            showToast('JSON exported successfully!', 'success');
        }

        function printReport() {
            window.print();
        }
        
        function downloadFile(content, fileName, contentType) {
            const blob = new Blob([content], { type: contentType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        // ========== PDFÁîüÊàêÂáΩÊï∞ ==========
        function generateStudentPDF(studentId) {
            const student = system.students.get(studentId);
            if (!student) {
                showToast('Student not found!', 'error');
                return;
            }
            
            // Ëé∑ÂèñÂá∫Âã§‰ø°ÊÅØ
            const attendanceInfo = system.getStudentAttendance(studentId);
            
            // ËÆ°ÁÆóÂâ©‰ΩôËØæÁ®ã
            const remainingSessions = student.totalSessions - attendanceInfo.attendanceCount;
            
            // Ê†ºÂºèÂåñÊó•Êúü
            const enrolledDate = system.formatDateForDisplay(student.enrolledDate);
            const today = new Date();
            const reportDate = `${today.getDate()}/${today.getMonth() + 1}/${today.getFullYear()}`;
            
            // ÂàõÂª∫PDF
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // ËÆæÁΩÆÊ†áÈ¢ò
            doc.setFontSize(24);
            doc.setTextColor(40, 40, 40);
            doc.text("Memoschool Kuching", 105, 20, null, null, 'center');
            
            // Ê∑ªÂä†ÂàÜÈöîÁ∫ø
            doc.setLineWidth(0.5);
            doc.line(20, 25, 190, 25);
            
            // Ê∑ªÂä†Êä•ÂëäÊ†áÈ¢ò
            doc.setFontSize(18);
            doc.setTextColor(230, 126, 34);
            doc.text("Student Attendance Report", 105, 35, null, null, 'center');
            
            // Â≠¶Áîü‰ø°ÊÅØÈÉ®ÂàÜ
            doc.setFontSize(12);
            doc.setTextColor(0, 0, 0);
            doc.setFont(undefined, 'bold');
            doc.text("Student Information:", 20, 50);
            doc.setFont(undefined, 'normal');
            
            // Â≠¶ÁîüËØ¶ÁªÜ‰ø°ÊÅØË°®Ê†º
            const studentData = [
                ["Name:", student.name],
                ["Age:", student.age || "N/A"],
                ["Gender:", student.gender || "N/A"],
                ["Time Slot:", student.timeSlot],
                ["Enrolled Date:", enrolledDate]
            ];
            
            studentData.forEach((row, index) => {
                doc.text(row[0], 25, 60 + (index * 7));
                doc.text(row[1], 70, 60 + (index * 7));
            });
            
            // Âá∫Âã§ÊëòË¶ÅÈÉ®ÂàÜ
            doc.setFont(undefined, 'bold');
            doc.text("Attendance Summary:", 20, 100);
            doc.setFont(undefined, 'normal');
            
            // Âá∫Âã§ËØ¶ÊÉÖË°®Ê†º
            const attendanceData = [
                ["Total Sessions:", student.totalSessions.toString()],
                ["Sessions Attended:", attendanceInfo.attendanceCount.toString()],
                ["Remaining Sessions:", remainingSessions.toString()]
            ];
            
            attendanceData.forEach((row, index) => {
                doc.text(row[0], 25, 110 + (index * 7));
                doc.text(row[1], 70, 110 + (index * 7));
            });
            
            // ‰øùÂ≠òPDF
            const fileName = `Memoschool_${student.name.replace(/\s+/g, '_')}_Attendance_Report.pdf`;
            doc.save(fileName);
            
            showToast(`PDF report downloaded for ${student.name}`, 'success');
        }
        
        function generateBatchPDFReport() {
            const selectedCheckboxes = document.querySelectorAll('.student-select-checkbox:checked');
            if (selectedCheckboxes.length === 0) {
                showToast('Please select at least one student first', 'error');
                return;
            }
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Set title
            doc.setFontSize(24);
            doc.setTextColor(40, 40, 40);
            doc.text("Memoschool Kuching", 105, 20, null, null, 'center');
            
            // Add line separator
            doc.setLineWidth(0.5);
            doc.line(20, 25, 190, 25);
            
            // Add report title
            doc.setFontSize(18);
            doc.setTextColor(230, 126, 34);
            doc.text("Batch Attendance Report", 105, 35, null, null, 'center');
            
            // Add report date
            const today = new Date();
            const reportDate = `${today.getDate()}/${today.getMonth() + 1}/${today.getFullYear()}`;
            doc.setFontSize(12);
            doc.setTextColor(100, 100, 100);
            doc.text(`Report Date: ${reportDate}`, 20, 45);
            doc.text(`Total Students: ${selectedCheckboxes.length}`, 150, 45);
            
            // Student table headers
            doc.setFontSize(12);
            doc.setTextColor(0, 0, 0);
            doc.setFont(undefined, 'bold');
            
            const headers = [
                { text: "No.", x: 20 },
                { text: "Name", x: 30 },
                { text: "Time Slot", x: 80 },
                { text: "Attended", x: 130 },
                { text: "Total", x: 160 },
                { text: "Remaining", x: 180 }
            ];
            
            headers.forEach(header => {
                doc.text(header.text, header.x, 55);
            });
            
            // Add line under headers
            doc.setLineWidth(0.2);
            doc.line(20, 57, 190, 57);
            
            // Student data rows
            doc.setFont(undefined, 'normal');
            let y = 65;
            let studentNumber = 1;
            
            selectedCheckboxes.forEach(checkbox => {
                const studentId = checkbox.value;
                const student = system.students.get(studentId);
                
                if (student) {
                    const attendanceInfo = system.getStudentAttendance(studentId);
                    const remainingSessions = student.totalSessions - attendanceInfo.attendanceCount;
                    
                    // Check if we need a new page
                    if (y > 270) {
                        doc.addPage();
                        y = 20;
                        
                        // Add headers on new page
                        doc.setFont(undefined, 'bold');
                        headers.forEach(header => {
                            doc.text(header.text, header.x, y);
                        });
                        doc.line(20, y + 2, 190, y + 2);
                        doc.setFont(undefined, 'normal');
                        y = 30;
                    }
                    
                    doc.text(studentNumber.toString(), 20, y);
                    doc.text(student.name, 30, y);
                    doc.text(student.timeSlot, 80, y);
                    doc.text(attendanceInfo.attendanceCount.toString(), 130, y);
                    doc.text(student.totalSessions.toString(), 160, y);
                    doc.text(remainingSessions.toString(), 180, y);
                    
                    studentNumber++;
                    y += 10;
                }
            });
            
            // Add footer
            doc.setFontSize(10);
            doc.setTextColor(100, 100, 100);
            const footerY = doc.internal.pageSize.height - 10;
            doc.text("Generated by Genius Mind Academy Attendance System", 105, footerY, null, null, 'center');
            
            // Save PDF
            const fileName = `Memoschool_Batch_Report_${reportDate.replace(/\//g, '_')}.pdf`;
            doc.save(fileName);
            
            showToast(`Batch PDF report downloaded for ${selectedCheckboxes.length} students`, 'success');
        }
        
        // ========== Âø´ÈÄüÂá∫Âã§ËÆ∞ÂΩïÂáΩÊï∞ ==========
        function quickRecordAttendance() {
            showSection('attendance');
            
            // Ëá™Âä®ÈÄâÊã©‰ªäÂ§©ÂíåÁ¨¨‰∏Ä‰∏™Êó∂Èó¥ÊßΩ
            const today = new Date();
            const todayStr = system.getLocalDateString(today);
            
            const dateInput = document.getElementById('classDate');
            const timeSlotSelect = document.getElementById('timeSlotSelect');
            
            if (dateInput) dateInput.value = todayStr;
            if (timeSlotSelect && timeSlotSelect.options.length > 1) {
                timeSlotSelect.selectedIndex = 1;
                updateStudentsCheckboxes();
            }
            
            // ÊªöÂä®Âà∞È°µÈù¢È°∂ÈÉ®
            window.scrollTo({ top: 0, behavior: 'smooth' });
            
            showToast('Quick attendance mode activated', 'info');
        }
        
        // ========== Êó∂Âå∫‰ø°ÊÅØÂáΩÊï∞ ==========
        function updateTimezoneInfo() {
            const timezoneOffset = new Date().getTimezoneOffset();
            const timezoneElement = document.getElementById('timezoneOffset');
            if (timezoneElement) {
                timezoneElement.textContent = timezoneOffset;
                
                // Ê∑ªÂä†Êó∂Âå∫ËØ¥Êòé
                const timezoneNote = timezoneOffset < 0 ? 
                    `(UTC+${Math.abs(timezoneOffset)/60})` : 
                    `(UTC-${timezoneOffset/60})`;
                
                timezoneElement.innerHTML += ` ${timezoneNote}`;
            }
        }
        
        // ========== ToastÈÄöÁü•ÂáΩÊï∞ ==========
        function showToast(message, type = 'success') {
            // ÁßªÈô§Áé∞Êúâtoast
            const existingToasts = document.querySelectorAll('.toast');
            existingToasts.forEach(toast => {
                toast.style.animation = 'slideInRight 0.3s ease reverse';
                setTimeout(() => toast.remove(), 300);
            });
            
            const icons = {
                success: 'fa-check-circle',
                error: 'fa-exclamation-circle',
                warning: 'fa-exclamation-triangle',
                info: 'fa-info-circle'
            };
            
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `
                <i class="fas ${icons[type] || 'fa-info-circle'}"></i>
                <span class="toast-message">${message}</span>
                <button class="btn" onclick="this.parentElement.remove()" style="padding: 4px; background: transparent; color: inherit;">
                    <i class="fas fa-times"></i>
                </button>
            `;
            
            document.body.appendChild(toast);
            
            // Ëá™Âä®ÁßªÈô§
            setTimeout(() => {
                if (toast.parentElement) {
                    toast.style.animation = 'slideInRight 0.3s ease reverse';
                    setTimeout(() => toast.remove(), 300);
                }
            }, 4000);
        }
        
        // ========== FirebaseËÆ§ËØÅÂáΩÊï∞ ==========
        async function login() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            if (!email || !password) {
                showToast('Please enter both email and password', 'error');
                return;
            }
            
            try {
                updateSyncStatus('üîÑ Signing in...', 'syncing');
                const userCredential = await auth.signInWithEmailAndPassword(email, password);
                showApp(userCredential.user);
                showToast('Login successful!', 'success');
            } catch (error) {
                console.error('Login error:', error);
                showToast('Login failed: ' + error.message, 'error');
                updateSyncStatus('‚ùå Login failed', 'error');
            }
        }

        async function signup() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            if (!email || !password) {
                showToast('Please enter both email and password', 'error');
                return;
            }
            
            if (password.length < 6) {
                showToast('Password should be at least 6 characters', 'error');
                return;
            }
            
            try {
                updateSyncStatus('üîÑ Creating account...', 'syncing');
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                showApp(userCredential.user);
                showToast('Account created successfully!', 'success');
            } catch (error) {
                console.error('Signup error:', error);
                showToast('Sign up failed: ' + error.message, 'error');
                updateSyncStatus('‚ùå Sign up failed', 'error');
            }
        }

        function logout() {
            auth.signOut();
            document.getElementById('loginSection').style.display = 'block';
            document.getElementById('appSection').style.display = 'none';
            updateSyncStatus('üîí Logged out', 'syncing');
            showToast('Logged out successfully', 'info');
        }

        function showApp(user) {
            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('appSection').style.display = 'block';
            document.getElementById('userEmail').textContent = user.email;
            
            // Initialize system with user ID
            system.initialize(user.uid);
            
            // Initialize enhanced features
            setTimeout(() => {
                initEnhancedFeatures();
                loadLastSection();
            }, 500);
        }

        // Test Mode: Skip login and enter system directly
        function skipLoginForTesting() {
            console.log("‚ö†Ô∏è Entering test mode (skip login)");
            
            // Mock user object
            const mockUser = {
                uid: 'test-user-' + Date.now(),
                email: 'test@example.com'
            };
            
            // Show main interface
            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('appSection').style.display = 'block';
            document.getElementById('userEmail').textContent = 'Test User (Offline Mode)';
            
            // Initialize system (offline mode)
            system.userId = mockUser.uid;
            system.isOnline = false;
            
            // Load default time slots
            system.timeSlots = DEFAULT_TIME_SLOTS.map(slot => ({
                id: slot.replace(/\s+/g, '-').toLowerCase(),
                name: slot,
                isDefault: true,
                createdAt: new Date().toISOString()
            }));
            
            // Clear existing data
            system.students.clear();
            system.attendanceRecords = [];
            
            // Add some test data
            addSampleData();
            
            // Initialize enhanced features
            setTimeout(() => {
                initEnhancedFeatures();
                loadLastSection();
            }, 500);
            
            // Update UI
            updateUI();
            updateSyncStatus('‚úÖ Entered test mode (offline)', 'synced');
            showToast('Entered test mode, all data saved locally only', 'info');
        }
        
        // Ê∑ªÂä†Á§∫‰æãÊï∞ÊçÆ
        function addSampleData() {
            // Add some sample students
            const sampleStudents = [
                { name: 'John Doe', age: 12, gender: 'Male', timeSlot: 'Friday 2pm-3:30pm' },
                { name: 'Jane Smith', age: 13, gender: 'Female', timeSlot: 'Saturday 9am-10:30am' },
                { name: 'Michael Brown', age: 11, gender: 'Male', timeSlot: 'Saturday 11am-12:30pm' },
                { name: 'Emily Johnson', age: 14, gender: 'Female', timeSlot: 'Sunday 9am-10:30am' }
            ];
            
            sampleStudents.forEach((student, index) => {
                const studentId = `${student.name.replace(/\s+/g, '')}-${Date.now() + index}`;
                const studentData = {
                    id: studentId,
                    name: student.name,
                    age: student.age,
                    gender: student.gender,
                    timeSlot: student.timeSlot,
                    enrolledDate: '2024-01-01',
                    totalSessions: 48,
                    attendanceCount: Math.floor(Math.random() * 30) + 10,
                    attendanceDates: generateSampleDates(30),
                    createdAt: new Date().toISOString()
                };
                system.students.set(studentId, studentData);
            });
            
            // Add sample attendance records
            const today = new Date();
            for (let i = 0; i < 5; i++) {
                const date = new Date(today);
                date.setDate(today.getDate() - i * 7); // Past few weeks
                
                const record = {
                    id: `record-${i}`,
                    timeSlot: DEFAULT_TIME_SLOTS[i % DEFAULT_TIME_SLOTS.length],
                    date: system.getLocalDateString(date),
                    topic: `Sample Class ${i + 1}`,
                    presentStudents: Array.from(system.students.keys()).slice(0, 3),
                    recordedAt: new Date().toISOString()
                };
                system.attendanceRecords.push(record);
            }
        }
        
        // ÁîüÊàêÁ§∫‰æãÂá∫Âã§Êó•Êúü
        function generateSampleDates(count) {
            const dates = [];
            const today = new Date();
            for (let i = 0; i < count; i++) {
                const date = new Date(today);
                date.setDate(today.getDate() - i * 2); // Every two days
                dates.push(system.getLocalDateString(date));
            }
            return dates;
        }
        
        // Âä†ËΩΩÊúÄÂêéËÆøÈóÆÁöÑÂå∫Âüü
        function loadLastSection() {
            const lastSection = localStorage.getItem('gma_lastSection');
            const defaultSection = localStorage.getItem('gma_defaultView') || 'dashboard';
            
            if (lastSection && document.getElementById(lastSection)) {
                showSection(lastSection);
            } else if (defaultSection && document.getElementById(defaultSection)) {
                showSection(defaultSection);
            }
        }
        
        // ========== È°µÈù¢Âä†ËΩΩÂàùÂßãÂåñ ==========
        window.onload = function() {
            init();
            
            // ÁõëÂê¨ËÆ§ËØÅÁä∂ÊÄÅÂèòÂåñ
            auth.onAuthStateChanged((user) => {
                if (user) {
                    showApp(user);
                } else {
                    document.getElementById('loginSection').style.display = 'block';
                    document.getElementById('appSection').style.display = 'none';
                }
            });
            
            // Âª∂ËøüÂä†ËΩΩÈùûÂÖ≥ÈîÆËµÑÊ∫ê
            setTimeout(() => {
                document.body.classList.add('loaded');
            }, 100);
            
            // Ê£ÄÊü•Âπ∂‰øÆÂ§çÊï∞ÊçÆ‰∏ÄËá¥ÊÄß
            setTimeout(() => {
                if (system.isOnline) {
                    console.log('Running initial data consistency check...');
                    system.fixDuplicateAttendance().then(fixedCount => {
                        if (fixedCount > 0) {
                            console.log(`Automatically fixed ${fixedCount} duplicate attendance records`);
                        }
                    });
                }
            }, 3000);
            
            // ÊòæÁ§∫FABÊåâÈíÆ
            const fab = document.getElementById('fabButton');
            if (fab) {
                fab.style.display = 'flex';
            }
        };
    </script>
</body>
</html>
